{
  CapturingPrintStream stdout=new CapturingPrintStream();
  CapturingPrintStream stderr=new CapturingPrintStream();
  ExecutionContext firstOrderContext=context.createSubContext(stdout,stderr);
  int declaredDepsResult=buildWithClasspath(firstOrderContext,ImmutableSet.copyOf(declaredClasspathEntries));
  String firstOrderStdout=stdout.getContentsAsString(Charsets.UTF_8);
  String firstOrderStderr=stderr.getContentsAsString(Charsets.UTF_8);
  if (declaredDepsResult != 0) {
    int transitiveResult=buildWithClasspath(context,ImmutableSet.copyOf(transitiveClasspathEntries));
    if (transitiveResult == 0) {
      ImmutableSet<String> failedImports=findFailedImports(firstOrderStderr);
      ImmutableList.Builder<String> errorMessage=ImmutableList.builder();
      errorMessage.add(String.format("Rule %s builds with its transitive " + "dependencies but not with its first order dependencies.",invokingRule.or("")));
      errorMessage.add("The following packages were missing:");
      errorMessage.add(Joiner.on(LINE_SEPARATOR).join(failedImports));
      if (suggestBuildRules.isPresent()) {
        errorMessage.add("Try adding the following deps:");
        errorMessage.add(Joiner.on(LINE_SEPARATOR).join(suggestBuildRules.get().suggest(context.getProjectFilesystem(),failedImports)));
      }
      errorMessage.add("");
      errorMessage.add("");
      context.getStdErr().println(Joiner.on("\n").join(errorMessage.build()));
    }
    return transitiveResult;
  }
 else {
    context.getStdOut().print(firstOrderStdout);
    context.getStdErr().print(firstOrderStderr);
  }
  return declaredDepsResult;
}

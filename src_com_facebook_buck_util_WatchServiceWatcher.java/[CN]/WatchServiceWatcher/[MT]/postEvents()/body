{
  WatchKey key;
  while ((key=watchService.poll()) != null) {
    Path dir=keys.get(key);
    if (dir == null) {
      continue;
    }
    for (    final WatchEvent<?> event : key.pollEvents()) {
      if (filesystem.isPathChangeEvent(event)) {
        Path name=(Path)event.context();
        Path absolutePath=dir.resolve(name);
        final Path projectRelativePath=filesystem.getRootPath().relativize(absolutePath);
        if (filesystem.isIgnored(projectRelativePath)) {
          continue;
        }
        if (filesystem.isDirectory(absolutePath,LinkOption.NOFOLLOW_LINKS)) {
          if (event.kind() == StandardWatchEventKinds.ENTRY_CREATE) {
            registerAll(absolutePath);
          }
          continue;
        }
        eventBus.post(new WatchEvent<Path>(){
          @Override @SuppressWarnings("unchecked") public Kind<Path> kind(){
            return (Kind<Path>)event.kind();
          }
          @Override public int count(){
            return event.count();
          }
          @Override public Path context(){
            return projectRelativePath;
          }
        }
);
      }
 else {
        eventBus.post(event);
      }
    }
    if (!key.reset()) {
      keys.remove(key);
    }
  }
}

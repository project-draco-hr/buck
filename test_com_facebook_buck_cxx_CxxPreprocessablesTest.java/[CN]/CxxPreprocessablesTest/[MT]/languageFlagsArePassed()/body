{
  BuildRuleResolver buildRuleResolver=new BuildRuleResolver();
  SourcePathResolver pathResolver=new SourcePathResolver(buildRuleResolver);
  BuildTarget target=BuildTargetFactory.newInstance("//:target");
  BuildRuleParams params=BuildRuleParamsFactory.createTrivialBuildRuleParams(target);
  String name="foo/bar.cpp";
  SourcePath input=new PathSourcePath(PROJECT_FILESYSTEM,target.getBasePath().resolve(name));
  CxxSource cxxSource=ImmutableCxxSource.of(CxxSource.Type.CXX,input,ImmutableList.<String>of());
  Map.Entry<String,CxxSource> cxxPreprocessEntry=CxxPreprocessables.createPreprocessBuildRule(params,buildRuleResolver,CXX_PLATFORM,CxxPreprocessorInput.EMPTY,false,name,cxxSource);
  CxxPreprocess cxxPreprocess=(CxxPreprocess)pathResolver.getRule(cxxPreprocessEntry.getValue().getPath()).get();
  assertThat(cxxPreprocess.getFlags(),Matchers.contains("-x","c++"));
  name="foo/bar.m";
  input=new PathSourcePath(PROJECT_FILESYSTEM,target.getBasePath().resolve(name));
  cxxSource=ImmutableCxxSource.of(CxxSource.Type.OBJC,input,ImmutableList.<String>of());
  cxxPreprocessEntry=CxxPreprocessables.createPreprocessBuildRule(params,buildRuleResolver,CXX_PLATFORM,CxxPreprocessorInput.EMPTY,false,name,cxxSource);
  cxxPreprocess=(CxxPreprocess)pathResolver.getRule(cxxPreprocessEntry.getValue().getPath()).get();
  assertThat(cxxPreprocess.getFlags(),Matchers.contains("-x","objective-c"));
  name="foo/bar.mm";
  input=new PathSourcePath(PROJECT_FILESYSTEM,target.getBasePath().resolve(name));
  cxxSource=ImmutableCxxSource.of(CxxSource.Type.OBJCXX,input,ImmutableList.<String>of());
  cxxPreprocessEntry=CxxPreprocessables.createPreprocessBuildRule(params,buildRuleResolver,CXX_PLATFORM,CxxPreprocessorInput.EMPTY,false,name,cxxSource);
  cxxPreprocess=(CxxPreprocess)pathResolver.getRule(cxxPreprocessEntry.getValue().getPath()).get();
  assertThat(cxxPreprocess.getFlags(),Matchers.contains("-x","objective-c++"));
  name="foo/bar.c";
  input=new PathSourcePath(PROJECT_FILESYSTEM,target.getBasePath().resolve(name));
  cxxSource=ImmutableCxxSource.of(CxxSource.Type.C,input,ImmutableList.<String>of());
  cxxPreprocessEntry=CxxPreprocessables.createPreprocessBuildRule(params,buildRuleResolver,CXX_PLATFORM,CxxPreprocessorInput.EMPTY,false,name,cxxSource);
  cxxPreprocess=(CxxPreprocess)pathResolver.getRule(cxxPreprocessEntry.getValue().getPath()).get();
  assertThat(cxxPreprocess.getFlags(),Matchers.contains("-x","c"));
}

{
  ClasspathTraverser classpathTraverser=new DefaultClasspathTraverser();
  primaryOut=newZipOutput(outPrimary);
  classpathTraverser.traverse(new ClasspathTraversal(inFiles){
    @Override public void visit(    FileLike entry) throws IOException {
      if (requiredInPrimaryZip.apply(entry.getRelativePath())) {
        primaryOut.putEntry(entry);
      }
    }
  }
);
  classpathTraverser.traverse(new ClasspathTraversal(inFiles){
    @Override public void visit(    FileLike entry) throws IOException {
      if (primaryOut.containsEntry(entry)) {
        return;
      }
      if (primaryOut.canPutEntry(entry)) {
        primaryOut.putEntry(entry);
      }
 else {
        getSecondaryZipToWriteTo(entry).putEntry(entry);
      }
    }
  }
);
  primaryOut.close();
  if (currentSecondaryOut != null) {
    currentSecondaryOut.close();
  }
  return secondaryFiles.build();
}

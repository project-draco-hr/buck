{
  Process watchmanProcess=watchmanProcessSupplier.get();
  try {
    LOG.debug("Writing query to Watchman: %s",query);
    watchmanProcess.getOutputStream().write(query.getBytes(Charsets.US_ASCII));
    watchmanProcess.getOutputStream().close();
    LOG.debug("Parsing JSON output from Watchman");
    JsonParser jsonParser=jsonFactory.createJsonParser(watchmanProcess.getInputStream());
    PathEventBuilder builder=new PathEventBuilder();
    JsonToken token=jsonParser.nextToken();
    int eventCount=0;
    while (token != null) {
      if (eventCount > overflow) {
        eventBus.post(createOverflowEvent());
        watchmanProcess.destroy();
        return;
      }
switch (token) {
case FIELD_NAME:
        String fieldName=jsonParser.getCurrentName();
switch (fieldName) {
case "name":
        File file=new File(jsonParser.nextTextValue());
      if (!file.isDirectory()) {
        builder.setPath(file.toPath());
      }
    break;
case "new":
  if (jsonParser.nextBooleanValue()) {
    builder.setCreationEvent();
  }
break;
case "exists":
if (!jsonParser.nextBooleanValue()) {
builder.setDeletionEvent();
}
break;
case "error":
WatchmanWatcherException e=new WatchmanWatcherException(jsonParser.nextTextValue());
LOG.error(e,"Error in Watchman output");
throw e;
}
break;
case END_OBJECT:
if (builder.canBuild()) {
eventBus.post(builder.build());
++eventCount;
}
builder=new PathEventBuilder();
break;
default :
break;
}
token=jsonParser.nextToken();
}
int watchmanExitCode;
LOG.debug("Posted %d Watchman events. Waiting for subprocess to exit...",eventCount);
watchmanExitCode=watchmanProcess.waitFor();
if (watchmanExitCode != 0) {
LOG.error("Watchman exited with error code %d",watchmanExitCode);
eventBus.post(createOverflowEvent());
ByteArrayOutputStream buffer=new ByteArrayOutputStream();
ByteStreams.copy(watchmanProcess.getErrorStream(),buffer);
throw new WatchmanWatcherException("Watchman failed with exit code " + watchmanExitCode + ": "+ buffer.toString());
}
 else {
LOG.debug("Watchman exited cleanly.");
}
}
 catch (InterruptedException e) {
LOG.warn(e,"Killing Watchman process on interrupted exception");
eventBus.post(createOverflowEvent());
watchmanProcess.destroy();
Thread.currentThread().interrupt();
throw e;
}
catch (IOException e) {
LOG.error(e,"Killing Watchman process on I/O exception");
eventBus.post(createOverflowEvent());
watchmanProcess.destroy();
throw e;
}
}

{
  final ImmutableMap<BuildTarget,IjModule> rulesToModules=createModules(targetGraph,moduleFactory);
  final ExportedDepsClosureResolver exportedDepsClosureResolver=new ExportedDepsClosureResolver(targetGraph);
  ImmutableMap.Builder<IjProjectElement,ImmutableMap<IjProjectElement,DependencyType>> depsBuilder=ImmutableMap.builder();
  final Set<IjLibrary> referencedLibraries=new HashSet<>();
  for (  IjModule module : FluentIterable.from(rulesToModules.values()).toSet()) {
    Map<IjProjectElement,DependencyType> moduleDeps=new HashMap<>();
    for (    Map.Entry<BuildTarget,DependencyType> entry : module.getDependencies().entrySet()) {
      BuildTarget depBuildTarget=entry.getKey();
      DependencyType depType=entry.getValue();
      ImmutableSet<IjProjectElement> depElements;
      if (depType.equals(DependencyType.COMPILED_SHADOW)) {
        TargetNode<?> targetNode=Preconditions.checkNotNull(targetGraph.get(depBuildTarget));
        Optional<IjLibrary> library=libraryFactory.getLibrary(targetNode);
        if (library.isPresent()) {
          referencedLibraries.add(library.get());
          depElements=ImmutableSet.<IjProjectElement>of(library.get());
        }
 else {
          depElements=ImmutableSet.of();
        }
      }
 else {
        depElements=FluentIterable.from(exportedDepsClosureResolver.getExportedDepsClosure(depBuildTarget)).append(depBuildTarget).transform(new Function<BuildTarget,IjProjectElement>(){
          @Nullable @Override public IjProjectElement apply(          BuildTarget depTarget){
            IjModule depModule=rulesToModules.get(depTarget);
            if (depModule != null) {
              return depModule;
            }
            TargetNode<?> targetNode=Preconditions.checkNotNull(targetGraph.get(depTarget));
            IjLibrary library=libraryFactory.getLibrary(targetNode).orNull();
            if (library != null) {
              referencedLibraries.add(library);
            }
            return library;
          }
        }
).filter(Predicates.notNull()).toSet();
      }
      for (      IjProjectElement depElement : depElements) {
        Preconditions.checkState(!depElement.equals(module));
        DependencyType.putWithMerge(moduleDeps,depElement,depType);
      }
    }
    depsBuilder.put(module,ImmutableMap.copyOf(moduleDeps));
  }
  for (  IjLibrary library : referencedLibraries) {
    depsBuilder.put(library,ImmutableMap.<IjProjectElement,DependencyType>of());
  }
  return new IjModuleGraph(depsBuilder.build());
}

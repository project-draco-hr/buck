{
  Map<BuildTarget,XCScheme.BuildableReference> buildTargetToBuildableReferenceMap=Maps.newHashMap();
  for (  BuildTarget buildTarget : Iterables.concat(orderedBuildTargets,orderedTestBuildTargets)) {
    PBXTarget target=Preconditions.checkNotNull(buildTargetToPbxTargetMap.get(buildTarget));
    String blueprintName=target.getProductName();
    if (blueprintName == null) {
      blueprintName=target.getName();
    }
    XCScheme.BuildableReference buildableReference=new XCScheme.BuildableReference(outputDirectory.getParent().relativize(targetToProjectPathMap.get(target)).toString(),target.getGlobalID(),Preconditions.checkNotNull(target.getProductReference()).getName(),blueprintName);
    buildTargetToBuildableReferenceMap.put(buildTarget,buildableReference);
  }
  XCScheme.BuildAction buildAction=new XCScheme.BuildAction();
  for (  BuildTarget buildTarget : orderedBuildTargets) {
    addBuildActionForBuildTarget(buildTargetToBuildableReferenceMap.get(buildTarget),XCScheme.BuildActionEntry.BuildFor.DEFAULT,buildAction);
  }
  for (  BuildTarget buildTarget : orderedTestBuildTargets) {
    addBuildActionForBuildTarget(buildTargetToBuildableReferenceMap.get(buildTarget),XCScheme.BuildActionEntry.BuildFor.TEST_ONLY,buildAction);
  }
  XCScheme.TestAction testAction=new XCScheme.TestAction(actionConfigNames.get(SchemeActionType.TEST));
  for (  BuildTarget buildTarget : orderedTestBundleTargets) {
    XCScheme.BuildableReference buildableReference=buildTargetToBuildableReferenceMap.get(buildTarget);
    XCScheme.TestableReference testableReference=new XCScheme.TestableReference(buildableReference);
    testAction.addTestableReference(testableReference);
  }
  Optional<XCScheme.LaunchAction> launchAction=Optional.absent();
  Optional<XCScheme.ProfileAction> profileAction=Optional.absent();
  if (primaryTarget.isPresent()) {
    XCScheme.BuildableReference primaryBuildableReference=buildTargetToBuildableReferenceMap.get(primaryTarget.get());
    if (primaryBuildableReference != null) {
      launchAction=Optional.of(new XCScheme.LaunchAction(primaryBuildableReference,actionConfigNames.get(SchemeActionType.LAUNCH)));
      profileAction=Optional.of(new XCScheme.ProfileAction(primaryBuildableReference,actionConfigNames.get(SchemeActionType.PROFILE)));
    }
  }
  XCScheme.AnalyzeAction analyzeAction=new XCScheme.AnalyzeAction(actionConfigNames.get(SchemeActionType.ANALYZE));
  XCScheme.ArchiveAction archiveAction=new XCScheme.ArchiveAction(actionConfigNames.get(SchemeActionType.ARCHIVE));
  XCScheme scheme=new XCScheme(schemeName,Optional.of(buildAction),Optional.of(testAction),launchAction,profileAction,Optional.of(analyzeAction),Optional.of(archiveAction));
  Path schemeDirectory=outputDirectory.resolve("xcshareddata/xcschemes");
  projectFilesystem.mkdirs(schemeDirectory);
  Path schemePath=schemeDirectory.resolve(schemeName + ".xcscheme");
  try (ByteArrayOutputStream outputStream=new ByteArrayOutputStream()){
    serializeScheme(scheme,outputStream);
    String contentsToWrite=outputStream.toString();
    if (MorePaths.fileContentsDiffer(new ByteArrayInputStream(contentsToWrite.getBytes(Charsets.UTF_8)),schemePath,projectFilesystem)) {
      projectFilesystem.writeContentsToPath(outputStream.toString(),schemePath);
    }
  }
   return schemePath;
}

{
  String data="test";
  HashCode hashCode=HASH_FUNCTION.hashString(data,Charset.defaultCharset());
  expect(connection.getResponseCode()).andReturn(HttpURLConnection.HTTP_OK);
  InputStream is=new ByteArrayInputStream(createFileContentsWithHashCode(hashCode,data));
  expect(connection.getInputStream()).andReturn(is);
  File file=File.createTempFile("000","");
  Path path=file.toPath();
  Path temp=File.createTempFile("000","").toPath();
  Files.write(temp,data.getBytes(),StandardOpenOption.WRITE);
  projectFilesystem.createParentDirs(path);
  expect(projectFilesystem.createTempFile(path.getParent(),path.getFileName().toString(),".tmp")).andReturn(temp);
  projectFilesystem.copyToPath(is,temp,StandardCopyOption.REPLACE_EXISTING);
  projectFilesystem.move(temp,path,StandardCopyOption.REPLACE_EXISTING);
  replay(connection);
  replay(projectFilesystem);
  assertEquals(cache.fetch(new RuleKey("00000000000000000000000000000000"),file),CacheResult.HTTP_HIT);
  verify(connection);
  verify(projectFilesystem);
}

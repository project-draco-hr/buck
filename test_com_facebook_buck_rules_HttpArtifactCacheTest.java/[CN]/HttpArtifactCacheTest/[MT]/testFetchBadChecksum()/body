{
  String data="test";
  HashCode badHashCode=HashCode.fromString("deafbead");
  expect(connection.getResponseCode()).andReturn(HttpURLConnection.HTTP_OK);
  InputStream is=new ByteArrayInputStream(createFileContentsWithHashCode(badHashCode,data));
  expect(connection.getInputStream()).andReturn(is);
  File file=File.createTempFile("000","");
  Path path=file.toPath();
  Path temp=File.createTempFile("000","").toPath();
  Files.write(temp,data.getBytes(),StandardOpenOption.WRITE);
  projectFilesystem.createParentDirs(path);
  expect(projectFilesystem.createTempFile(path.getParent(),path.getFileName().toString(),".tmp")).andReturn(temp);
  projectFilesystem.copyToPath(is,temp,StandardCopyOption.REPLACE_EXISTING);
  expect(projectFilesystem.deleteFileAtPath(temp)).andReturn(true);
  replay(connection);
  replay(projectFilesystem);
  assertEquals(cache.fetch(new RuleKey("00000000000000000000000000000000"),file),CacheResult.MISS);
  verify(connection);
  verify(projectFilesystem);
}

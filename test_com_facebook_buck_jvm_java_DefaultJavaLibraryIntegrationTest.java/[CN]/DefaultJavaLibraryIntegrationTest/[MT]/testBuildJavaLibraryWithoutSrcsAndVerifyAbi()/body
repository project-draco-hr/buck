{
  workspace=TestDataHelper.createProjectWorkspaceForScenario(this,"abi",tmp);
  workspace.setUp();
  workspace.enableDirCache();
  BuildTarget target=BuildTargetFactory.newInstance("//:no_srcs");
  ProcessResult buildResult=workspace.runBuckCommand("build",target.getFullyQualifiedName());
  buildResult.assertSuccess("Successful build should exit with 0.");
  Path outputPath=BuildTargets.getGenPath(filesystem,target,"lib__%s__output/" + target.getShortName() + ".jar");
  Path outputFile=workspace.getPath(outputPath);
  assertTrue(Files.exists(outputFile));
  long sizeOfOriginalJar=Files.size(outputFile);
  workspace.verify();
  Path buildCache=workspace.getPath(BuckConstant.getDefaultCacheDir());
  assertTrue(Files.isDirectory(buildCache));
  ArtifactCache dirCache=TestArtifactCaches.createDirCacheForTest(workspace.getDestPath(),buildCache);
  int totalArtifactsCount=DirArtifactCacheTestUtil.getAllFilesInCache(dirCache).size();
  assertEquals("There should be two entries (a zip and metadata) in the build cache.",2,totalArtifactsCount);
  ProcessResult cleanResult=workspace.runBuckCommand("clean");
  cleanResult.assertSuccess("Successful clean should exit with 0.");
  totalArtifactsCount=getAllFilesInPath(buildCache).size();
  assertEquals("The build cache should still exist.",2,totalArtifactsCount);
  File artifactZip=FluentIterable.from(ImmutableList.copyOf(DirArtifactCacheTestUtil.getAllFilesInCache(dirCache))).toSortedList(Ordering.natural()).get(0).toFile();
  FileSystem zipFs=FileSystems.newFileSystem(artifactZip.toPath(),null);
  Path outputInZip=zipFs.getPath("/" + outputPath.toString());
  Files.write(outputInZip,"Hello world!".getBytes(),WRITE);
  zipFs.close();
  ProcessResult buildResult2=workspace.runBuckCommand("build",target.getFullyQualifiedName());
  buildResult2.assertSuccess("Successful build should exit with 0.");
  assertTrue(Files.isRegularFile(outputFile));
  assertEquals("The content of the output file will be 'Hello World!' if it is read from the build cache.","Hello world!",new String(Files.readAllBytes(outputFile),UTF_8));
  ProcessResult cleanResult2=workspace.runBuckCommand("clean");
  cleanResult2.assertSuccess("Successful clean should exit with 0.");
  ProcessResult buildResult3=workspace.runBuckCommand("build","--no-cache",target.getFullyQualifiedName());
  buildResult3.assertSuccess();
  assertNotEquals("The contents of the file should no longer be pulled from the corrupted build cache.","Hello world!",new String(Files.readAllBytes(outputFile),UTF_8));
  assertEquals("We cannot do a byte-for-byte comparision with the original JAR because timestamps might " + "have changed, but we verify that they are the same size, as a proxy.",sizeOfOriginalJar,Files.size(outputFile));
}

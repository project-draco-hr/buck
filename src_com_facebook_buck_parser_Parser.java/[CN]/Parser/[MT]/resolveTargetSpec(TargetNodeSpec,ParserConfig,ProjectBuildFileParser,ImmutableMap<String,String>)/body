{
  ImmutableSet.Builder<BuildTarget> targets=ImmutableSet.builder();
  for (  Path buildFile : spec.getBuildFileSpec().findBuildFiles(repository.getFilesystem(),parserConfig.getBuildFileName())) {
    if (!repository.getFilesystem().isFile(buildFile)) {
      throw new MissingBuildFileException(spec,buildFile);
    }
    List<Map<String,Object>> parsed=parseBuildFile(repository.getFilesystem().resolve(buildFile),parserConfig,buildFileParser,environment);
    List<TargetNode<?>> nodes=Lists.newArrayListWithCapacity(parsed.size());
    for (    Map<String,Object> map : parsed) {
      BuildTarget target=parseBuildTargetFromRawRule(map);
      TargetNode<?> node=getTargetNode(target);
      nodes.add(node);
    }
    targets.addAll(spec.filter(nodes));
  }
  return targets.build();
}

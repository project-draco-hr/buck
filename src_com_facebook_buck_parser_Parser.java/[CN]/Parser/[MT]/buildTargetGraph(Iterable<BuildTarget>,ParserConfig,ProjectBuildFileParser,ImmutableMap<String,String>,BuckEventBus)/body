{
  final MutableDirectedGraph<TargetNode<?>> graph=new MutableDirectedGraph<>();
  final Map<BuildTarget,TargetNode<?>> index=new HashMap<>();
  final Optional<BuckEventBus> eventBusOptional=Optional.of(eventBus);
  AbstractAcyclicDepthFirstPostOrderTraversal<BuildTarget> traversal=new AbstractAcyclicDepthFirstPostOrderTraversal<BuildTarget>(){
    @Override protected Iterator<BuildTarget> findChildren(    BuildTarget buildTarget) throws IOException, InterruptedException {
      try (SimplePerfEvent.Scope getTargetDepsEventScope=SimplePerfEvent.scope(eventBus,PerfEventId.of("GetTargetDeps"),"target",buildTarget)){
        BuildTargetPatternParser<BuildTargetPattern> buildTargetPatternParser=BuildTargetPatternParser.forBaseName(buildTarget.getBaseName());
        TargetNode<?> targetNode;
        try (SimplePerfEvent.Scope scope=getTargetNodeEventScope(eventBus,buildTarget)){
          targetNode=state.get(buildTarget,eventBusOptional);
        }
         if (targetNode == null) {
          throw new HumanReadableException(NoSuchBuildTargetException.createForMissingBuildRule(buildTarget,buildTargetPatternParser,parserConfig.getBuildFileName(),getDefinedFilepathMessage(buildTarget)));
        }
        Set<BuildTarget> deps=Sets.newHashSet();
        for (        BuildTarget buildTargetForDep : targetNode.getDeps()) {
          try {
            TargetNode<?> depTargetNode;
            try (SimplePerfEvent.Scope scope=getTargetNodeEventScope(eventBus,buildTargetForDep)){
              depTargetNode=state.get(buildTargetForDep,eventBusOptional);
            }
             if (depTargetNode == null) {
              parseBuildFileContainingTarget(buildTargetForDep,parserConfig,buildFileParser,environment);
              try (SimplePerfEvent.Scope scope=getTargetNodeEventScope(eventBus,buildTargetForDep)){
                depTargetNode=state.get(buildTargetForDep,eventBusOptional);
              }
               if (depTargetNode == null) {
                throw new HumanReadableException(NoSuchBuildTargetException.createForMissingBuildRule(buildTargetForDep,BuildTargetPatternParser.forBaseName(buildTargetForDep.getBaseName()),parserConfig.getBuildFileName(),getDefinedFilepathMessage(buildTarget)));
              }
            }
            depTargetNode.checkVisibility(buildTarget);
            deps.add(buildTargetForDep);
          }
 catch (          HumanReadableException|BuildTargetException|BuildFileParseException e) {
            throw new HumanReadableException(e,"Couldn't get dependency '%s' of target '%s':\n%s",buildTargetForDep,buildTarget,e.getHumanReadableErrorMessage());
          }
        }
        return deps.iterator();
      }
     }
    @Override protected void onNodeExplored(    BuildTarget buildTarget) throws IOException, InterruptedException {
      TargetNode<?> targetNode=getTargetNode(buildTarget);
      Preconditions.checkNotNull(targetNode,"No target node found for %s",buildTarget);
      graph.addNode(targetNode);
      MoreMaps.putCheckEquals(index,targetNode.getBuildTarget(),targetNode);
      if (targetNode.getBuildTarget().isFlavored()) {
        BuildTarget unflavoredBuildTarget=BuildTarget.of(targetNode.getBuildTarget().getUnflavoredBuildTarget());
        MoreMaps.putCheckEquals(index,unflavoredBuildTarget,getTargetNode(unflavoredBuildTarget));
      }
      for (      BuildTarget target : targetNode.getDeps()) {
        graph.addEdge(targetNode,Preconditions.checkNotNull(getTargetNode(target)));
      }
    }
    @Override protected void onTraversalComplete(    Iterable<BuildTarget> nodesInExplorationOrder){
    }
  }
;
  try {
    traversal.traverse(toExplore);
  }
 catch (  AbstractAcyclicDepthFirstPostOrderTraversal.CycleException e) {
    throw new HumanReadableException(e.getMessage());
  }
  return new TargetGraph(graph,ImmutableMap.copyOf(index));
}

{
  BuildRuleResolver ruleResolver=new BuildRuleResolver();
  createSampleAndroidBinaryRule(ruleResolver);
  Map<String,?> instance=new ImmutableMap.Builder<String,Object>().put("name","fb4a_signed").put("srcs",ImmutableList.<String>of("signer.py","key.properties")).put("cmd","python signer.py $APK key.properties > $OUT").put("apk",":fb4a").put("out","signed_fb4a.apk").put("deps",ImmutableList.<Object>of()).build();
  BuildTargetParser parser=EasyMock.createNiceMock(BuildTargetParser.class);
  EasyMock.expect(parser.parse(EasyMock.eq(":fb4a"),EasyMock.anyObject(ParseContext.class))).andStubReturn(BuildTargetFactory.newInstance("//:fb4a"));
  EasyMock.replay(parser);
  BuildTarget buildTarget=BuildTargetFactory.newInstance("//src/com/facebook","sign_fb4a");
  BuildRuleFactoryParams params=NonCheckingBuildRuleFactoryParams.createNonCheckingBuildRuleFactoryParams(instance,parser,buildTarget);
  ApkGenruleBuildRuleFactory factory=new ApkGenruleBuildRuleFactory();
  ApkGenrule.Builder builder=factory.newInstance(params);
  builder.setRelativeToAbsolutePathFunctionForTesting(relativeToAbsolutePathFunction);
  ApkGenrule apkGenrule=(ApkGenrule)ruleResolver.buildAndAddToIndex(builder);
  String expectedApkOutput="/opt/local/fbandroid/" + GEN_DIR + "/src/com/facebook/sign_fb4a.apk";
  assertEquals(BuildRuleType.APK_GENRULE,apkGenrule.getType());
  assertEquals(expectedApkOutput,apkGenrule.getAbsoluteOutputFilePath());
  BuildContext buildContext=BuildContext.builder().setProjectRoot(EasyMock.createNiceMock(File.class)).setDependencyGraph(EasyMock.createMock(DependencyGraph.class)).setStepRunner(EasyMock.createNiceMock(StepRunner.class)).setProjectFilesystem(EasyMock.createNiceMock(ProjectFilesystem.class)).setArtifactCache(EasyMock.createMock(ArtifactCache.class)).setJavaPackageFinder(EasyMock.createNiceMock(JavaPackageFinder.class)).setEventBus(new BuckEventBus()).build();
  ImmutableSortedSet<String> inputsToCompareToOutputs=ImmutableSortedSet.of("src/com/facebook/key.properties","src/com/facebook/signer.py");
  assertEquals(inputsToCompareToOutputs,apkGenrule.getInputsToCompareToOutput());
  List<Step> steps=apkGenrule.buildInternal(buildContext);
  assertEquals(7,steps.size());
  Step firstStep=steps.get(0);
  assertTrue(firstStep instanceof ShellStep);
  ShellStep rmCommand=(ShellStep)firstStep;
  ExecutionContext executionContext=newEmptyExecutionContext();
  assertEquals("First command should delete the output file to be written by the genrule.",ImmutableList.of("rm","-f",apkGenrule.getPathToOutputFile()),rmCommand.getShellCommand(executionContext));
  Step secondStep=steps.get(1);
  assertTrue(secondStep instanceof MkdirStep);
  MkdirStep mkdirCommand=(MkdirStep)secondStep;
  assertEquals("Second command should make sure the output directory exists.",ImmutableList.of("mkdir","-p",GEN_DIR + "/src/com/facebook/"),mkdirCommand.getShellCommand(executionContext));
  Step thirdStep=steps.get(2);
  assertTrue(thirdStep instanceof MakeCleanDirectoryStep);
  MakeCleanDirectoryStep secondMkdirCommand=(MakeCleanDirectoryStep)thirdStep;
  String relativePathToTmpDir=GEN_DIR + "/src/com/facebook/sign_fb4a__tmp";
  assertEquals("Third command should make sure the temp directory exists.",relativePathToTmpDir,secondMkdirCommand.getPath());
  Step fourthStep=steps.get(3);
  assertTrue(fourthStep instanceof MakeCleanDirectoryStep);
  MakeCleanDirectoryStep thirdMkdirCommand=(MakeCleanDirectoryStep)fourthStep;
  String relativePathToSrcDir=GEN_DIR + "/src/com/facebook/sign_fb4a__srcs";
  assertEquals("Fourth command should make sure the temp directory exists.",relativePathToSrcDir,thirdMkdirCommand.getPath());
  MkdirAndSymlinkFileStep linkSource1=(MkdirAndSymlinkFileStep)steps.get(4);
  assertEquals("src/com/facebook/signer.py",linkSource1.getSource());
  assertEquals(relativePathToSrcDir + "/signer.py",linkSource1.getTarget());
  MkdirAndSymlinkFileStep linkSource2=(MkdirAndSymlinkFileStep)steps.get(5);
  assertEquals("src/com/facebook/key.properties",linkSource2.getSource());
  assertEquals(relativePathToSrcDir + "/key.properties",linkSource2.getTarget());
  Step seventhStep=steps.get(6);
  assertTrue(seventhStep instanceof ShellStep);
  ShellStep genruleCommand=(ShellStep)seventhStep;
  assertEquals("genrule",genruleCommand.getShortName());
  assertEquals(new ImmutableMap.Builder<String,String>().put("SRCS","/opt/local/fbandroid/src/com/facebook/signer.py " + "/opt/local/fbandroid/src/com/facebook/key.properties").put("APK",GEN_DIR + "/fb4a.apk").put("DEPS","").put("TMP","/opt/local/fbandroid/" + relativePathToTmpDir).put("SRCDIR","/opt/local/fbandroid/" + relativePathToSrcDir).put("OUT",expectedApkOutput).build(),genruleCommand.getEnvironmentVariables(executionContext));
  assertEquals(ImmutableList.of("/bin/bash","-c","python signer.py $APK key.properties > $OUT"),genruleCommand.getShellCommand(executionContext));
  EasyMock.verify(parser);
}

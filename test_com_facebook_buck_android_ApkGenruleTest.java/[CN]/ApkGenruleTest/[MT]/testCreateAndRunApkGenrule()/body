{
  BuildRuleResolver ruleResolver=new BuildRuleResolver();
  createSampleAndroidBinaryRule(ruleResolver);
  BuildTargetParser parser=EasyMock.createNiceMock(BuildTargetParser.class);
  final BuildTarget apkTarget=BuildTargetFactory.newInstance("//:fb4a");
  EasyMock.expect(parser.parse(EasyMock.eq(":fb4a"),EasyMock.anyObject(ParseContext.class))).andStubReturn(apkTarget);
  EasyMock.replay(parser);
  BuildTarget buildTarget=BuildTarget.builder("//src/com/facebook","sign_fb4a").build();
  ApkGenruleDescription description=new ApkGenruleDescription();
  ApkGenruleDescription.Arg arg=description.createUnpopulatedConstructorArg();
  arg.apk=new FakeInstallable(AndroidBinaryDescription.TYPE,apkTarget,new SourcePathResolver(ruleResolver)).getBuildTarget();
  arg.bash=Optional.of("");
  arg.cmd=Optional.of("python signer.py $APK key.properties > $OUT");
  arg.cmdExe=Optional.of("");
  arg.out="signed_fb4a.apk";
  arg.srcs=Optional.of(ImmutableList.<SourcePath>of(new PathSourcePath(Paths.get("src/com/facebook/signer.py")),new PathSourcePath(Paths.get("src/com/facebook/key.properties"))));
  BuildRuleParams params=new FakeBuildRuleParamsBuilder(buildTarget).setProjectFilesystem(new ProjectFilesystem(Paths.get(".")){
    @Override public Function<Path,Path> getAbsolutifier(){
      return relativeToAbsolutePathFunction;
    }
  }
).build();
  ApkGenrule apkGenrule=description.createBuildRule(params,ruleResolver,arg);
  ruleResolver.addToIndex(apkGenrule);
  String expectedApkOutput="/opt/local/fbandroid/" + GEN_DIR + "/src/com/facebook/sign_fb4a.apk";
  assertEquals(expectedApkOutput,apkGenrule.getAbsoluteOutputFilePath());
  assertEquals("The apk that this rule is modifying must have the apk in its deps.",ImmutableSet.of(apkTarget.toString()),FluentIterable.from(apkGenrule.getDeps()).transform(Functions.toStringFunction()).toSet());
  BuildContext buildContext=BuildContext.builder().setActionGraph(EasyMock.createMock(ActionGraph.class)).setStepRunner(EasyMock.createNiceMock(StepRunner.class)).setProjectFilesystem(EasyMock.createNiceMock(ProjectFilesystem.class)).setClock(EasyMock.createMock(Clock.class)).setBuildId(EasyMock.createMock(BuildId.class)).setArtifactCache(EasyMock.createMock(ArtifactCache.class)).setJavaPackageFinder(EasyMock.createNiceMock(JavaPackageFinder.class)).setEventBus(BuckEventBusFactory.newInstance()).build();
  Iterable<Path> expectedInputsToCompareToOutputs=ImmutableList.<Path>of(Paths.get("src/com/facebook/signer.py"),Paths.get("src/com/facebook/key.properties"));
  MoreAsserts.assertIterablesEquals(expectedInputsToCompareToOutputs,apkGenrule.getInputsToCompareToOutput());
  List<Step> steps=apkGenrule.getBuildSteps(buildContext,new FakeBuildableContext());
  assertEquals(7,steps.size());
  Step firstStep=steps.get(0);
  assertTrue(firstStep instanceof RmStep);
  RmStep rmCommand=(RmStep)firstStep;
  ExecutionContext executionContext=newEmptyExecutionContext();
  assertEquals("First command should delete the output file to be written by the genrule.",ImmutableList.of("rm","-f",apkGenrule.getPathToOutputFile().toString()),rmCommand.getShellCommand(executionContext));
  Step secondStep=steps.get(1);
  assertTrue(secondStep instanceof MkdirStep);
  MkdirStep mkdirCommand=(MkdirStep)secondStep;
  assertEquals("Second command should make sure the output directory exists.",Paths.get(GEN_DIR + "/src/com/facebook/"),mkdirCommand.getPath(executionContext));
  Step thirdStep=steps.get(2);
  assertTrue(thirdStep instanceof MakeCleanDirectoryStep);
  MakeCleanDirectoryStep secondMkdirCommand=(MakeCleanDirectoryStep)thirdStep;
  Path relativePathToTmpDir=GEN_PATH.resolve("src/com/facebook/sign_fb4a__tmp");
  assertEquals("Third command should make sure the temp directory exists.",relativePathToTmpDir,secondMkdirCommand.getPath());
  Step fourthStep=steps.get(3);
  assertTrue(fourthStep instanceof MakeCleanDirectoryStep);
  MakeCleanDirectoryStep thirdMkdirCommand=(MakeCleanDirectoryStep)fourthStep;
  Path relativePathToSrcDir=GEN_PATH.resolve("src/com/facebook/sign_fb4a__srcs");
  assertEquals("Fourth command should make sure the temp directory exists.",relativePathToSrcDir,thirdMkdirCommand.getPath());
  MkdirAndSymlinkFileStep linkSource1=(MkdirAndSymlinkFileStep)steps.get(4);
  assertEquals(Paths.get("src/com/facebook/signer.py"),linkSource1.getSource());
  assertEquals(Paths.get(relativePathToSrcDir + "/signer.py"),linkSource1.getTarget());
  MkdirAndSymlinkFileStep linkSource2=(MkdirAndSymlinkFileStep)steps.get(5);
  assertEquals(Paths.get("src/com/facebook/key.properties"),linkSource2.getSource());
  assertEquals(Paths.get(relativePathToSrcDir + "/key.properties"),linkSource2.getTarget());
  Step seventhStep=steps.get(6);
  assertTrue(seventhStep instanceof ShellStep);
  ShellStep genruleCommand=(ShellStep)seventhStep;
  assertEquals("genrule",genruleCommand.getShortName());
  ImmutableMap<String,String> environmentVariables=genruleCommand.getEnvironmentVariables(executionContext);
  assertEquals(new ImmutableMap.Builder<String,String>().put("APK",relativeToAbsolutePathFunction.apply(GEN_PATH.resolve("fb4a.apk")).toString()).put("OUT",expectedApkOutput).build(),environmentVariables);
  assertEquals(ImmutableList.of("/bin/bash","-e","-c","python signer.py $APK key.properties > $OUT"),genruleCommand.getShellCommand(executionContext));
  EasyMock.verify(parser);
}

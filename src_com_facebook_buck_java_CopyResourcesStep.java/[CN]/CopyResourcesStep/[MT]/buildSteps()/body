{
  ImmutableList.Builder<Step> allSteps=ImmutableList.builder();
  if (resources.isEmpty()) {
    return allSteps.build();
  }
  String targetPackageDir=javaPackageFinder.findJavaPackageForPath(target.getBasePathWithSlash()).replace('.',File.separatorChar);
  for (  SourcePath rawResource : resources) {
    final Path pathToResource=rawResource.resolve();
    String resource=MorePaths.pathWithUnixSeparators(pathToResource);
    Matcher matcher;
    if ((matcher=GENERATED_FILE_PATTERN.matcher(resource)).matches()) {
      resource=matcher.group(1);
    }
    String javaPackageAsPath=javaPackageFinder.findJavaPackageFolderForPath(resource);
    Path relativeSymlinkPath;
    if ("".equals(javaPackageAsPath)) {
      relativeSymlinkPath=pathToResource.getFileName();
    }
 else {
      int lastIndex=resource.lastIndexOf(javaPackageAsPath);
      if (lastIndex < 0) {
        Preconditions.checkState(rawResource instanceof BuildRuleSourcePath,"If resource path %s does not contain %s, then it must be a BuildRuleSourcePath.",pathToResource,javaPackageAsPath);
        relativeSymlinkPath=Paths.get(String.format("%s%s%s",targetPackageDir,targetPackageDir.isEmpty() ? "" : "/",rawResource.resolve().getFileName()));
      }
 else {
        relativeSymlinkPath=Paths.get(resource.substring(lastIndex));
      }
    }
    Path target=outputDirectory.resolve(relativeSymlinkPath);
    MkdirAndSymlinkFileStep link=new MkdirAndSymlinkFileStep(pathToResource,target);
    allSteps.add(link);
  }
  return allSteps.build();
}

{
  ProjectFilesystem filesystem=context.getProjectFilesystem();
  Manifest manifest=new Manifest();
  manifest.getMainAttributes().put(Attributes.Name.MANIFEST_VERSION,"1.0");
  Path absoluteOutputPath=filesystem.getPathForRelativePath(pathToOutputFile);
  try (CustomZipOutputStream outputFile=ZipOutputStreams.newOutputStream(absoluteOutputPath,APPEND_TO_ZIP)){
    Set<String> alreadyAddedEntries=Sets.newHashSet();
    ProjectFilesystem projectFilesystem=context.getProjectFilesystem();
    for (    Path entry : entriesToJar) {
      Path file=projectFilesystem.getPathForRelativePath(entry);
      if (Files.isRegularFile(file)) {
        Preconditions.checkArgument(!file.equals(absoluteOutputPath),"Trying to put file %s into itself",file);
        copyZipEntriesToJar(file,outputFile,manifest,alreadyAddedEntries,context.getBuckEventBus(),blacklist);
      }
 else       if (Files.isDirectory(file)) {
        addFilesInDirectoryToJar(file,outputFile,alreadyAddedEntries,context.getBuckEventBus());
      }
 else {
        throw new IllegalStateException("Must be a file or directory: " + file);
      }
    }
    if (manifestFile != null) {
      try (InputStream manifestStream=Files.newInputStream(filesystem.getPathForRelativePath(manifestFile))){
        Manifest userSupplied=new Manifest(manifestStream);
        if (mergeManifests) {
          merge(manifest,userSupplied);
        }
 else {
          manifest=userSupplied;
        }
      }
     }
    if (mainClass != null) {
      if (!mainClassPresent(mainClass,alreadyAddedEntries)) {
        context.getStdErr().print(String.format("ERROR: Main class %s does not exist.\n",mainClass));
        return 1;
      }
      manifest.getMainAttributes().put(Attributes.Name.MAIN_CLASS,mainClass);
    }
    JarEntry manifestEntry=new JarEntry(JarFile.MANIFEST_NAME);
    manifestEntry.setTime(0);
    outputFile.putNextEntry(manifestEntry);
    manifest.write(outputFile);
  }
   return 0;
}

{
  Step passingStep=new FakeStep("step1","fake step 1",0);
  Step failingStep=new FakeStep("step1","fake step 1",1);
  EventBus eventBus=new EventBus();
  BuckEventListener listener=new BuckEventListener();
  eventBus.register(listener);
  BuckEventBus buckEventBus=new BuckEventBus(eventBus);
  ExecutionContext context=ExecutionContext.builder().setProjectFilesystem(createMock(ProjectFilesystem.class)).setConsole(new TestConsole()).setEventBus(buckEventBus).build();
  ThreadFactory threadFactory=new ThreadFactoryBuilder().setDaemon(true).setNameFormat(getClass().getSimpleName() + "-%d").build();
  ListeningExecutorService executorService=MoreExecutors.listeningDecorator(Executors.newFixedThreadPool(3,threadFactory));
  DefaultStepRunner runner=new DefaultStepRunner(context,executorService);
  runner.runStep(passingStep);
  try {
    runner.runStep(failingStep);
    fail("Failing step should have thrown an exception");
  }
 catch (  StepFailedException e) {
    assertEquals(e.getStep(),failingStep);
  }
  ImmutableList<StepEvent> expected=ImmutableList.of(StepEvent.started(passingStep,"step1","fake step 1"),StepEvent.finished(passingStep,"step1","fake step 1",0),StepEvent.started(failingStep,"step1","fake step 1"),StepEvent.finished(failingStep,"step1","fake step 1",1));
  Iterable<StepEvent> events=Iterables.filter(listener.getEvents(),StepEvent.class);
  assertEquals(expected,ImmutableList.copyOf(events));
}

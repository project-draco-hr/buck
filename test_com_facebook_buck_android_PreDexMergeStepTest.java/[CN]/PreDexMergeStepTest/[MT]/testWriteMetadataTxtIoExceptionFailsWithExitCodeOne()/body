{
  PreDexMergeStep preDexMergeStep=createPreDexMergeStep(SAMPLE_DEX_FILES_TO_MERGE,300,DexStore.JAR);
  ProjectFilesystem projectFilesystem=EasyMock.createMock(ProjectFilesystem.class);
  configureResolveMethod(projectFilesystem);
  configureCanarySetup(projectFilesystem,2);
  projectFilesystem.writeLinesToPath(EasyMock.isA(Iterable.class),EasyMock.isA(Path.class));
  EasyMock.expectLastCall().andThrow(new IOException());
  setExpectedSecondaryDexFiles(projectFilesystem,2,DexStore.JAR,true);
  BuckEventBus eventBus=BuckEventBusFactory.newInstance();
  CapturingLogEventListener listener=new BuckEventBusFactory.CapturingLogEventListener();
  eventBus.register(listener);
  ExecutionContext context=TestExecutionContext.newBuilder().setProjectFilesystem(projectFilesystem).setEventBus(eventBus).build();
  EasyMock.replay(projectFilesystem);
  int exitCode=preDexMergeStep.execute(context);
  assertEquals(1,exitCode);
  assertEquals(ImmutableList.of("Failed when writing metadata.txt multi-dex."),listener.getErrorMessages());
  EasyMock.verify(projectFilesystem);
}

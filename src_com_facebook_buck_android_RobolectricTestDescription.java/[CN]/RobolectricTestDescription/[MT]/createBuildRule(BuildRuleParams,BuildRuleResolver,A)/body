{
  SourcePathResolver pathResolver=new SourcePathResolver(resolver);
  JavacOptions.Builder javacOptions=JavaLibraryDescription.getJavacOptions(args,templateOptions);
  AnnotationProcessingParams annotationParams=args.buildAnnotationProcessingParams(params.getBuildTarget(),params.getProjectFilesystem(),resolver);
  javacOptions.setAnnotationProcessingParams(annotationParams);
  AndroidLibraryGraphEnhancer graphEnhancer=new AndroidLibraryGraphEnhancer(params.getBuildTarget(),params.copyWithExtraDeps(resolver.getAllRules(args.exportedDeps.get())),javacOptions.build(),ResourceDependencyMode.TRANSITIVE);
  Optional<DummyRDotJava> dummyRDotJava=graphEnhancer.createBuildableForAndroidResources(resolver,true);
  ImmutableSet<Path> additionalClasspathEntries=ImmutableSet.of();
  if (dummyRDotJava.isPresent()) {
    additionalClasspathEntries=ImmutableSet.of(dummyRDotJava.get().getRDotJavaBinFolder());
    ImmutableSortedSet<BuildRule> newExtraDeps=ImmutableSortedSet.<BuildRule>naturalOrder().addAll(params.getExtraDeps()).add(dummyRDotJava.get()).build();
    params=params.copyWithExtraDeps(newExtraDeps);
  }
  return new RobolectricTest(params,pathResolver,args.srcs.get(),JavaLibraryDescription.validateResources(pathResolver,args,params.getProjectFilesystem()),args.labels.get(),args.contacts.get(),args.proguardConfig,additionalClasspathEntries,javacOptions.build(),args.vmArgs.get(),JavaTestDescription.validateAndGetSourcesUnderTest(args.sourceUnderTest.get(),params.getBuildTarget(),resolver),args.resourcesRoot,dummyRDotJava,testRuleTimeoutMs);
}

{
  ImmutableList.Builder<MacroMatchResult> results=ImmutableList.builder();
  Matcher matcher=MACRO_PATTERN.matcher(blob);
  while (matcher.find()) {
    if (matcher.start() > 0 && blob.charAt(matcher.start() - 1) == '\\') {
      continue;
    }
    String name=matcher.group(1);
    if (!macros.contains(name)) {
      throw new MacroException(String.format("no such macro \"%s\"",name));
    }
    String input=Optional.fromNullable(matcher.group(2)).or("");
    MatchResult matchResult=matcher.toMatchResult();
    results.add(MacroMatchResult.builder().setMacroType(name).setMacroInput(input).setStartIndex(matchResult.start()).setEndIndex(matchResult.end()).build());
  }
  return results.build();
}

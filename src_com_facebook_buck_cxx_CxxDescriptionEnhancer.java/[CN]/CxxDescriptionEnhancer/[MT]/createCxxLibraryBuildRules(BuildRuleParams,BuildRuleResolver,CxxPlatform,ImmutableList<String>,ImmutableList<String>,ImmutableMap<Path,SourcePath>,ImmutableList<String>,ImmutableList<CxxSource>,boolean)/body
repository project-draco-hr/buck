{
  SourcePathResolver pathResolver=new SourcePathResolver(resolver);
  final SymlinkTree headerSymlinkTree=createHeaderSymlinkTreeBuildRule(params,resolver,headers);
  CxxPreprocessorInput cxxPreprocessorInput=combineCxxPreprocessorInput(params,cxxPlatform,preprocessorFlags,headerSymlinkTree,headers);
  ImmutableList<SourcePath> objects=createPreprocessAndCompileBuildRules(params,resolver,cxxPlatform,cxxPreprocessorInput,compilerFlags,false,sources);
  final BuildTarget staticLibraryTarget=createStaticLibraryBuildTarget(params.getBuildTarget());
  final Path staticLibraryPath=Archives.getArchiveOutputPath(staticLibraryTarget);
  final Archive staticLibraryBuildRule=Archives.createArchiveRule(pathResolver,staticLibraryTarget,params,cxxPlatform.getAr(),staticLibraryPath,objects);
  resolver.addToIndex(staticLibraryBuildRule);
  ImmutableList<SourcePath> picObjects=createPreprocessAndCompileBuildRules(params,resolver,cxxPlatform,cxxPreprocessorInput,compilerFlags,true,sources);
  final BuildTarget sharedLibraryTarget=createSharedLibraryBuildTarget(params.getBuildTarget());
  final String sharedLibrarySoname=getSharedLibrarySoname(params.getBuildTarget());
  final Path sharedLibraryPath=getSharedLibraryOutputPath(params.getBuildTarget());
  final CxxLink sharedLibraryBuildRule=CxxLinkableEnhancer.createCxxLinkableBuildRule(cxxPlatform,params,pathResolver,ImmutableList.<String>of(),ImmutableList.<String>of(),sharedLibraryTarget,CxxLinkableEnhancer.LinkType.SHARED,Optional.of(sharedLibrarySoname),sharedLibraryPath,picObjects,NativeLinkable.Type.SHARED,params.getDeps());
  resolver.addToIndex(sharedLibraryBuildRule);
  return new CxxLibrary(params,pathResolver){
    @Override public CxxPreprocessorInput getCxxPreprocessorInput(){
      return new CxxPreprocessorInput(ImmutableSet.of(headerSymlinkTree.getBuildTarget()),propagatedPpFlags,propagatedPpFlags,headers,ImmutableList.of(CxxDescriptionEnhancer.getHeaderSymlinkTreePath(params.getBuildTarget())),ImmutableList.<Path>of());
    }
    @Override public NativeLinkableInput getNativeLinkableInput(    Linker linker,    NativeLinkable.Type type){
      ImmutableList.Builder<String> linkerArgsBuilder=ImmutableList.builder();
      if (type == Type.SHARED) {
        linkerArgsBuilder.add(sharedLibraryPath.toString());
      }
 else       if (linkWhole) {
        linkerArgsBuilder.addAll(linker.linkWhole(staticLibraryPath.toString()));
      }
 else {
        linkerArgsBuilder.add(staticLibraryPath.toString());
      }
      final ImmutableList<String> linkerArgs=linkerArgsBuilder.build();
      return new NativeLinkableInput(ImmutableList.<SourcePath>of(new BuildRuleSourcePath(type == Type.STATIC ? staticLibraryBuildRule : sharedLibraryBuildRule)),linkerArgs);
    }
    @Override public PythonPackageComponents getPythonPackageComponents(){
      return new PythonPackageComponents(ImmutableMap.<Path,SourcePath>of(),ImmutableMap.<Path,SourcePath>of(),ImmutableMap.<Path,SourcePath>of(Paths.get(sharedLibrarySoname),new BuildRuleSourcePath(sharedLibraryBuildRule)));
    }
  }
;
}

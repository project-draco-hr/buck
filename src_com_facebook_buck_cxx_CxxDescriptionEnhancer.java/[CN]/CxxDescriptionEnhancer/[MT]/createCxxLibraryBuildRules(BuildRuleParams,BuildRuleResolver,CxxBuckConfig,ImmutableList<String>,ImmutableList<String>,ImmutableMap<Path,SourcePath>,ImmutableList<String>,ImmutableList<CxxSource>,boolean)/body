{
  final SymlinkTree headerSymlinkTree=createHeaderSymlinkTreeBuildRule(params,resolver,headers);
  CxxPreprocessorInput cxxPreprocessorInput=combineCxxPreprocessorInput(params,cxxBuckConfig,preprocessorFlags,headerSymlinkTree,headers);
  ImmutableList<SourcePath> objects=createPreprocessAndCompileBuildRules(params,resolver,cxxBuckConfig,cxxPreprocessorInput,compilerFlags,false,sources);
  final BuildTarget staticLibraryTarget=createStaticLibraryBuildTarget(params.getBuildTarget());
  final Path staticLibraryPath=Archives.getArchiveOutputPath(staticLibraryTarget);
  final Archive staticLibraryBuildRule=Archives.createArchiveRule(staticLibraryTarget,params,cxxBuckConfig.getAr().or(Archives.DEFAULT_ARCHIVE_PATH),staticLibraryPath,objects);
  resolver.addToIndex(staticLibraryBuildRule);
  ImmutableList<SourcePath> picObjects=createPreprocessAndCompileBuildRules(params,resolver,cxxBuckConfig,cxxPreprocessorInput,compilerFlags,true,sources);
  final BuildTarget sharedLibraryTarget=createSharedLibraryBuildTarget(params.getBuildTarget());
  final String sharedLibrarySoname=getSharedLibrarySoname(params.getBuildTarget());
  final Path sharedLibraryPath=getSharedLibraryOutputPath(params.getBuildTarget());
  final CxxLink sharedLibraryBuildRule=CxxLinkableEnhancer.createCxxLinkableBuildRule(params,cxxBuckConfig.getLd().or(CxxLinkables.DEFAULT_LINKER_PATH),cxxBuckConfig.getCxxLdFlags(),cxxBuckConfig.getLdFlags(),sharedLibraryTarget,CxxLinkableEnhancer.LinkType.SHARED,Optional.of(sharedLibrarySoname),sharedLibraryPath,picObjects,NativeLinkable.Type.SHARED,params.getDeps());
  resolver.addToIndex(sharedLibraryBuildRule);
  return new CxxLibrary(params){
    @Override public CxxPreprocessorInput getCxxPreprocessorInput(){
      return new CxxPreprocessorInput(ImmutableSet.of(headerSymlinkTree.getBuildTarget()),propagatedPpFlags,propagatedPpFlags,headers,ImmutableList.of(CxxDescriptionEnhancer.getHeaderSymlinkTreePath(params.getBuildTarget())),ImmutableList.<Path>of());
    }
    @Override public NativeLinkableInput getNativeLinkableInput(    NativeLinkable.Type type){
      ImmutableList.Builder<String> linkerArgsBuilder=ImmutableList.builder();
      if (linkWhole && type == Type.STATIC) {
        linkerArgsBuilder.add("--whole-archive");
      }
      linkerArgsBuilder.add(type == Type.STATIC ? staticLibraryPath.toString() : sharedLibraryPath.toString());
      if (linkWhole && type == Type.STATIC) {
        linkerArgsBuilder.add("--no-whole-archive");
      }
      final ImmutableList<String> linkerArgs=linkerArgsBuilder.build();
      return new NativeLinkableInput(ImmutableList.<SourcePath>of(new BuildRuleSourcePath(type == Type.STATIC ? staticLibraryBuildRule : sharedLibraryBuildRule)),linkerArgs);
    }
    @Override public PythonPackageComponents getPythonPackageComponents(){
      return new PythonPackageComponents(ImmutableMap.<Path,SourcePath>of(),ImmutableMap.<Path,SourcePath>of(),ImmutableMap.<Path,SourcePath>of(Paths.get(sharedLibrarySoname),new BuildRuleSourcePath(sharedLibraryBuildRule)));
    }
  }
;
}

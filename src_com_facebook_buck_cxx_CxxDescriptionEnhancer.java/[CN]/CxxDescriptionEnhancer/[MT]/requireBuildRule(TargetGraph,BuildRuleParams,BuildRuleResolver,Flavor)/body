{
  BuildTarget target=BuildTarget.builder(params.getBuildTarget()).addFlavors(flavors).build();
  Optional<BuildRule> rule=ruleResolver.getRuleOptional(target);
  if (!rule.isPresent()) {
    TargetNode<?> node=targetGraph.get(params.getBuildTarget());
    Preconditions.checkNotNull(node,String.format("%s not in target graph",params.getBuildTarget()));
    rule=Optional.of(createBuildRule(targetGraph,params,ruleResolver,node,flavors));
    ruleResolver.addToIndex(rule.get());
  }
  return rule.get();
}

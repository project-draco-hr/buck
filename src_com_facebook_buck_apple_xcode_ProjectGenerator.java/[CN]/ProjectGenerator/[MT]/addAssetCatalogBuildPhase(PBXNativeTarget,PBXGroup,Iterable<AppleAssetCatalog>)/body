{
  PBXGroup resourcesGroup=targetGroup.getOrCreateChildGroupByName("Resources");
  ImmutableList.Builder<String> commonAssetCatalogsBuilder=ImmutableList.builder();
  ImmutableList.Builder<String> assetCatalogsToSplitIntoBundlesBuilder=ImmutableList.builder();
  for (  AppleAssetCatalog assetCatalog : assetCatalogs) {
    List<String> scriptArguments=Lists.newArrayList();
    for (    Path dir : assetCatalog.getDirs()) {
      Path pathRelativeToProjectRoot=pathRelativizer.outputDirToRootRelative(dir);
      resourcesGroup.getOrCreateFileReferenceBySourceTreePath(new SourceTreePath(PBXReference.SourceTree.SOURCE_ROOT,pathRelativeToProjectRoot));
      LOG.debug("Resolved asset catalog path %s, output directory %s, result %s",dir,outputDirectory,pathRelativeToProjectRoot);
      scriptArguments.add("$PROJECT_DIR/" + pathRelativeToProjectRoot.toString());
    }
    if (assetCatalog.getCopyToBundles()) {
      assetCatalogsToSplitIntoBundlesBuilder.addAll(scriptArguments);
    }
 else {
      commonAssetCatalogsBuilder.addAll(scriptArguments);
    }
  }
  ImmutableList<String> commonAssetCatalogs=commonAssetCatalogsBuilder.build();
  ImmutableList<String> assetCatalogsToSplitIntoBundles=assetCatalogsToSplitIntoBundlesBuilder.build();
  if (commonAssetCatalogs.size() == 0 && assetCatalogsToSplitIntoBundles.size() == 0) {
    return;
  }
  Path assetCatalogBuildPhaseScriptRelativeToProjectRoot;
  if (PATH_OVERRIDE_FOR_ASSET_CATALOG_BUILD_PHASE_SCRIPT != null) {
    assetCatalogBuildPhaseScriptRelativeToProjectRoot=pathRelativizer.outputDirToRootRelative(Paths.get(PATH_OVERRIDE_FOR_ASSET_CATALOG_BUILD_PHASE_SCRIPT));
  }
 else {
    shouldPlaceAssetCatalogCompiler=true;
    assetCatalogBuildPhaseScriptRelativeToProjectRoot=MorePaths.relativize(outputDirectory,placedAssetCatalogBuildPhaseScript);
  }
  String combinedAssetCatalogsToBeSplitIntoBundlesScriptArguments=Joiner.on(' ').join(assetCatalogsToSplitIntoBundles);
  String combinedCommonAssetCatalogsScriptArguments=Joiner.on(' ').join(commonAssetCatalogs);
  PBXShellScriptBuildPhase phase=new PBXShellScriptBuildPhase();
  StringBuilder scriptBuilder=new StringBuilder("set -e\n");
  if (commonAssetCatalogs.size() != 0) {
    scriptBuilder.append("\"${PROJECT_DIR}/\"" + assetCatalogBuildPhaseScriptRelativeToProjectRoot.toString() + " "+ combinedCommonAssetCatalogsScriptArguments+ "\n");
  }
  if (assetCatalogsToSplitIntoBundles.size() != 0) {
    scriptBuilder.append("\"${PROJECT_DIR}/\"" + assetCatalogBuildPhaseScriptRelativeToProjectRoot.toString() + " -b "+ combinedAssetCatalogsToBeSplitIntoBundlesScriptArguments);
  }
  phase.setShellScript(scriptBuilder.toString());
  LOG.debug("Added asset catalog build phase %s",phase);
  target.getBuildPhases().add(phase);
}

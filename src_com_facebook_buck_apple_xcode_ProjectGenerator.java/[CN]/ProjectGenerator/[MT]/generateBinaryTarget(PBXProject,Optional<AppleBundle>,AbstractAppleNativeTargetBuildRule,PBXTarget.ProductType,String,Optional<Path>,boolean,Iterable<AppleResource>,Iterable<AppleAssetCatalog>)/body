{
  BuildTarget buildTarget=bundle.isPresent() ? bundle.get().getBuildTarget() : appleBuildRule.getBuildTarget();
  PBXNativeTarget target=new PBXNativeTarget(getXcodeTargetName(buildTarget),productType);
  setNativeTargetGid(target,appleBuildRule);
  PBXGroup targetGroup=project.getMainGroup().getOrCreateChildGroupByName(target.getName());
  ImmutableMap.Builder<String,String> extraSettingsBuilder=ImmutableMap.builder();
  extraSettingsBuilder.put("TARGET_NAME",getProductName(buildTarget)).put("SRCROOT",pathRelativizer.outputPathToBuildTargetPath(buildTarget).toString());
  if (!options.contains(Option.REFERENCE_EXISTING_XCCONFIGS)) {
    extraSettingsBuilder.put("GCC_PREFIX_HEADER","$(SRCROOT)/$(inherited)");
  }
  if (infoPlistOptional.isPresent()) {
    Path infoPlistPath=pathRelativizer.outputDirToRootRelative(infoPlistOptional.get());
    extraSettingsBuilder.put("INFOPLIST_FILE",infoPlistPath.toString());
  }
  if (appleBuildRule.getUseBuckHeaderMaps()) {
    extraSettingsBuilder.put("USE_HEADERMAP","NO");
  }
  ImmutableMap.Builder<String,String> defaultSettingsBuilder=ImmutableMap.builder();
  defaultSettingsBuilder.put("PRODUCT_NAME",getProductName(buildTarget));
  if (bundle.isPresent()) {
    defaultSettingsBuilder.put("WRAPPER_EXTENSION",bundle.get().getExtensionString());
  }
  defaultSettingsBuilder.put("PUBLIC_HEADERS_FOLDER_PATH",getHeaderOutputPathForRule(appleBuildRule.getHeaderPathPrefix()));
  if (!bundle.isPresent() && appleBuildRule.getType().equals(AppleLibraryDescription.TYPE)) {
    defaultSettingsBuilder.put("CONFIGURATION_BUILD_DIR",getObjectOutputPathForRule(appleBuildRule));
  }
  ImmutableMap.Builder<String,String> appendConfigsBuilder=ImmutableMap.builder();
  appendConfigsBuilder.put("HEADER_SEARCH_PATHS",Joiner.on(' ').join(Iterators.concat(collectRecursiveHeaderSearchPaths(appleBuildRule).iterator(),collectRecursiveHeaderMaps(appleBuildRule).iterator()))).put("USER_HEADER_SEARCH_PATHS",Joiner.on(' ').join(collectUserHeaderMaps(appleBuildRule))).put("LIBRARY_SEARCH_PATHS",Joiner.on(' ').join(collectRecursiveLibrarySearchPaths(appleBuildRule))).put("FRAMEWORK_SEARCH_PATHS",Joiner.on(' ').join(collectRecursiveFrameworkSearchPaths(appleBuildRule)));
  setTargetBuildConfigurations(buildTarget,target,targetGroup,appleBuildRule.getConfigurations(),extraSettingsBuilder.build(),defaultSettingsBuilder.build(),appendConfigsBuilder.build());
  if (bundle.isPresent()) {
    addRunScriptBuildPhasesForDependencies(bundle.get(),target);
  }
  addRunScriptBuildPhasesForDependencies(appleBuildRule,target);
  addBuildPhasesGroupsAndHeaderMapsForSourcesAndHeaders(appleBuildRule,target,targetGroup,appleBuildRule.getHeaderPathPrefix(),appleBuildRule.getUseBuckHeaderMaps(),appleBuildRule.getSrcs(),appleBuildRule.getPerFileFlags());
  if (includeFrameworks) {
    ImmutableSet.Builder<String> frameworksBuilder=ImmutableSet.builder();
    frameworksBuilder.addAll(appleBuildRule.getFrameworks());
    collectRecursiveFrameworkDependencies(appleBuildRule,frameworksBuilder);
    addFrameworksBuildPhase(buildTarget,target,project.getMainGroup().getOrCreateChildGroupByName("Frameworks"),frameworksBuilder.build(),collectRecursiveLibraryDependencies(appleBuildRule));
  }
  if (!Iterables.isEmpty(resources)) {
    addResourcesBuildPhase(target,targetGroup,resources);
  }
  if (!Iterables.isEmpty(assetCatalogs)) {
    addAssetCatalogBuildPhase(target,targetGroup,assetCatalogs);
  }
  addCoreDataModelBuildPhase(targetGroup,Iterables.filter(appleBuildRule.getDeps(),CoreDataModel.class));
  PBXGroup productsGroup=project.getMainGroup().getOrCreateChildGroupByName("Products");
  String productName=getProductName(buildTarget);
  String outputName=String.format(productOutputFormat,productName);
  PBXFileReference productReference=productsGroup.getOrCreateFileReferenceBySourceTreePath(new SourceTreePath(PBXReference.SourceTree.BUILT_PRODUCTS_DIR,Paths.get(outputName)));
  target.setProductName(productName);
  target.setProductReference(productReference);
  return target;
}

{
  BuildTarget buildConfigBuildTarget=BuildTarget.builder("//java/com/example","cfg").build();
  BuildRuleParams buildConfigParams=new FakeBuildRuleParamsBuilder(buildConfigBuildTarget).build();
  AndroidBuildConfigJavaLibrary buildConfigJavaLibrary=AndroidBuildConfigDescription.createBuildRule(buildConfigParams,"com.example.buck",false,ImmutableMap.<String,Object>of());
  BuildTarget apkTarget=BuildTargetFactory.newInstance("//java/com/example:apk");
  BuildRuleParams originalParams=new FakeBuildRuleParamsBuilder(apkTarget).setDeps(ImmutableSortedSet.<BuildRule>of(buildConfigJavaLibrary)).build();
  BuildRuleResolver ruleResolver=new BuildRuleResolver();
  Keystore keystore=createStrictMock(Keystore.class);
  AndroidBinaryGraphEnhancer graphEnhancer=new AndroidBinaryGraphEnhancer(originalParams,ruleResolver,ResourcesFilter.ResourceCompressionMode.ENABLED_WITH_STRINGS_AS_ASSETS,FilterResourcesStep.ResourceFilter.EMPTY_FILTER,new TestSourcePath("AndroidManifest.xml"),AndroidBinary.PackageType.DEBUG,ImmutableSet.<AndroidBinary.TargetCpuType>of(),false,false,BuildTargets.getBinPath(apkTarget,"%s/classes.dex"),DexSplitMode.NO_SPLIT,ImmutableSet.<BuildTarget>of(),ImmutableSet.<BuildTarget>of(),JavacOptions.DEFAULTS,true,keystore);
  replay(keystore);
  EnhancementResult result=graphEnhancer.createAdditionalBuildables();
  AndroidPackageableCollection packageableCollection=result.getPackageableCollection();
  String flavor="buildconfig_com_example_buck";
  assertEquals("The only classpath entry to dex should be the one from the AndroidBuildConfigJavaLibrary" + " created via graph enhancement.",ImmutableSet.of(Paths.get("buck-out/gen/java/com/example/lib__apk#" + flavor + "__output/apk#"+ flavor+ ".jar")),packageableCollection.classpathEntriesToDex);
  BuildTarget enhancedBuildConfigTarget=BuildTarget.builder(apkTarget).setFlavor(flavor).build();
  BuildRule enhancedBuildConfigRule=ruleResolver.get(enhancedBuildConfigTarget);
  assertTrue(enhancedBuildConfigRule instanceof AndroidBuildConfigJavaLibrary);
  AndroidBuildConfigJavaLibrary enhancedBuildConfigJavaLibrary=(AndroidBuildConfigJavaLibrary)enhancedBuildConfigRule;
  AndroidBuildConfig androidBuildConfig=enhancedBuildConfigJavaLibrary.getAndroidBuildConfig();
  assertEquals("com.example.buck",androidBuildConfig.getJavaPackage());
  assertTrue(androidBuildConfig.isUseConstantExpressions());
  assertEquals("IS_EXOPACKAGE defaults to false, but should now be true. DEBUG should still be true.",ImmutableMap.of("DEBUG",Boolean.TRUE,"IS_EXOPACKAGE",Boolean.TRUE),androidBuildConfig.getConstants());
  ImmutableSortedSet<BuildRule> finalDeps=result.getFinalDeps();
  assertEquals(1,finalDeps.size());
  BuildRule computeExopackageDepsAbiRule=findRuleOfType(ruleResolver,ComputeExopackageDepsAbi.class);
  assertEquals(computeExopackageDepsAbiRule,finalDeps.first());
  FilteredResourcesProvider resourcesProvider=result.getFilteredResourcesProvider();
  assertTrue(resourcesProvider instanceof ResourcesFilter);
  BuildRule resourcesFilterRule=findRuleOfType(ruleResolver,ResourcesFilter.class);
  BuildRule uberRDotJavaRule=findRuleOfType(ruleResolver,UberRDotJava.class);
  MoreAsserts.assertDepends("UberRDotJava must depend on ResourcesFilter",uberRDotJavaRule,resourcesFilterRule);
  BuildRule packageStringAssetsRule=findRuleOfType(ruleResolver,PackageStringAssets.class);
  MoreAsserts.assertDepends("PackageStringAssets must depend on ResourcesFilter",packageStringAssetsRule,uberRDotJavaRule);
  BuildRule aaptPackageResourcesRule=findRuleOfType(ruleResolver,AaptPackageResources.class);
  MoreAsserts.assertDepends("AaptPackageResources must depend on ResourcesFilter",aaptPackageResourcesRule,resourcesFilterRule);
  assertFalse(result.getPreDexMerge().isPresent());
  MoreAsserts.assertDepends("ComputeExopackageDepsAbi must depend on ResourcesFilter",computeExopackageDepsAbiRule,resourcesFilterRule);
  MoreAsserts.assertDepends("ComputeExopackageDepsAbi must depend on UberRDotJava",computeExopackageDepsAbiRule,uberRDotJavaRule);
  MoreAsserts.assertDepends("ComputeExopackageDepsAbi must depend on PackageStringAssets",computeExopackageDepsAbiRule,packageStringAssetsRule);
  MoreAsserts.assertDepends("ComputeExopackageDepsAbi must depend on AaptPackageResources",computeExopackageDepsAbiRule,aaptPackageResourcesRule);
  assertTrue(result.getPackageStringAssets().isPresent());
  assertTrue(result.getComputeExopackageDepsAbi().isPresent());
  verify(keystore);
}

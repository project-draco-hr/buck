{
  Set<String> uniqueLibraryNamesSet=new HashSet<>();
  ImmutableMap.Builder<BuildTarget,IjLibrary> mapBuilder=new ImmutableMap.Builder<>();
  for (  TargetNode<?> node : targetNodes) {
    IjLibraryRule<?> rule=libraryRuleIndex.get(node.getType());
    if (rule == null) {
      continue;
    }
    String libraryName=Util.intelliJLibraryName(node.getBuildTarget());
    Preconditions.checkState(!uniqueLibraryNamesSet.contains(libraryName),"Trying to use the same library name for different targets.");
    IjLibrary.Builder libraryBuilder=IjLibrary.builder();
    rule.apply((TargetNode)node,libraryBuilder);
    libraryBuilder.setName(libraryName);
    libraryBuilder.setTargets(ImmutableSet.<TargetNode<?>>of(node));
    mapBuilder.put(node.getBuildTarget(),libraryBuilder.build());
  }
  return mapBuilder.build();
}

{
  Map<Path,SourcePath> headersToCopy;
  if (useBuckHeaderMaps) {
    headersToCopy=ImmutableSortedMap.of();
  }
 else {
    Path headerPathPrefix=params.getBuildTarget().getBasePath().getFileName();
    headersToCopy=Maps.newHashMap();
    Splitter spaceSplitter=Splitter.on(' ').trimResults().omitEmptyStrings();
    Predicate<String> isPublicHeaderFlag=Predicates.equalTo("public");
    for (    Map.Entry<SourcePath,String> entry : perFileFlags.entrySet()) {
      String flags=entry.getValue();
      if (Iterables.any(spaceSplitter.split(flags),isPublicHeaderFlag)) {
        SourcePath sourcePath=entry.getKey();
        Path sourcePathName=pathResolver.getPath(sourcePath).getFileName();
        headersToCopy.put(headerPathPrefix.resolve(sourcePathName),sourcePath);
      }
    }
  }
  BuildRuleParams headerParams=params.copyWithDeps(ImmutableSortedSet.<BuildRule>of(),params.getExtraDeps());
  Path root=getPathToHeaders(params.getBuildTarget());
  return new SymlinkTree(headerParams,pathResolver,root,ImmutableMap.copyOf(headersToCopy));
}

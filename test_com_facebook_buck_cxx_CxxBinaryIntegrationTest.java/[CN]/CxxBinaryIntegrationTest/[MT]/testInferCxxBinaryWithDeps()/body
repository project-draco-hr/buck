{
  Path inferTopLevel=InferHelper.assumeInferIsInstalled();
  ProjectWorkspace workspace=InferHelper.setupCxxInferWorkspace(this,inferTopLevel,tmp);
  CxxPlatform cxxPlatform=DefaultCxxPlatforms.build(new CxxBuckConfig(new FakeBuckConfig()));
  BuildTarget inputBuildTarget=BuildTargetFactory.newInstance("//foo:binary_with_deps");
  String inputBuildTargetName=inputBuildTarget.withFlavors(CxxInferEnhancer.INFER).getFullyQualifiedName();
  workspace.runBuckCommand("build",inputBuildTargetName).assertSuccess();
  String sourceName="src_with_deps.c";
  String sourceFull="foo/" + sourceName;
  CxxSourceRuleFactory cxxSourceRuleFactory=CxxSourceRuleFactoryHelper.of(inputBuildTarget,cxxPlatform);
  BuildTarget topCaptureBuildTarget=cxxSourceRuleFactory.createInferCaptureBuildTarget(sourceName);
  BuildTarget topHeaderSymlinkTreeTarget=CxxDescriptionEnhancer.createHeaderSymlinkTreeTarget(inputBuildTarget,cxxPlatform.getFlavor(),HeaderVisibility.PRIVATE);
  BuildTarget topInferAnalysisTarget=inputBuildTarget.withFlavors(CxxInferEnhancer.INFER_ANALYZE);
  BuildTarget topInferReportTarget=inputBuildTarget.withFlavors(CxxInferEnhancer.INFER);
  BuildTarget depOneBuildTarget=BuildTargetFactory.newInstance("//foo:dep_one");
  String depOneSourceName="dep_one.c";
  String depOneSourceFull="foo/" + depOneSourceName;
  CxxSourceRuleFactory depOneSourceRuleFactory=CxxSourceRuleFactoryHelper.of(depOneBuildTarget,cxxPlatform);
  BuildTarget depOneCaptureBuildTarget=depOneSourceRuleFactory.createInferCaptureBuildTarget(depOneSourceName);
  BuildTarget depOneHeaderSymlinkTreeTarget=CxxDescriptionEnhancer.createHeaderSymlinkTreeTarget(depOneBuildTarget,cxxPlatform.getFlavor(),HeaderVisibility.PRIVATE);
  BuildTarget depOneExportedHeaderSymlinkTreeTarget=CxxDescriptionEnhancer.createHeaderSymlinkTreeTarget(depOneBuildTarget,cxxPlatform.getFlavor(),HeaderVisibility.PUBLIC);
  BuildTarget depOneInferAnalysisTarget=depOneCaptureBuildTarget.withFlavors(cxxPlatform.getFlavor(),CxxInferEnhancer.INFER_ANALYZE);
  BuildTarget depTwoBuildTarget=BuildTargetFactory.newInstance("//foo:dep_two");
  CxxSourceRuleFactory depTwoSourceRuleFactory=CxxSourceRuleFactoryHelper.of(depTwoBuildTarget,cxxPlatform);
  BuildTarget depTwoCaptureBuildTarget=depTwoSourceRuleFactory.createInferCaptureBuildTarget("dep_two.c");
  BuildTarget depTwoHeaderSymlinkTreeTarget=CxxDescriptionEnhancer.createHeaderSymlinkTreeTarget(depTwoBuildTarget,cxxPlatform.getFlavor(),HeaderVisibility.PRIVATE);
  BuildTarget depTwoExportedHeaderSymlinkTreeTarget=CxxDescriptionEnhancer.createHeaderSymlinkTreeTarget(depTwoBuildTarget,cxxPlatform.getFlavor(),HeaderVisibility.PUBLIC);
  BuildTarget depTwoInferAnalysisTarget=depTwoCaptureBuildTarget.withFlavors(cxxPlatform.getFlavor(),CxxInferEnhancer.INFER_ANALYZE);
  assertEquals(ImmutableSet.of(topCaptureBuildTarget,topHeaderSymlinkTreeTarget,topInferAnalysisTarget,topInferReportTarget,depOneCaptureBuildTarget,depOneHeaderSymlinkTreeTarget,depOneExportedHeaderSymlinkTreeTarget,depOneInferAnalysisTarget,depTwoCaptureBuildTarget,depTwoHeaderSymlinkTreeTarget,depTwoExportedHeaderSymlinkTreeTarget,depTwoInferAnalysisTarget),workspace.getBuildLog().getAllTargets());
  String reportPath="buck-out/gen/foo/infer-binary_with_deps#infer/report.json";
  List<InferHelper.InferBug> bugs=InferHelper.loadInferReport(workspace,reportPath);
  Assert.assertThat("No bugs expected in " + sourceFull,bugs.size(),Matchers.equalTo(0));
  workspace.resetBuildLogFile();
  workspace.runBuckCommand("build",inputBuildTargetName).assertSuccess();
  BuckBuildLog buildLog=workspace.getBuildLog();
  assertEquals(ImmutableSet.of(topInferReportTarget),buildLog.getAllTargets());
  buildLog.assertTargetHadMatchingRuleKey(topInferReportTarget.toString());
  workspace.resetBuildLogFile();
  workspace.replaceFileContents(depOneSourceFull,"flag > 0","flag < 0");
  workspace.runBuckCommand("build",inputBuildTargetName).assertSuccess();
  buildLog=workspace.getBuildLog();
  assertEquals(ImmutableSet.of(topInferAnalysisTarget,topInferReportTarget,topCaptureBuildTarget,depTwoInferAnalysisTarget,depOneCaptureBuildTarget,depOneExportedHeaderSymlinkTreeTarget,depOneHeaderSymlinkTreeTarget,depOneInferAnalysisTarget),buildLog.getAllTargets());
  buildLog.assertTargetBuiltLocally(topInferAnalysisTarget.toString());
  buildLog.assertTargetBuiltLocally(topInferReportTarget.toString());
  buildLog.assertTargetHadMatchingRuleKey(topCaptureBuildTarget.toString());
  buildLog.assertTargetHadMatchingRuleKey(depTwoInferAnalysisTarget.toString());
  buildLog.assertTargetBuiltLocally(depOneCaptureBuildTarget.toString());
  buildLog.assertTargetHadMatchingRuleKey(depOneExportedHeaderSymlinkTreeTarget.toString());
  buildLog.assertTargetHadMatchingRuleKey(depOneHeaderSymlinkTreeTarget.toString());
  buildLog.assertTargetBuiltLocally(depOneInferAnalysisTarget.toString());
  bugs=InferHelper.loadInferReport(workspace,reportPath);
  Assert.assertThat("1 bug expected in " + sourceFull + " not found",bugs.size(),Matchers.equalTo(1));
  InferHelper.InferBug bug=bugs.iterator().next();
  Assert.assertThat("Expected bug in " + sourceFull,bug.getFile(),Matchers.equalTo(sourceFull));
  Assert.assertThat("Expected NULL_DEREFERENCE",bug.getType(),Matchers.equalTo("NULL_DEREFERENCE"));
}

{
  Preconditions.checkNotNull(predicate);
  Iterable<BuildTarget> buildTargets=parser.filterTargetsInProjectFromRoots(roots,includes,eventBus,RawRulePredicates.alwaysTrue());
  DependencyGraph buildGraph=parseAndCreateGraphFromTargets(buildTargets,includes,parser,eventBus).getDependencyGraph();
  ImmutableList.Builder<BuildTarget> buildAndTestTargetsBuilder=ImmutableList.<BuildTarget>builder().addAll(roots);
  PartialGraph testGraph=PartialGraph.createPartialGraph(RawRulePredicates.isTestRule(),filesystem,includes,parser,eventBus);
  DependencyGraph testDependencyGraph=testGraph.getDependencyGraph();
  for (  BuildTarget buildTarget : testGraph.getTargets()) {
    TestRule testRule=(TestRule)testDependencyGraph.findBuildRuleByTarget(buildTarget).getBuildable();
    for (    BuildRule buildRuleUnderTest : testRule.getSourceUnderTest()) {
      if (buildGraph.findBuildRuleByTarget(buildRuleUnderTest.getBuildTarget()) != null) {
        buildAndTestTargetsBuilder.add(testRule.getBuildTarget());
        break;
      }
    }
  }
  Iterable<BuildTarget> allTargets=parser.filterTargetsInProjectFromRoots(buildAndTestTargetsBuilder.build(),includes,eventBus,predicate);
  return parseAndCreateGraphFromTargets(allTargets,includes,parser,eventBus);
}

{
  Optional<Map.Entry<Flavor,CxxPlatform>> platform=typeAndPlatform.getPlatform();
  if (params.getBuildTarget().getFlavors().contains(CxxCompilationDatabase.COMPILATION_DATABASE)) {
    return createCompilationDatabaseBuildRule(params,resolver,platform.get().getValue(),args,compileStrategy);
  }
  Optional<Map.Entry<Flavor,Type>> type=typeAndPlatform.getType();
  if (type.isPresent() && platform.isPresent()) {
    Set<Flavor> flavors=Sets.newHashSet(params.getBuildTarget().getFlavors());
    flavors.remove(type.get().getKey());
    BuildTarget target=BuildTarget.builder(params.getBuildTarget().getUnflavoredBuildTarget()).addAllFlavors(flavors).build();
    BuildRuleParams typeParams=params.copyWithChanges(params.getBuildRuleType(),target,Suppliers.ofInstance(params.getDeclaredDeps()),Suppliers.ofInstance(params.getExtraDeps()));
    if (type.get().getValue().equals(Type.HEADERS)) {
      return createHeaderSymlinkTreeBuildRule(typeParams,resolver,platform.get().getValue(),args);
    }
 else     if (type.get().getValue().equals(Type.EXPORTED_HEADERS)) {
      return createExportedHeaderSymlinkTreeBuildRule(typeParams,resolver,platform.get().getValue(),args);
    }
 else     if (type.get().getValue().equals(Type.SHARED)) {
      return createSharedLibraryBuildRule(typeParams,resolver,platform.get().getValue(),args,compileStrategy);
    }
 else {
      return createStaticLibraryBuildRule(typeParams,resolver,platform.get().getValue(),args,compileStrategy);
    }
  }
  SourcePathResolver pathResolver=new SourcePathResolver(resolver);
  return new CxxLibrary(params,resolver,pathResolver,new Function<CxxPlatform,ImmutableMultimap<CxxSource.Type,String>>(){
    @Override public ImmutableMultimap<CxxSource.Type,String> apply(    CxxPlatform input){
      return CxxFlags.getLanguageFlags(args.exportedPreprocessorFlags,args.exportedPlatformPreprocessorFlags,args.exportedLangPreprocessorFlags,input.getFlavor());
    }
  }
,new Function<CxxPlatform,ImmutableList<String>>(){
    @Override public ImmutableList<String> apply(    CxxPlatform input){
      return CxxFlags.getFlags(args.linkerFlags,args.platformLinkerFlags,input.getFlavor());
    }
  }
,args.frameworkSearchPaths.get(),args.linkWhole.or(false),args.soname,args.tests.get());
}

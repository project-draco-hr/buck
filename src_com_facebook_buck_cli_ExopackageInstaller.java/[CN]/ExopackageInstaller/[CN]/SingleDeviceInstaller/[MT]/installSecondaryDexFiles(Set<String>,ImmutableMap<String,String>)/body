{
  Preconditions.checkNotNull(device);
  try (TraceEventLogger ignored1=TraceEventLogger.start(eventBus,"install_secondary_dexes")){
    device.createForward(agentPort,agentPort);
    try {
      for (      String hash : hashesToInstall) {
        String basename=hashToBasename.get(hash);
        try (TraceEventLogger ignored2=TraceEventLogger.start(eventBus,"install_secondary_dex",ImmutableMap.of("basename",basename))){
          installSecondaryDex(device,agentPort,hash,exopackageInfo.dexInfo().get().directory().resolve(basename));
        }
       }
      try (TraceEventLogger ignored2=TraceEventLogger.start(eventBus,"install_secondary_dex_metadata")){
        try (NamedTemporaryFile temp=new NamedTemporaryFile("metadata","tmp")){
          com.google.common.io.Files.write(com.google.common.io.Files.toString(exopackageInfo.dexInfo().get().metadata().toFile(),Charsets.UTF_8).replaceAll("secondary-(\\d+)\\.dex\\.jar (\\p{XDigit}{40}) ","secondary-$2.dex.jar $2 "),temp.get().toFile(),Charsets.UTF_8);
          installFile(device,agentPort,SECONDARY_DEX_DIR.resolve("metadata.txt"),temp.get());
        }
       }
     }
  finally {
      try {
        device.removeForward(agentPort,agentPort);
      }
 catch (      AdbCommandRejectedException e) {
        LOG.warn(e,"Failed to remove adb forward on port %d for device %s",agentPort,device);
        eventBus.post(ConsoleEvent.warning("Failed to remove adb forward %d. This is not necessarily a problem\n" + "because it will be recreated during the next exopackage installation.\n" + "See the log for the full exception.",agentPort));
      }
    }
  }
 }

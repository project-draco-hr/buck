{
  try (TraceEventLogger ignored=TraceEventLogger.start(eventBus,"prepare_dex_dir")){
    final ImmutableSet.Builder<String> foundHashes=ImmutableSet.builder();
    AdbHelper.executeCommandWithErrorChecking(device,"umask 022 && mkdir -p " + dataRoot + "/secondary-dex");
    String output=AdbHelper.executeCommandWithErrorChecking(device,"ls " + dataRoot + "/secondary-dex");
    ImmutableSet.Builder<String> toDeleteBuilder=ImmutableSet.builder();
    scanSecondaryDexDir(output,requiredHashes,foundHashes,toDeleteBuilder);
    Iterable<String> filesToDelete=toDeleteBuilder.build();
    String commandPrefix="cd " + dataRoot + "/secondary-dex && rm ";
    final int overhead=commandPrefix.length() + 100;
    for (    List<String> rmArgs : chunkArgs(filesToDelete,MAX_ADB_COMMAND_SIZE - overhead)) {
      String command=commandPrefix + Joiner.on(' ').join(rmArgs);
      logFine("Running: %s",command);
      AdbHelper.executeCommandWithErrorChecking(device,command);
    }
    return foundHashes.build();
  }
 }

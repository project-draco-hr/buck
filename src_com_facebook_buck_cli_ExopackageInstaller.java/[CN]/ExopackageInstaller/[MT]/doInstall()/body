{
  Optional<PackageInfo> agentInfo=installAgentIfNecessary();
  if (!agentInfo.isPresent()) {
    return false;
  }
  nativeAgentPath=agentInfo.get().nativeLibPath;
  determineBestAgent();
  final File apk=apkRule.getApkPath().toFile();
  final boolean installViaSd=false;
  if (shouldAppBeInstalled()) {
    try (TraceEventLogger ignored=TraceEventLogger.start(eventBus,"install_exo_apk")){
      Preconditions.checkNotNull(device);
      boolean success=adbHelper.installApkOnDevice(device,apk,installViaSd);
      if (!success) {
        return false;
      }
    }
   }
  final ImmutableMap<String,String> hashToBasename=getRequiredDexFiles();
  final ImmutableSet<String> requiredHashes=hashToBasename.keySet();
  final ImmutableSet<String> presentHashes=prepareSecondaryDexDir(requiredHashes);
  final Set<String> hashesToInstall=Sets.difference(requiredHashes,presentHashes);
  installSecondaryDexFiles(hashesToInstall,hashToBasename);
  try (TraceEventLogger ignored=TraceEventLogger.start(eventBus,"kill_app")){
    AdbHelper.executeCommandWithErrorChecking(device,"am force-stop " + packageName);
  }
   return true;
}

{
  String root="/Users/user/src";
  final Path fakeRoot=Paths.get(root);
  ProjectFilesystem filesystem=new FakeProjectFilesystem(){
    @Override public Path getRootPath(){
      return fakeRoot;
    }
    @Override public Path resolve(    Path relativePath){
      return fakeRoot.resolve(relativePath);
    }
  }
;
  BuildTarget testBuildTarget=BuildTarget.builder(BuildTargetFactory.newInstance("//foo:baz")).addAllFlavors(ImmutableSet.of(CxxCompilationDatabase.COMPILATION_DATABASE)).build();
  BuildRuleParams testBuildRuleParams=new FakeBuildRuleParamsBuilder(testBuildTarget).setProjectFilesystem(filesystem).build();
  BuildRuleResolver testBuildRuleResolver=new BuildRuleResolver();
  SourcePathResolver testSourcePathResolver=new SourcePathResolver(testBuildRuleResolver);
  BuildTarget preprocessTarget=BuildTarget.builder(testBuildRuleParams.getBuildTarget().getUnflavoredBuildTarget()).addFlavors(ImmutableFlavor.of("preprocess-test.cpp")).build();
  BuildRuleParams preprocessBuildRuleParams=new FakeBuildRuleParamsBuilder(preprocessTarget).setProjectFilesystem(filesystem).build();
  CxxPreprocessAndCompile testPreprocessRule=new CxxPreprocessAndCompile(preprocessBuildRuleParams,testSourcePathResolver,CxxPreprocessAndCompileStep.Operation.PREPROCESS,Optional.<Preprocessor>of(new DefaultPreprocessor(new HashedFileTool(Paths.get("compiler")))),Optional.of(ImmutableList.<String>of()),Optional.of(ImmutableList.<String>of()),Optional.<Compiler>absent(),Optional.<ImmutableList<String>>absent(),Optional.<ImmutableList<String>>absent(),Paths.get("test.ii"),new TestSourcePath("test.cpp"),CxxSource.Type.CXX_CPP_OUTPUT,ImmutableSet.of(Paths.get("foo/bar"),Paths.get("test")),ImmutableSet.<Path>of(),ImmutableSet.<Path>of(),ImmutableSet.<Path>of(),Optional.<SourcePath>absent(),ImmutableList.<CxxHeaders>of(),CxxPlatforms.DEFAULT_DEBUG_PATH_SANITIZER);
  BuildTarget compileTarget=BuildTarget.builder(testBuildRuleParams.getBuildTarget().getUnflavoredBuildTarget()).addFlavors(ImmutableFlavor.of("compile-test.cpp")).build();
  BuildRuleParams compileBuildRuleParams=new FakeBuildRuleParamsBuilder(compileTarget).setProjectFilesystem(filesystem).setDeclaredDeps(ImmutableSortedSet.<BuildRule>of(testPreprocessRule)).build();
  CxxPreprocessAndCompile testCompileRule=new CxxPreprocessAndCompile(compileBuildRuleParams,testSourcePathResolver,CxxPreprocessAndCompileStep.Operation.COMPILE,Optional.<Preprocessor>absent(),Optional.<ImmutableList<String>>absent(),Optional.<ImmutableList<String>>absent(),Optional.<Compiler>of(new DefaultCompiler(new HashedFileTool(Paths.get("compiler")))),Optional.of(ImmutableList.<String>of()),Optional.of(ImmutableList.<String>of()),Paths.get("test.o"),new TestSourcePath("test.ii"),CxxSource.Type.CXX_CPP_OUTPUT,ImmutableSet.<Path>of(),ImmutableSet.<Path>of(),ImmutableSet.<Path>of(),ImmutableSet.<Path>of(),Optional.<SourcePath>absent(),ImmutableList.<CxxHeaders>of(),CxxPlatforms.DEFAULT_DEBUG_PATH_SANITIZER);
  CxxCompilationDatabase compilationDatabase=CxxCompilationDatabase.createCompilationDatabase(testBuildRuleParams,testSourcePathResolver,CxxPreprocessMode.SEPARATE,ImmutableSortedSet.of(testPreprocessRule,testCompileRule));
  assertEquals("getPathToOutput() should be a function of the build target.",Paths.get("buck-out/gen/foo/__baz#compilation-database.json"),compilationDatabase.getPathToOutput());
  BuildContext buildContext=FakeBuildContext.NOOP_CONTEXT;
  BuildableContext buildableContext=new FakeBuildableContext();
  List<Step> buildSteps=compilationDatabase.getPostBuildSteps(buildContext,buildableContext);
  assertEquals(2,buildSteps.size());
  assertTrue(buildSteps.get(0) instanceof MkdirStep);
  assertTrue(buildSteps.get(1) instanceof CxxCompilationDatabase.GenerateCompilationCommandsJson);
  CxxCompilationDatabase.GenerateCompilationCommandsJson step=(CxxCompilationDatabase.GenerateCompilationCommandsJson)buildSteps.get(1);
  Iterable<CxxCompilationDatabaseEntry> observedEntries=step.createEntries();
  Iterable<CxxCompilationDatabaseEntry> expectedEntries=ImmutableList.of(CxxCompilationDatabaseEntry.of(root,root + "/test.cpp",ImmutableList.of("compiler","-I","foo/bar","-I","test","-x","c++-cpp-output","-c","-o","test.o","test.cpp")));
  MoreAsserts.assertIterablesEquals(expectedEntries,observedEntries);
}

{
  ImmutableList.Builder<Step> steps=ImmutableList.builder();
  final Path pathToNativeLibs=getPathToNativeLibsDir();
  steps.add(new MakeCleanDirectoryStep(pathToNativeLibs));
  for (  Path nativeLibDir : nativeLibDirectories) {
    copyNativeLibrary(nativeLibDir,pathToNativeLibs,cpuFilters,steps);
  }
  final Path pathToMetadataTxt=getPathToMetadataTxt();
  steps.add(new AbstractExecutionStep("hash_native_libs"){
    @Override public int execute(    ExecutionContext context){
      ProjectFilesystem filesystem=context.getProjectFilesystem();
      ImmutableList.Builder<String> metadataLines=ImmutableList.builder();
      try {
        for (        Path nativeLib : filesystem.getFilesUnderPath(pathToNativeLibs)) {
          String filesha1=filesystem.computeSha1(nativeLib);
          Path relativePath=pathToNativeLibs.relativize(nativeLib);
          metadataLines.add(String.format("%s %s",relativePath.toString(),filesha1));
        }
        filesystem.writeLinesToPath(metadataLines.build(),pathToMetadataTxt);
      }
 catch (      IOException e) {
        context.logError(e,"There was an error hashing native libraries.");
        return 1;
      }
      return 0;
    }
  }
);
  buildableContext.recordArtifactsInDirectory(pathToNativeLibs);
  buildableContext.recordArtifact(pathToMetadataTxt);
  return steps.build();
}

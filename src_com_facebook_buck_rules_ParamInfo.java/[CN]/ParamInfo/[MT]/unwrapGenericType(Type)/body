{
  if (!(type instanceof ParameterizedType)) {
    return (Class<?>)type;
  }
  Type[] types=((ParameterizedType)type).getActualTypeArguments();
  if (types.length != 1) {
    throw new IllegalArgumentException("Unable to determine generic type");
  }
  if (types[0] instanceof WildcardType) {
    WildcardType wild=(WildcardType)types[0];
    if (Object.class.equals(wild.getUpperBounds()[0])) {
      throw new IllegalArgumentException("Generic types must be specific: " + type);
    }
    return Primitives.wrap((Class<?>)wild.getUpperBounds()[0]);
  }
  if (types[0] instanceof ParameterizedType) {
    return unwrapGenericType(types[0]);
  }
  return Primitives.wrap((Class<?>)types[0]);
}

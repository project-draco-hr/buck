{
  Path cacheDir=tmpDir.newFolder();
  Path fileX=tmpDir.newFile("x");
  Path fileY=tmpDir.newFile("y");
  Path fileZ=tmpDir.newFile("z");
  fileHashCache=new FakeFileHashCache(ImmutableMap.of(fileX,HashCode.fromInt(0),fileY,HashCode.fromInt(1),fileZ,HashCode.fromInt(2)));
  dirArtifactCache=new DirArtifactCache("dir",new ProjectFilesystem(cacheDir),cacheDir,true,Optional.of(9L));
  Files.write(fileX,"x".getBytes(UTF_8));
  Files.write(fileY,"y".getBytes(UTF_8));
  Files.write(fileZ,"z".getBytes(UTF_8));
  BuildRule inputRuleX=new BuildRuleForTest(fileX);
  BuildRule inputRuleY=new BuildRuleForTest(fileY);
  BuildRule inputRuleZ=new BuildRuleForTest(fileZ);
  BuildRuleResolver ruleResolver=new BuildRuleResolver(TargetGraph.EMPTY,new DefaultTargetNodeToBuildRuleTransformer());
  ruleResolver.addToIndex(inputRuleX);
  ruleResolver.addToIndex(inputRuleY);
  ruleResolver.addToIndex(inputRuleZ);
  SourcePathResolver resolver=new SourcePathResolver(ruleResolver);
  DefaultRuleKeyBuilderFactory fakeRuleKeyBuilderFactory=new DefaultRuleKeyBuilderFactory(fileHashCache,resolver);
  RuleKey ruleKeyX=fakeRuleKeyBuilderFactory.build(inputRuleX);
  RuleKey ruleKeyY=fakeRuleKeyBuilderFactory.build(inputRuleY);
  RuleKey ruleKeyZ=fakeRuleKeyBuilderFactory.build(inputRuleZ);
  dirArtifactCache.store(ImmutableSet.of(ruleKeyX),ImmutableMap.<String,String>of(),BorrowablePath.notBorrowablePath(fileX));
  assertEquals(CacheResultType.HIT,dirArtifactCache.fetch(ruleKeyX,LazyPath.ofInstance(fileX)).getType());
  Files.setAttribute(dirArtifactCache.getPathForRuleKey(ruleKeyX,Optional.<String>absent()),"lastAccessTime",FileTime.fromMillis(0));
  Files.setAttribute(dirArtifactCache.getPathForRuleKey(ruleKeyX,Optional.of(".metadata")),"lastAccessTime",FileTime.fromMillis(0));
  dirArtifactCache.store(ImmutableSet.of(ruleKeyY),ImmutableMap.<String,String>of(),BorrowablePath.notBorrowablePath(fileY));
  assertEquals(CacheResultType.MISS,dirArtifactCache.fetch(ruleKeyX,LazyPath.ofInstance(fileX)).getType());
  assertEquals(CacheResultType.HIT,dirArtifactCache.fetch(ruleKeyY,LazyPath.ofInstance(fileY)).getType());
  Files.setAttribute(dirArtifactCache.getPathForRuleKey(ruleKeyY,Optional.<String>absent()),"lastAccessTime",FileTime.fromMillis(1000));
  Files.setAttribute(dirArtifactCache.getPathForRuleKey(ruleKeyY,Optional.of(".metadata")),"lastAccessTime",FileTime.fromMillis(1000));
  dirArtifactCache.store(ImmutableSet.of(ruleKeyZ),ImmutableMap.<String,String>of(),BorrowablePath.notBorrowablePath(fileZ));
  assertEquals(CacheResultType.MISS,dirArtifactCache.fetch(ruleKeyX,LazyPath.ofInstance(fileX)).getType());
  assertEquals(CacheResultType.MISS,dirArtifactCache.fetch(ruleKeyY,LazyPath.ofInstance(fileY)).getType());
  assertEquals(CacheResultType.HIT,dirArtifactCache.fetch(ruleKeyZ,LazyPath.ofInstance(fileZ)).getType());
}

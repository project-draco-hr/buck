{
  ImmutableList.Builder<Step> stepsBuilder=ImmutableList.builder();
  Path metadataPath=bundleRoot.resolve(this.destinations.getMetadataPath());
  stepsBuilder.add(new MakeCleanDirectoryStep(bundleRoot),new MkdirStep(metadataPath),new WriteFileStep("APPLWRUN",metadataPath.resolve("PkgInfo")),new FindAndReplaceStep(getResolver().getPath(infoPlist.get()),metadataPath.resolve("Info.plist"),InfoPlistSubstitution.createVariableExpansionFunction(withDefaults(infoPlistSubstitutions,ImmutableMap.of("EXECUTABLE_NAME",binaryName,"PRODUCT_NAME",binaryName)))));
  if (binary.isPresent()) {
    stepsBuilder.add(new MkdirStep(bundleRoot.resolve(this.destinations.getExecutablesPath())));
    stepsBuilder.add(CopyStep.forFile(binary.get().getPathToOutputFile(),bundleRoot.resolve(binaryPath)));
  }
  for (  Path dir : resourceDirs) {
    Path bundleDestinationPath=bundleRoot.resolve(this.destinations.getResourcesPath());
    stepsBuilder.add(new MkdirStep(bundleDestinationPath));
    stepsBuilder.add(CopyStep.forDirectory(dir,bundleDestinationPath,CopyStep.DirectoryMode.DIRECTORY_AND_CONTENTS));
  }
  for (  SourcePath file : resourceFiles) {
    Path bundleDestinationPath=bundleRoot.resolve(this.destinations.getResourcesPath());
    stepsBuilder.add(new MkdirStep(bundleDestinationPath));
    Path resolvedFilePath=getResolver().getPath(file);
    Path destinationPath=bundleDestinationPath.resolve(resolvedFilePath.getFileName());
    addResourceProcessingSteps(resolvedFilePath,destinationPath,stepsBuilder);
  }
  for (  AppleAssetCatalog bundledAssetCatalog : bundledAssetCatalogs) {
    Path bundleDir=bundledAssetCatalog.getOutputDir();
    stepsBuilder.add(CopyStep.forDirectory(bundleDir,bundleRoot,CopyStep.DirectoryMode.DIRECTORY_AND_CONTENTS));
  }
  if (mergedAssetCatalog.isPresent()) {
    Path bundleDir=mergedAssetCatalog.get().getOutputDir();
    stepsBuilder.add(CopyStep.forDirectory(bundleDir,bundleRoot,CopyStep.DirectoryMode.CONTENTS_ONLY));
  }
  buildableContext.recordArtifactsInDirectory(bundleRoot);
  stepsBuilder.add(new RmStep(outputZipPath,true));
  stepsBuilder.add(new ZipStep(outputZipPath,ImmutableSet.<Path>of(),false,ZipStep.MIN_COMPRESSION_LEVEL,bundleRoot));
  return stepsBuilder.build();
}

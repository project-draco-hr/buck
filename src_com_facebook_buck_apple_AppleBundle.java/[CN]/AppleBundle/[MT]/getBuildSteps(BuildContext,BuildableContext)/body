{
  ImmutableList.Builder<Step> stepsBuilder=ImmutableList.builder();
  Path metadataPath=getMetadataPath();
  Path infoPlistInputPath=getResolver().getPath(infoPlist.get());
  Path infoPlistSubstitutionTempPath=BuildTargets.getScratchPath(getBuildTarget(),"%s.plist");
  Path infoPlistOutputPath=metadataPath.resolve("Info.plist");
  stepsBuilder.add(new MakeCleanDirectoryStep(bundleRoot),new MkdirStep(metadataPath),new WriteFileStep("APPLWRUN",metadataPath.resolve("PkgInfo")),new FindAndReplaceStep(infoPlistInputPath,infoPlistSubstitutionTempPath,InfoPlistSubstitution.createVariableExpansionFunction(withDefaults(infoPlistSubstitutions,ImmutableMap.of("EXECUTABLE_NAME",binaryName,"PRODUCT_NAME",binaryName)))),new PlistProcessStep(infoPlistSubstitutionTempPath,infoPlistOutputPath,getInfoPlistAdditionalKeys(platformName,sdkName),getInfoPlistOverrideKeys(platformName)));
  if (binary.isPresent()) {
    stepsBuilder.add(new MkdirStep(bundleRoot.resolve(this.destinations.getExecutablesPath())));
    Path bundleBinaryPath=bundleRoot.resolve(binaryPath);
    stepsBuilder.add(CopyStep.forFile(binary.get().getPathToOutput(),bundleBinaryPath));
    stepsBuilder.add(new DsymStep(dsymutil.getCommandPrefix(getResolver()),bundleBinaryPath,bundleBinaryPath.resolveSibling(bundleBinaryPath.getFileName().toString() + ".dSYM")));
  }
  Path bundleDestinationPath=bundleRoot.resolve(this.destinations.getResourcesPath());
  for (  SourcePath dir : resourceDirs) {
    stepsBuilder.add(new MkdirStep(bundleDestinationPath));
    stepsBuilder.add(CopyStep.forDirectory(getResolver().getPath(dir),bundleDestinationPath,CopyStep.DirectoryMode.DIRECTORY_AND_CONTENTS));
  }
  for (  SourcePath dir : dirsContainingResourceDirs) {
    stepsBuilder.add(new MkdirStep(bundleDestinationPath));
    stepsBuilder.add(CopyStep.forDirectory(getResolver().getPath(dir),bundleDestinationPath,CopyStep.DirectoryMode.CONTENTS_ONLY));
  }
  for (  SourcePath file : resourceFiles) {
    stepsBuilder.add(new MkdirStep(bundleDestinationPath));
    Path resolvedFilePath=getResolver().getPath(file);
    Path destinationPath=bundleDestinationPath.resolve(resolvedFilePath.getFileName());
    addResourceProcessingSteps(resolvedFilePath,destinationPath,stepsBuilder);
  }
  for (  AppleAssetCatalog bundledAssetCatalog : bundledAssetCatalogs) {
    Path bundleDir=bundledAssetCatalog.getOutputDir();
    stepsBuilder.add(CopyStep.forDirectory(bundleDir,bundleRoot,CopyStep.DirectoryMode.DIRECTORY_AND_CONTENTS));
  }
  if (mergedAssetCatalog.isPresent()) {
    Path bundleDir=mergedAssetCatalog.get().getOutputDir();
    stepsBuilder.add(CopyStep.forDirectory(bundleDir,bundleRoot,CopyStep.DirectoryMode.CONTENTS_ONLY));
  }
  buildableContext.recordArtifact(bundleRoot);
  return stepsBuilder.build();
}

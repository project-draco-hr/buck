{
  final String basePathForRule=rule.getBuildTarget().getBasePath();
  new AbstractDependencyVisitor(rule,true){
    private final LinkedHashSet<DependentModule> librariesToAdd=Sets.newLinkedHashSet();
    private final LinkedHashSet<DependentModule> modulesToAdd=Sets.newLinkedHashSet();
    @Override public boolean visit(    BuildRule dep){
      boolean depShouldExportDeps=dep.getExportDeps() || rule.getProperties().is(PACKAGING);
      boolean shouldVisitDeps=(dep.getProperties().is(LIBRARY) && (depShouldExportDeps)) || (dep instanceof AndroidResourceRule) || dep == rule;
      if (isForTests && !shouldVisitDeps && dep.getBuildTarget().getBasePath().equals(basePathForRule)&& !dep.equals(srcTarget)) {
        shouldVisitDeps=true;
      }
      DependentModule dependentModule;
      if (dep instanceof PrebuiltJarRule) {
        libraryJars.add((PrebuiltJarRule)dep);
        String libraryName=getIntellijNameForRule(dep);
        dependentModule=DependentModule.newLibrary(dep.getBuildTarget(),libraryName);
      }
 else       if (dep instanceof NdkLibrary) {
        String moduleName=getIntellijNameForRule(dep);
        dependentModule=DependentModule.newModule(dep.getBuildTarget(),moduleName);
      }
 else       if (dep.getFullyQualifiedName().startsWith(ANDROID_GEN_BUILD_TARGET_PREFIX)) {
        return shouldVisitDeps;
      }
 else       if (dep instanceof JavaLibraryRule) {
        String moduleName=getIntellijNameForRule(dep);
        dependentModule=DependentModule.newModule(dep.getBuildTarget(),moduleName);
      }
 else       if (dep instanceof AndroidResourceRule) {
        String moduleName=getIntellijNameForRule(dep);
        dependentModule=DependentModule.newModule(dep.getBuildTarget(),moduleName);
      }
 else       if (dep.getBuildable() instanceof GenAidl) {
        return shouldVisitDeps;
      }
 else {
        return shouldVisitDeps;
      }
      if (isForTests) {
        dependentModule.scope="TEST";
      }
 else {
        String currentScope=dependentModule.scope;
        dependentModule.scope="TEST";
        if (dependencies.contains(dependentModule)) {
          dependencies.remove(dependentModule);
        }
        dependentModule.scope=currentScope;
      }
      if (dependentModule.isLibrary()) {
        librariesToAdd.add(dependentModule);
      }
 else {
        modulesToAdd.add(dependentModule);
      }
      return shouldVisitDeps;
    }
    @Override protected void onComplete(){
      dependencies.addAll(librariesToAdd);
      dependencies.addAll(modulesToAdd);
    }
  }
.start();
}

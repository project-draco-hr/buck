{
  BuildRuleResolver buildRuleResolver=new BuildRuleResolver();
  ProjectFilesystem projectFilesystem=new ProjectFilesystem(new File("."));
  RuleKeyBuilderFactory ruleKeyBuilderFactory=new FakeRuleKeyBuilderFactory();
  AbstractBuildRuleBuilderParams params=new DefaultBuildRuleBuilderParams(projectFilesystem,ruleKeyBuilderFactory);
  DefaultJavaLibraryRule.Builder builder1=DefaultJavaLibraryRule.newJavaLibraryRuleBuilder(params);
  BuildTarget buildTarget=new BuildTarget("//foo","bar");
  builder1.setBuildTarget(buildTarget);
  buildRuleResolver.buildAndAddToIndex(builder1);
  DefaultJavaLibraryRule.Builder builder2=DefaultJavaLibraryRule.newJavaLibraryRuleBuilder(params);
  builder2.setBuildTarget(buildTarget);
  try {
    buildRuleResolver.buildAndAddToIndex(builder2);
    fail("Should throw IllegalStateException.");
  }
 catch (  IllegalStateException e) {
    assertEquals("A build rule for this target has already been created: " + buildTarget,e.getMessage());
  }
}

{
  ImmutableList.Builder<Step> commands=ImmutableList.builder();
  commands.add(new RmStep(getPathToOutputFile(),true));
  commands.add(new MkdirStep(pathToOutDirectory));
  commands.add(new MakeCleanDirectoryStep(pathToTmpDirectory));
  commands.add(new MakeCleanDirectoryStep(pathToSrcDirectory));
  addSymlinkCommands(commands);
  commands.add(new ShellStep(){
    private String command;
    @Override public String getShortName(    ExecutionContext context){
      buildCmd(context.getProjectFilesystem(),cmd);
      return String.format("genrule: %s",command);
    }
    @Override protected ImmutableList<String> getShellCommandInternal(    ExecutionContext context){
      buildCmd(context.getProjectFilesystem(),cmd);
      return ImmutableList.of("/bin/bash","-c",command);
    }
    @Override public ImmutableMap<String,String> getEnvironmentVariables(    ExecutionContext context){
      ImmutableMap.Builder<String,String> environmentVariablesBuilder=ImmutableMap.builder();
      addEnvironmentVariables(context,environmentVariablesBuilder);
      return environmentVariablesBuilder.build();
    }
    @Override protected boolean shouldPrintStdErr(    ExecutionContext context){
      return true;
    }
    private void buildCmd(    ProjectFilesystem filesystem,    String cmd){
      if (command != null) {
        return;
      }
      command=replaceMatches(filesystem,cmd);
    }
  }
);
  return commands.build();
}

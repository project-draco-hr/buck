{
  ImmutableList.Builder<Step> commands=ImmutableList.builder();
  commands.add(new RmStep(getPathToOutputFile(),true));
  commands.add(new MkdirStep(outDirectory));
  commands.add(new MakeCleanDirectoryStep(tmpDirectory));
  commands.add(new MakeCleanDirectoryStep(srcDirectory));
  addSymlinkCommands(commands);
  final String cmd=replaceBinaryBuildRuleRefsInCmd();
  final ImmutableList<String> commandArgs=ImmutableList.of("/bin/bash","-c",cmd);
  ImmutableMap.Builder<String,String> environmentVariablesBuilder=ImmutableMap.builder();
  addEnvironmentVariables(environmentVariablesBuilder);
  final ImmutableMap<String,String> environmentVariables=environmentVariablesBuilder.build();
  commands.add(new ShellStep(){
    @Override public String getShortName(    ExecutionContext context){
      return String.format("genrule: %s",cmd);
    }
    @Override protected ImmutableList<String> getShellCommandInternal(    ExecutionContext context){
      return commandArgs;
    }
    @Override public ImmutableMap<String,String> getEnvironmentVariables(){
      return environmentVariables;
    }
    @Override protected boolean shouldPrintStdErr(    ExecutionContext context){
      return true;
    }
  }
);
  return commands.build();
}

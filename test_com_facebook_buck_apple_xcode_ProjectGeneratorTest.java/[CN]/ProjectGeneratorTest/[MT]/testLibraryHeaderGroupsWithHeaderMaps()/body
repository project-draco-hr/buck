{
  BuildRuleParams params=new FakeBuildRuleParamsBuilder(BuildTarget.builder("//foo","lib").build()).setType(AppleLibraryDescription.TYPE).build();
  AppleNativeTargetDescriptionArg arg=createDescriptionArgWithDefaults(appleLibraryDescription);
  arg.configs=Optional.of(ImmutableSortedMap.of("Debug",new XcodeRuleConfiguration(ImmutableList.<XcodeRuleConfigurationLayer>of())));
  arg.srcs=Optional.of(ImmutableList.of(AppleSource.ofSourceGroup(new Pair<>("HeaderGroup1",ImmutableList.of(AppleSource.ofSourcePath(new TestSourcePath("foo.h")),AppleSource.ofSourcePathWithFlags(new Pair<SourcePath,String>(new TestSourcePath("bar.h"),"public"))))),AppleSource.ofSourceGroup(new Pair<>("HeaderGroup2",ImmutableList.of(AppleSource.ofSourcePath(new TestSourcePath("baz.h")))))));
  arg.useBuckHeaderMaps=Optional.of(true);
  BuildRule rule=appleLibraryDescription.createBuildRule(params,new BuildRuleResolver(),arg);
  ProjectGenerator projectGenerator=createProjectGeneratorForCombinedProject(ImmutableSet.of(rule),ImmutableSet.of(rule.getBuildTarget()));
  projectGenerator.createXcodeProjects();
  PBXProject project=projectGenerator.getGeneratedProject();
  PBXGroup targetGroup=project.getMainGroup().getOrCreateChildGroupByName(rule.getFullyQualifiedName());
  PBXGroup sourcesGroup=targetGroup.getOrCreateChildGroupByName("Sources");
  assertThat(sourcesGroup.getChildren(),hasSize(2));
  PBXGroup group1=(PBXGroup)Iterables.get(sourcesGroup.getChildren(),0);
  assertEquals("HeaderGroup1",group1.getName());
  assertThat(group1.getChildren(),hasSize(2));
  PBXFileReference fileRefFoo=(PBXFileReference)Iterables.get(group1.getChildren(),0);
  assertEquals("foo.h",fileRefFoo.getName());
  PBXFileReference fileRefBar=(PBXFileReference)Iterables.get(group1.getChildren(),1);
  assertEquals("bar.h",fileRefBar.getName());
  PBXGroup group2=(PBXGroup)Iterables.get(sourcesGroup.getChildren(),1);
  assertEquals("HeaderGroup2",group2.getName());
  assertThat(group2.getChildren(),hasSize(1));
  PBXFileReference fileRefBaz=(PBXFileReference)Iterables.get(group2.getChildren(),0);
  assertEquals("baz.h",fileRefBaz.getName());
  PBXTarget target=assertTargetExistsAndReturnTarget(project,"//foo:lib");
  assertEquals(Optional.<PBXBuildPhase>absent(),Iterables.tryFind(target.getBuildPhases(),new Predicate<PBXBuildPhase>(){
    @Override public boolean apply(    PBXBuildPhase input){
      return input instanceof PBXHeadersBuildPhase;
    }
  }
));
  List<Path> headerMaps=projectGenerator.getGeneratedHeaderMaps();
  assertThat(headerMaps,hasSize(3));
  assertEquals("buck-out/gen/foo/lib-public-headers.hmap",headerMaps.get(0).toString());
  assertThatHeaderMapFileContains("buck-out/gen/foo/lib-public-headers.hmap",ImmutableMap.<String,String>of("lib/bar.h","bar.h"));
  assertEquals("buck-out/gen/foo/lib-target-headers.hmap",headerMaps.get(1).toString());
  assertThatHeaderMapFileContains("buck-out/gen/foo/lib-target-headers.hmap",ImmutableMap.<String,String>of("lib/foo.h","foo.h","lib/bar.h","bar.h","lib/baz.h","baz.h"));
  assertEquals("buck-out/gen/foo/lib-target-user-headers.hmap",headerMaps.get(2).toString());
  assertThatHeaderMapFileContains("buck-out/gen/foo/lib-target-user-headers.hmap",ImmutableMap.<String,String>of("foo.h","foo.h","bar.h","bar.h","baz.h","baz.h"));
}

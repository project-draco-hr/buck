{
  final ImmutableSet.Builder<BuildTarget> requiredBuildTargets=ImmutableSet.builder();
  IjLibraryFactory libraryFactory=new DefaultIjLibraryFactory(new DefaultIjLibraryFactory.IjLibraryFactoryResolver(){
    @Override public Path getPath(    SourcePath path){
      Optional<BuildRule> rule=sourcePathResolver.getRule(path);
      if (rule.isPresent()) {
        requiredBuildTargets.add(rule.get().getBuildTarget());
      }
      return sourcePathResolver.getPath(path);
    }
    @Override public Optional<Path> getPathIfJavaLibrary(    TargetNode<?> targetNode){
      BuildRule rule=buildRuleResolver.getRule(targetNode.getBuildTarget());
      if (!(rule instanceof JavaLibrary)) {
        return Optional.absent();
      }
      requiredBuildTargets.add(rule.getBuildTarget());
      return Optional.fromNullable(rule.getPathToOutput());
    }
  }
);
  IjModuleFactory moduleFactory=new IjModuleFactory(new Function<TargetNode<?>,Optional<Path>>(){
    @Override public Optional<Path> apply(    TargetNode<?> targetNode){
      BuildTarget dummyRDotJavaTarget=AndroidLibraryGraphEnhancer.getDummyRDotJavaTarget(targetNode.getBuildTarget());
      Optional<BuildRule> dummyRDotJavaRule=buildRuleResolver.getRuleOptional(dummyRDotJavaTarget);
      if (dummyRDotJavaRule.isPresent()) {
        requiredBuildTargets.add(dummyRDotJavaTarget);
        return Optional.of(DummyRDotJava.getRDotJavaBinFolder(dummyRDotJavaTarget));
      }
      return Optional.absent();
    }
  }
);
  IjModuleGraph moduleGraph=IjModuleGraph.from(targetGraphAndTargets.getTargetGraph(),libraryFactory,moduleFactory,aggregationMode);
  JavaPackageFinder parsingJavaPackageFinder=ParsingJavaPackageFinder.preparse(javaFileParser,projectFilesystem,IjProjectTemplateDataPreparer.createPackageLookupPathSet(moduleGraph),javaPackageFinder);
  IjProjectWriter writer=new IjProjectWriter(new IjProjectTemplateDataPreparer(parsingJavaPackageFinder,moduleGraph,projectFilesystem),projectFilesystem);
  writer.write();
  return requiredBuildTargets.build();
}

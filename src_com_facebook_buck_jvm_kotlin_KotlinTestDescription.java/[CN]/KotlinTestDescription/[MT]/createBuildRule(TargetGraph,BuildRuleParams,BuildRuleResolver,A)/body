{
  SourcePathResolver pathResolver=new SourcePathResolver(resolver);
  BuildTarget abiJarTarget=BuildTarget.builder(params.getBuildTarget()).addFlavors(CalculateAbi.FLAVOR).build();
  KotlincToJarStepFactory stepFactory=new KotlincToJarStepFactory(kotlinBuckConfig.getKotlinCompiler().get(),args.extraKotlincArguments.get());
  JavaLibrary testsLibrary=resolver.addToIndex(new DefaultJavaLibrary(params.appendExtraDeps(Iterables.concat(BuildRules.getExportedRules(Iterables.concat(params.getDeclaredDeps().get(),resolver.getAllRules(args.providedDeps.get()))),pathResolver.filterBuildRuleInputs(defaultJavacOptions.getInputs(pathResolver)))).withFlavor(JavaTest.COMPILED_TESTS_LIBRARY_FLAVOR),pathResolver,args.srcs.get(),ResourceValidator.validateResources(pathResolver,params.getProjectFilesystem(),args.resources.get()),defaultJavacOptions.getGeneratedSourceFolderName(),Optional.<SourcePath>absent(),ImmutableList.<String>of(),ImmutableSortedSet.<BuildRule>of(),ImmutableSortedSet.<BuildRule>of(),new BuildTargetSourcePath(abiJarTarget),false,ImmutableSet.<Path>of(),stepFactory,Optional.<Path>absent(),Optional.<String>absent(),ImmutableSortedSet.<BuildTarget>of(),ImmutableSet.<Pattern>of()));
  JavaTest test=resolver.addToIndex(new JavaTest(params.copyWithDeps(Suppliers.ofInstance(ImmutableSortedSet.<BuildRule>of(testsLibrary)),Suppliers.ofInstance(ImmutableSortedSet.<BuildRule>of())),pathResolver,testsLibrary,ImmutableSet.<Path>of(),args.labels.get(),args.contacts.get(),args.testType.or(TestType.JUNIT),javaOptions.getJavaRuntimeLauncher(),args.vmArgs.get(),ImmutableMap.<String,String>of(),args.testRuleTimeoutMs.or(defaultTestRuleTimeoutMs),args.env.get(),args.getRunTestSeparately(),args.getForkMode(),args.stdOutLogLevel,args.stdErrLogLevel));
  resolver.addToIndex(CalculateAbi.of(abiJarTarget,pathResolver,params,new BuildTargetSourcePath(test.getBuildTarget())));
  return test;
}

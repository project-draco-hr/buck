{
  LOG.debug("Preprocessing %s -> %s",input,output);
  ProcessBuilder builder=new ProcessBuilder();
  builder.command(getCommand());
  builder.directory(context.getProjectDirectoryRoot().toAbsolutePath().toFile());
  builder.redirectOutput(ProcessBuilder.Redirect.PIPE);
  builder.redirectError(ProcessBuilder.Redirect.PIPE);
  Path outputPath=context.getProjectFilesystem().resolve(this.output);
  Path outputTempPath=context.getProjectFilesystem().resolve(this.output + ".tmp");
  try {
    LOG.debug("Running command (pwd=%s): %s",builder.directory(),Joiner.on(' ').join(Iterables.transform(builder.command(),Escaper.BASH_ESCAPER)));
    Process process=builder.start();
    ByteArrayOutputStream error=new ByteArrayOutputStream();
    int exitCode;
    try (OutputStream output=Files.newOutputStream(outputTempPath);FunctionLineProcessorThread outputProcessor=new FunctionLineProcessorThread(process.getInputStream(),output,createOutputLineProcessor(context.getProjectDirectoryRoot(),replacementPaths,sanitizer));FunctionLineProcessorThread errorProcessor=new FunctionLineProcessorThread(process.getErrorStream(),error,createErrorLineProcessor())){
      outputProcessor.start();
      errorProcessor.start();
      exitCode=process.waitFor();
    }
  finally {
      process.destroy();
      process.waitFor();
    }
    if (exitCode == 0) {
      Files.move(outputTempPath,outputPath,StandardCopyOption.REPLACE_EXISTING,StandardCopyOption.ATOMIC_MOVE);
    }
    String err=new String(error.toByteArray());
    if (!err.isEmpty()) {
      context.getConsole().printErrorText(err);
    }
    if (exitCode != 0) {
      LOG.warn("Error %d preprocessing %s: %s",exitCode,input,err);
    }
    return exitCode;
  }
 catch (  Exception e) {
    MoreThrowables.propagateIfInterrupt(e);
    context.getConsole().printBuildFailureWithStacktrace(e);
    return 1;
  }
}

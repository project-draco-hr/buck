{
  FakeProjectFilesystem filesystem=new FakeProjectFilesystem();
  FileHashCache fileHashCache=DefaultFileHashCache.createDefaultFileHashCache(filesystem);
  BuildInfoRecorder buildInfoRecorder=createBuildInfoRecorder(filesystem);
  byte[] contents="contents".getBytes();
  Path file=Paths.get("file");
  filesystem.writeBytesToPath(contents,file);
  buildInfoRecorder.recordArtifact(file);
  Path dir=Paths.get("dir");
  filesystem.mkdirs(dir);
  filesystem.writeBytesToPath(contents,dir.resolve("file1"));
  filesystem.writeBytesToPath(contents,dir.resolve("file2"));
  buildInfoRecorder.recordArtifact(dir);
  fileHashCache.invalidateAll();
  HashCode current=buildInfoRecorder.getOutputHash(fileHashCache);
  fileHashCache.invalidateAll();
  assertEquals(current,buildInfoRecorder.getOutputHash(fileHashCache));
  filesystem.writeContentsToPath("something else",file);
  fileHashCache.invalidateAll();
  HashCode updated=buildInfoRecorder.getOutputHash(fileHashCache);
  assertNotEquals(current,updated);
  filesystem.writeContentsToPath("something else",dir.resolve("file1"));
  current=updated;
  fileHashCache.invalidateAll();
  updated=buildInfoRecorder.getOutputHash(fileHashCache);
  assertNotEquals(current,updated);
  Path added=Paths.get("added");
  filesystem.writeBytesToPath(contents,added);
  buildInfoRecorder.recordArtifact(added);
  current=updated;
  fileHashCache.invalidateAll();
  updated=buildInfoRecorder.getOutputHash(fileHashCache);
  assertNotEquals(current,updated);
  Path addedUnderDir=dir.resolve("added");
  filesystem.writeBytesToPath(contents,addedUnderDir);
  current=updated;
  fileHashCache.invalidateAll();
  updated=buildInfoRecorder.getOutputHash(fileHashCache);
  assertNotEquals(current,updated);
}

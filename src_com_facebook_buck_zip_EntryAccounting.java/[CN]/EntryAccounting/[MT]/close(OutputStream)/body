{
  if (!isDeflated()) {
    return 0;
  }
  deflater.finish();
  while (!deflater.finished()) {
    deflate(out);
  }
  entry.setSize(deflater.getBytesRead());
  entry.setCompressedSize(deflater.getBytesWritten());
  calculateCrc();
  deflater.end();
  byte[] closeBytes=close();
  out.write(closeBytes);
  return entry.getCompressedSize() + closeBytes.length;
}

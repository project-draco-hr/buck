{
  if (method == Method.STORE) {
    deflater.end();
    return 0;
  }
  deflater.finish();
  while (!deflater.finished()) {
    deflate(out);
  }
  entry.setSize(deflater.getBytesRead());
  entry.setCompressedSize(deflater.getBytesWritten());
  entry.setCrc(calculateCrc());
  deflater.end();
  byte[] dataDescriptor=getDataDescriptor();
  out.write(dataDescriptor);
  return entry.getCompressedSize() + dataDescriptor.length;
}

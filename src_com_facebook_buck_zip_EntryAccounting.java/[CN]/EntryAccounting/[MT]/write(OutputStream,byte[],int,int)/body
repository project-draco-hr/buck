{
  updateCrc(b,off,len);
  if (!isDeflated()) {
    out.write(b,off,len);
    return len;
  }
  if (len == 0) {
    return 0;
  }
  Preconditions.checkState(!deflater.finished());
  deflater.setInput(b,off,len);
  while (!deflater.needsInput()) {
    deflate(out);
  }
  return 0;
}

{
  final MutableDirectedGraph<BuildRule> actionGraph=new MutableDirectedGraph<>();
  final TargetNodeToBuildRuleTransformer transformer=new TargetNodeToBuildRuleTransformer();
  AbstractBottomUpTraversal<TargetNode<?>,ActionGraph> bottomUpTraversal=new AbstractBottomUpTraversal<TargetNode<?>,ActionGraph>(this){
    @Override public void visit(    TargetNode<?> node){
      BuildRule rule;
      try {
        rule=transformer.transform(ruleResolver,node);
      }
 catch (      NoSuchBuildTargetException e) {
        throw new HumanReadableException(e);
      }
      ruleResolver.addToIndex(rule);
      actionGraph.addNode(rule);
      for (      BuildRule buildRule : rule.getDeps()) {
        if (buildRule.getBuildTarget().isFlavored()) {
          addGraphEnhancedDeps(rule);
        }
      }
      for (      BuildRule dep : rule.getDeps()) {
        actionGraph.addEdge(rule,dep);
      }
    }
    @Override public ActionGraph getResult(){
      return new ActionGraph(actionGraph);
    }
    private void addGraphEnhancedDeps(    BuildRule rule){
      new AbstractDependencyVisitor(rule){
        @Override public ImmutableSet<BuildRule> visit(        BuildRule rule){
          ImmutableSet.Builder<BuildRule> depsToVisit=null;
          boolean isRuleFlavored=rule.getBuildTarget().isFlavored();
          for (          BuildRule dep : rule.getDeps()) {
            boolean isDepFlavored=dep.getBuildTarget().isFlavored();
            if (isRuleFlavored || isDepFlavored) {
              actionGraph.addEdge(rule,dep);
            }
            if (isDepFlavored) {
              if (depsToVisit == null) {
                depsToVisit=ImmutableSet.builder();
              }
              depsToVisit.add(dep);
            }
          }
          return depsToVisit == null ? ImmutableSet.<BuildRule>of() : depsToVisit.build();
        }
      }
.start();
    }
  }
;
  Iterable<BuildTarget> buildTargets=FluentIterable.from(getNodesWithNoIncomingEdges()).transform(new Function<TargetNode<?>,BuildTarget>(){
    @Override public BuildTarget apply(    TargetNode<?> input){
      return input.getBuildTarget();
    }
  }
);
  eventBus.post(ActionGraphEvent.started(buildTargets));
  bottomUpTraversal.traverse();
  eventBus.post(ActionGraphEvent.finished(buildTargets));
  return bottomUpTraversal.getResult();
}

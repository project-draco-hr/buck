{
  ConcurrencyLimit concurrencyLimit=new ConcurrencyLimit(getNumTestThreads(params.getBuckConfig()),params.getBuckConfig().getLoadLimit());
  try (CommandThreadManager testPool=new CommandThreadManager("Test-Run",concurrencyLimit)){
    TestRunningOptions options=TestRunningOptions.builder().setUsingOneTimeOutputDirectories(isUsingOneTimeOutput).setCodeCoverageEnabled(isCodeCoverageEnabled).setRunAllTests(isRunAllTests()).setTestSelectorList(testSelectorOptions.getTestSelectorList()).setShouldExplainTestSelectorList(testSelectorOptions.shouldExplain()).setIgnoreFailingDependencies(isIgnoreFailingDependencies).setResultsCacheEnabled(isResultsCacheEnabled(params.getBuckConfig())).setDryRun(isDryRun).setShufflingTests(isShufflingTests).setPathToXmlTestOutput(Optional.fromNullable(pathToXmlTestOutput)).setPathToJavaAgent(Optional.fromNullable(pathToJavaAgent)).setCoverageReportFormat(coverageReportFormat).setCoverageReportTitle(coverageReportTitle).build();
    return TestRunning.runTests(params,testRules,Preconditions.checkNotNull(build.getBuildContext()),build.getExecutionContext(),options,testPool.getExecutor(),buildEngine,new DefaultStepRunner(build.getExecutionContext()));
  }
 catch (  ExecutionException e) {
    params.getConsole().printBuildFailureWithoutStacktrace(e);
    return 1;
  }
}

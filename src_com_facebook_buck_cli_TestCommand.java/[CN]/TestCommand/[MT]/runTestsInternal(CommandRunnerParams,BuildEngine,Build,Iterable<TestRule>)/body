{
  ConcurrencyLimit concurrencyLimit=new ConcurrencyLimit(getNumTestThreads(params.getBuckConfig()),params.getBuckConfig().getLoadLimit());
  try (CommandThreadManager testPool=new CommandThreadManager("Test-Run",concurrencyLimit)){
    return TestRunning.runTests(params,testRules,Preconditions.checkNotNull(build.getBuildContext()),build.getExecutionContext(),getTestRunningOptions(params),testPool.getExecutor(),buildEngine,new DefaultStepRunner(build.getExecutionContext()));
  }
 catch (  ExecutionException e) {
    params.getConsole().printBuildFailureWithoutStacktrace(e);
    return 1;
  }
}

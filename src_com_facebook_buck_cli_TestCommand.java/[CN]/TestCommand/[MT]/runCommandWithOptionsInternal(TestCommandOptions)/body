{
  if (options.isRunAllTests()) {
    try {
      return runAllTests(options);
    }
 catch (    BuildTargetException|BuildFileParseException|ExecutionException e) {
      console.printBuildFailureWithoutStacktrace(e);
      return 1;
    }
  }
  BuildCommand buildCommand=new BuildCommand(getCommandRunnerParams());
  int exitCode=buildCommand.runCommandWithOptions(options);
  if (exitCode != 0) {
    return exitCode;
  }
  Build build=buildCommand.getBuild();
  Iterable<TestRule> results=getCandidateRules(build.getActionGraph());
  results=filterTestRules(options,results);
  if (options.isDryRun()) {
    printMatchingTestRules(console,results);
  }
  BuildContext buildContext=Preconditions.checkNotNull(build.getBuildContext());
  ExecutionContext buildExecutionContext=build.getExecutionContext();
  ExecutionContext testExecutionContext=ExecutionContext.builder().setExecutionContext(buildExecutionContext).setTargetDevice(options.getTargetDeviceOptional()).build();
  try {
    return runTestsAndShutdownExecutor(results,buildContext,testExecutionContext,options);
  }
 catch (  ExecutionException e) {
    console.printBuildFailureWithoutStacktrace(e);
    return 1;
  }
}

{
  ImmutableSet<BuildTarget> explicitBuildTargets=options.isRunAllTests() ? ImmutableSet.<BuildTarget>of() : getBuildTargets(options.getArgumentsFormattedAsBuildTargets());
  if (getParser().getParseStartTime().isPresent()) {
    getBuckEventBus().post(BuildEvent.started(explicitBuildTargets),getParser().getParseStartTime().get());
  }
 else {
    getBuckEventBus().post(BuildEvent.started(explicitBuildTargets));
  }
  ParserConfig parserConfig=new ParserConfig(options.getBuckConfig());
  TargetGraph targetGraph;
  try {
    if (options.isRunAllTests()) {
      targetGraph=getParser().buildTargetGraphForTargetNodeSpecs(ImmutableList.of(new TargetNodePredicateSpec(new Predicate<TargetNode<?>>(){
        @Override public boolean apply(        TargetNode<?> input){
          return input.getType().isTestRule();
        }
      }
,getProjectFilesystem().getIgnorePaths())),parserConfig,getBuckEventBus(),console,environment,options.getEnableProfiling());
    }
 else {
      targetGraph=getParser().buildTargetGraphForBuildTargets(explicitBuildTargets,parserConfig,getBuckEventBus(),console,environment,options.getEnableProfiling());
    }
  }
 catch (  BuildTargetException|BuildFileParseException e) {
    console.printBuildFailureWithoutStacktrace(e);
    return 1;
  }
  ActionGraph graph=targetGraphTransformer.apply(targetGraph);
  Iterable<TestRule> testRules=Iterables.filter(graph.getNodes(),TestRule.class);
  if (!options.isBuildFiltered()) {
    testRules=filterTestRules(options,testRules);
  }
  if (options.isDryRun()) {
    printMatchingTestRules(console,testRules);
  }
  ArtifactCache artifactCache=getArtifactCache();
  try (CommandThreadManager pool=new CommandThreadManager("Test",options.getNumThreads())){
    CachingBuildEngine cachingBuildEngine=new CachingBuildEngine(pool.getExecutor(),options.getBuckConfig().getSkipLocalBuildChainDepth().or(1L));
    try (Build build=options.createBuild(options.getBuckConfig(),graph,getProjectFilesystem(),getAndroidPlatformTargetSupplier(),cachingBuildEngine,artifactCache,console,getBuckEventBus(),options.getTargetDeviceOptional(),getCommandRunnerParams().getPlatform(),getCommandRunnerParams().getEnvironment(),getCommandRunnerParams().getObjectMapper(),getCommandRunnerParams().getClock())){
      int exitCode=build.executeAndPrintFailuresToConsole(testRules,options.isKeepGoing(),console,options.getPathToBuildReport());
      getBuckEventBus().post(BuildEvent.finished(explicitBuildTargets,exitCode));
      if (exitCode != 0) {
        return exitCode;
      }
      if (options.isBuildFiltered()) {
        testRules=filterTestRules(options,testRules);
      }
      try (CommandThreadManager testPool=new CommandThreadManager("Test-Run",options.getNumTestThreads())){
        return runTests(testRules,Preconditions.checkNotNull(build.getBuildContext()),build.getExecutionContext(),options,testPool.getExecutor(),cachingBuildEngine);
      }
 catch (      ExecutionException e) {
        console.printBuildFailureWithoutStacktrace(e);
        return 1;
      }
    }
   }
 }

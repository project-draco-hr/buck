{
  DebugLog.log("Beginning tests");
  if (options.isRunAllTests()) {
    try {
      return runAllTests(options);
    }
 catch (    BuildTargetException|BuildFileParseException e) {
      console.printBuildFailureWithoutStacktrace(e);
      DebugLog.log("Failing test run due to runAllTests exception: " + e.toString());
      return 1;
    }
  }
  BuildCommand buildCommand=new BuildCommand(getCommandRunnerParams());
  int exitCode=buildCommand.runCommandWithOptions(options);
  if (exitCode != 0) {
    DebugLog.log("Failing test run due to build failure");
    return exitCode;
  }
  Build build=buildCommand.getBuild();
  Iterable<TestRule> results=getCandidateRules(build.getDependencyGraph(),options);
  results=filterTestRules(options,results);
  BuildContext buildContext=build.getBuildContext();
  ExecutionContext buildExecutionContext=build.getExecutionContext();
  ExecutionContext testExecutionContext=ExecutionContext.builder().setExecutionContext(buildExecutionContext).setTargetDevice(options.getTargetDeviceOptional()).build();
  return runTestsAndShutdownExecutor(results,buildContext,testExecutionContext,options);
}

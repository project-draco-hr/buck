{
  LOG.debug("Running with arguments %s",getArguments());
  BuildEvent.Started started=BuildEvent.started(getArguments());
  if (params.getParser().getParseStartTime().isPresent()) {
    params.getBuckEventBus().post(started,params.getParser().getParseStartTime().get());
  }
 else {
    params.getBuckEventBus().post(started);
  }
  ParserConfig parserConfig=new ParserConfig(params.getBuckConfig());
  TargetGraph targetGraph;
  ImmutableSet<BuildTarget> explicitBuildTargets;
  try {
    if (isRunAllTests()) {
      targetGraph=params.getParser().buildTargetGraphForTargetNodeSpecs(ImmutableList.of(TargetNodePredicateSpec.of(new Predicate<TargetNode<?>>(){
        @Override public boolean apply(        TargetNode<?> input){
          return input.getType().isTestRule();
        }
      }
,BuildFileSpec.fromRecursivePath(Paths.get(""),params.getRepository().getFilesystem().getIgnorePaths()))),parserConfig,params.getBuckEventBus(),params.getConsole(),params.getEnvironment(),getEnableProfiling()).getSecond();
      explicitBuildTargets=ImmutableSet.of();
    }
 else {
      LOG.debug("Parsing graph for arguments %s",getArguments());
      Pair<ImmutableSet<BuildTarget>,TargetGraph> result=params.getParser().buildTargetGraphForTargetNodeSpecs(parseArgumentsAsTargetNodeSpecs(params.getBuckConfig(),params.getRepository().getFilesystem().getIgnorePaths(),getArguments()),parserConfig,params.getBuckEventBus(),params.getConsole(),params.getEnvironment(),getEnableProfiling());
      targetGraph=result.getSecond();
      explicitBuildTargets=result.getFirst();
      LOG.debug("Got explicit build targets %s",explicitBuildTargets);
      ImmutableSet.Builder<BuildTarget> testTargetsBuilder=ImmutableSet.builder();
      for (      TargetNode<?> node : targetGraph.getAll(explicitBuildTargets)) {
        ImmutableSortedSet<BuildTarget> nodeTests=TargetNodes.getTestTargetsForNode(node);
        if (!nodeTests.isEmpty()) {
          LOG.debug("Got tests for target %s: %s",node.getBuildTarget(),nodeTests);
          testTargetsBuilder.addAll(nodeTests);
        }
      }
      ImmutableSet<BuildTarget> testTargets=testTargetsBuilder.build();
      if (!testTargets.isEmpty()) {
        LOG.debug("Got related test targets %s, building new target graph...",testTargets);
        targetGraph=params.getParser().buildTargetGraphForBuildTargets(Iterables.concat(explicitBuildTargets,testTargets),parserConfig,params.getBuckEventBus(),params.getConsole(),params.getEnvironment(),getEnableProfiling());
        LOG.debug("Finished building new target graph with tests.");
      }
    }
  }
 catch (  BuildTargetException|BuildFileParseException e) {
    params.getConsole().printBuildFailureWithoutStacktrace(e);
    return 1;
  }
  TargetGraphToActionGraph targetGraphToActionGraph=new TargetGraphToActionGraph(params.getBuckEventBus(),new BuildTargetNodeToBuildRuleTransformer(),params.getFileHashCache());
  ActionGraph graph=targetGraphToActionGraph.apply(targetGraph);
  Iterable<TestRule> testRules=Iterables.filter(graph.getNodes(),TestRule.class);
  if (!isBuildFiltered(params.getBuckConfig())) {
    testRules=filterTestRules(params.getBuckConfig(),explicitBuildTargets,testRules);
  }
  if (isDryRun()) {
    printMatchingTestRules(params.getConsole(),testRules);
  }
  try (CommandThreadManager pool=new CommandThreadManager("Test",getConcurrencyLimit(params.getBuckConfig()))){
    SourcePathResolver pathResolver=new SourcePathResolver(targetGraphToActionGraph.getRuleResolver());
    CachingBuildEngine cachingBuildEngine=new CachingBuildEngine(pool.getExecutor(),params.getFileHashCache(),getBuildEngineMode().or(params.getBuckConfig().getBuildEngineMode()),params.getBuckConfig().getBuildDepFiles(),pathResolver);
    try (Build build=createBuild(params.getBuckConfig(),graph,params.getAndroidPlatformTargetSupplier(),cachingBuildEngine,params.getArtifactCache(),params.getConsole(),params.getBuckEventBus(),getTargetDeviceOptional(),params.getPlatform(),params.getEnvironment(),params.getObjectMapper(),params.getClock(),Optional.of(getAdbOptions(params.getBuckConfig())),Optional.of(getTargetDeviceOptions()))){
      int exitCode=build.executeAndPrintFailuresToEventBus(testRules,isKeepGoing(),params.getBuckEventBus(),params.getConsole().getAnsi(),getPathToBuildReport(params.getBuckConfig()));
      params.getBuckEventBus().post(BuildEvent.finished(started,exitCode));
      if (exitCode != 0) {
        return exitCode;
      }
      if (isBuildFiltered(params.getBuckConfig())) {
        testRules=filterTestRules(params.getBuckConfig(),explicitBuildTargets,testRules);
      }
      ConcurrencyLimit concurrencyLimit=new ConcurrencyLimit(getNumTestThreads(params.getBuckConfig()),params.getBuckConfig().getLoadLimit());
      try (CommandThreadManager testPool=new CommandThreadManager("Test-Run",concurrencyLimit)){
        TestRunningOptions options=TestRunningOptions.builder().setUsingOneTimeOutputDirectories(isUsingOneTimeOutput).setCodeCoverageEnabled(isCodeCoverageEnabled).setRunAllTests(isRunAllTests()).setTestSelectorList(testSelectorOptions.getTestSelectorList()).setShouldExplainTestSelectorList(testSelectorOptions.shouldExplain()).setIgnoreFailingDependencies(isIgnoreFailingDependencies).setResultsCacheEnabled(isResultsCacheEnabled(params.getBuckConfig())).setDryRun(isDryRun).setShufflingTests(isShufflingTests).setPathToXmlTestOutput(Optional.fromNullable(pathToXmlTestOutput)).setPathToJavaAgent(Optional.fromNullable(pathToJavaAgent)).setCoverageReportFormat(coverageReportFormat).setCoverageReportTitle(coverageReportTitle).build();
        return TestRunning.runTests(params,testRules,Preconditions.checkNotNull(build.getBuildContext()),build.getExecutionContext(),options,testPool.getExecutor(),cachingBuildEngine,new DefaultStepRunner(build.getExecutionContext()));
      }
 catch (      ExecutionException e) {
        params.getConsole().printBuildFailureWithoutStacktrace(e);
        return 1;
      }
    }
   }
 }

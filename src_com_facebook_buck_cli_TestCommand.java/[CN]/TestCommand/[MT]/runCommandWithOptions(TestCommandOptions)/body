{
  if (options.isRunAllTests()) {
    try {
      return runAllTests(options);
    }
 catch (    NoSuchBuildTargetException e) {
      console.printFailureWithoutStacktrace(e);
      return 1;
    }
  }
  BuildCommand buildCommand=new BuildCommand(console,getProjectFilesystem(),getBuildRuleTypes(),getArtifactCache());
  int exitCode=buildCommand.runCommandWithOptions(options);
  if (exitCode != 0) {
    return exitCode;
  }
  Build build=buildCommand.getBuild();
  Iterable<TestRule> results=getCandidateRulesByIncludedLabels(build.getDependencyGraph(),options.getIncludedLabels());
  results=filterTestRules(options,results);
  BuildContext buildContext=build.getBuildContext();
  ExecutionContext executionContext=build.getExecutionContext();
  StepRunner stepRunner=build.getCommandRunner();
  return runTests(results,buildContext,executionContext,stepRunner,options);
}

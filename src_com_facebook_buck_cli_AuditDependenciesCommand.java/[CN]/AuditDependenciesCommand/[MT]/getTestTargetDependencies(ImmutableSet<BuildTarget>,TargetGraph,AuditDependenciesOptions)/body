{
  if (!options.shouldShowTransitiveDependencies()) {
    return TargetGraphAndTargets.getExplicitTestTargets(graph.getAll(targets));
  }
  ProjectGraphParser projectGraphParser=ProjectGraphParsers.createProjectGraphParser(getParser(),new ParserConfig(options.getBuckConfig()),getBuckEventBus(),console,environment,options.getEnableProfiling());
  TargetGraph graphWithTests=TargetGraphTestParsing.expandedTargetGraphToIncludeTestsForTargets(projectGraphParser,graph,targets);
  ImmutableSet<BuildTarget> tests=TargetGraphAndTargets.getExplicitTestTargets(targets,graphWithTests);
  Set<BuildTarget> testsWithDependencies=Sets.union(tests,getTransitiveDependencies(tests,graphWithTests));
  return Sets.difference(testsWithDependencies,targets);
}

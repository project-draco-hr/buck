{
  final ImmutableSetMultimap<JavaLibraryRule,String> classpathEntriesMap=getTransitiveClasspathEntries();
  ImmutableSet.Builder<String> additionalLibraryJarsForProguardBuilder=ImmutableSet.builder();
  for (  BuildRule buildRule : buildRulesToExcludeFromDex) {
    if (buildRule instanceof JavaLibraryRule) {
      additionalLibraryJarsForProguardBuilder.addAll(classpathEntriesMap.get((JavaLibraryRule)buildRule));
    }
  }
  Set<String> classpathEntries=dexDeps.classpathEntriesToDex;
  String proguardDirectory=getPathForProGuardDirectory();
  commands.add(new MakeCleanDirectoryStep(proguardDirectory));
  String generatedProGuardConfig=proguardDirectory + "/proguard.txt";
  GenProGuardConfigStep genProGuardConfig=new GenProGuardConfigStep(getAndroidManifestXml(),resDirectories,generatedProGuardConfig);
  commands.add(genProGuardConfig);
  ImmutableSet.Builder<String> proguardConfigsBuilder=ImmutableSet.builder();
  proguardConfigsBuilder.addAll(depsProguardConfigs);
  if (proguardConfig.isPresent()) {
    proguardConfigsBuilder.add(proguardConfig.get().resolve(context).toString());
  }
  ImmutableMap.Builder<String,String> inputOutputEntriesBuilder=ImmutableMap.builder();
  for (  String classpathEntry : classpathEntries) {
    inputOutputEntriesBuilder.put(classpathEntry,getProguardOutputFromInputClasspath(classpathEntry));
  }
  final ImmutableMap<String,String> inputOutputEntries=inputOutputEntriesBuilder.build();
  ProGuardObfuscateStep obfuscateCommand=new ProGuardObfuscateStep(generatedProGuardConfig,proguardConfigsBuilder.build(),useAndroidProguardConfigWithOptimizations,inputOutputEntriesBuilder.build(),additionalLibraryJarsForProguardBuilder.build(),proguardDirectory);
  commands.add(obfuscateCommand);
  dexDeps.applyClasspathTransformation(new AndroidDexTransitiveDependencies.InputTransformation(){
    @Override public String apply(    String originalClasspath){
      return inputOutputEntries.get(originalClasspath);
    }
  }
);
}

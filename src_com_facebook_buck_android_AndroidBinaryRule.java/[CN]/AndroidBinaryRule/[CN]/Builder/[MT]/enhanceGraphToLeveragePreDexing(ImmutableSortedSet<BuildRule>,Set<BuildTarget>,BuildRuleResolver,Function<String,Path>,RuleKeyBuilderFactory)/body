{
  ImmutableSet.Builder<BuildRule> preDexDeps=ImmutableSet.builder();
  ImmutableSet<JavaLibraryRule> transitiveJavaDeps=Classpaths.getClasspathEntries(originalDeps).keySet();
  for (  JavaLibraryRule javaLibraryRule : transitiveJavaDeps) {
    if (javaLibraryRule.getPathToOutputFile() == null) {
      continue;
    }
    if (buildRulesToExcludeFromDex.contains(javaLibraryRule.getBuildTarget())) {
      continue;
    }
    BuildTarget originalTarget=javaLibraryRule.getBuildTarget();
    BuildTarget preDexTarget=new BuildTarget(originalTarget.getBaseName(),originalTarget.getShortName(),"dex");
    BuildRule preDexRule=ruleResolver.get(preDexTarget);
    if (preDexRule != null) {
      preDexDeps.add(preDexRule);
      continue;
    }
    AccumulateClassNames.Builder accumulateClassNamesBuilder=AccumulateClassNames.newAccumulateClassNamesBuilder(new DefaultBuildRuleBuilderParams(pathRelativizer,ruleKeyBuilderFactory));
    BuildTarget accumulateClassNamesBuildTarget=new BuildTarget(originalTarget.getBaseName(),originalTarget.getShortName(),"class_names");
    accumulateClassNamesBuilder.setBuildTarget(accumulateClassNamesBuildTarget);
    accumulateClassNamesBuilder.setJavaLibraryToDex(javaLibraryRule);
    accumulateClassNamesBuilder.addDep(originalTarget);
    accumulateClassNamesBuilder.addVisibilityPattern(BuildTargetPattern.MATCH_ALL);
    BuildRule accumulateClassNamesRule=ruleResolver.buildAndAddToIndex(accumulateClassNamesBuilder);
    AccumulateClassNames accumulateClassNames=(AccumulateClassNames)accumulateClassNamesRule.getBuildable();
    IntermediateDexRule.Builder preDexBuilder=IntermediateDexRule.newPreDexBuilder(new DefaultBuildRuleBuilderParams(pathRelativizer,ruleKeyBuilderFactory));
    preDexBuilder.setBuildTarget(preDexTarget);
    preDexBuilder.setAccumulateClassNamesDep(accumulateClassNames);
    preDexBuilder.addDep(accumulateClassNamesBuildTarget);
    preDexBuilder.addVisibilityPattern(BuildTargetPattern.MATCH_ALL);
    BuildRule preDex=ruleResolver.buildAndAddToIndex(preDexBuilder);
    preDexDeps.add(preDex);
  }
  return preDexDeps.build();
}

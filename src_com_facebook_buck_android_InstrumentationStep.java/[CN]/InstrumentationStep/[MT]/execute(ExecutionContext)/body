{
  String packageName=AdbHelper.tryToExtractPackageNameFromManifest(apk);
  String testRunner=AdbHelper.tryToExtractInstrumentationTestRunnerFromManifest(apk);
  try {
    AdbHelper adbHelper=AdbHelper.get(context,true);
    IDevice device=adbHelper.getSingleDevice();
    RemoteAndroidTestRunner runner=new RemoteAndroidTestRunner(packageName,testRunner,device);
    BuckXmlTestRunListener listener=new BuckXmlTestRunListener();
    listener.setReportDir(directoryForTestResults.toFile());
    runner.run(listener);
  }
 catch (  IOException e) {
    e.printStackTrace(context.getStdErr());
    return 1;
  }
catch (  TimeoutException|AdbCommandRejectedException|ShellCommandUnresponsiveException e) {
    return 1;
  }
  return 0;
}

{
  BuildRule apkRule=ruleResolver.get(this.apk);
  if (apkRule == null) {
    throw new HumanReadableException("Must specify apk for " + getBuildTarget());
  }
 else   if (!(apkRule.getBuildable() instanceof InstallableApk)) {
    throw new HumanReadableException("In %s, apk='%s' must be an android_binary() or apk_genrule() but was %s().",getBuildTarget(),apkRule.getFullyQualifiedName(),apkRule.getType().getName());
  }
  BuildRuleParams originalParams=createBuildRuleParams(ruleResolver);
  final ImmutableSortedSet<BuildRule> originalDeps=originalParams.getDeps();
  final AndroidBinaryRule apkUnderTest=getUnderlyingApk((InstallableApk)apkRule.getBuildable());
  ImmutableSet<JavaLibraryRule> buildRulesToExcludeFromDex=ImmutableSet.<JavaLibraryRule>builder().addAll(apkUnderTest.getBuildRulesToExcludeFromDex()).addAll(Classpaths.getClasspathEntries(apkUnderTest.getClasspathDeps()).keySet()).build();
  ImmutableSortedSet<BuildRule> classpathDepsForInstrumentationApk=getBuildTargetsAsBuildRules(ruleResolver,classpathDeps.build());
  AndroidTransitiveDependencyGraph androidTransitiveDependencyGraph=new AndroidTransitiveDependencyGraph(classpathDepsForInstrumentationApk);
  AndroidResourceDepsFinder androidResourceDepsFinder=new AndroidResourceDepsFinder(androidTransitiveDependencyGraph,buildRulesToExcludeFromDex){
    @Override protected ImmutableList<HasAndroidResourceDeps> findMyAndroidResourceDeps(){
      ImmutableSet<HasAndroidResourceDeps> originalResources=ImmutableSet.copyOf(UberRDotJavaUtil.getAndroidResourceDeps(apkUnderTest));
      ImmutableList<HasAndroidResourceDeps> instrumentationResources=UberRDotJavaUtil.getAndroidResourceDeps(originalDeps);
      ImmutableList.Builder<HasAndroidResourceDeps> allResources=ImmutableList.builder();
      for (      HasAndroidResourceDeps resource : instrumentationResources) {
        if (!originalResources.contains(resource)) {
          allResources.add(resource);
        }
      }
      return allResources.build();
    }
  }
;
  Path primaryDexPath=BuildTargets.getBinPath(getBuildTarget(),".dex/%s/classes.dex");
  AndroidBinaryGraphEnhancer graphEnhancer=new AndroidBinaryGraphEnhancer(originalParams,ruleResolver,ResourceCompressionMode.DISABLED,ResourceFilter.EMPTY_FILTER,androidResourceDepsFinder,manifest,PackageType.INSTRUMENTED,apkUnderTest.getCpuFilters(),false,false,primaryDexPath,DexSplitMode.NO_SPLIT,ImmutableSortedSet.<BuildTarget>of(),JavacOptions.DEFAULTS,false,apkUnderTest.getKeystore());
  AndroidBinaryGraphEnhancer.EnhancementResult result=graphEnhancer.createAdditionalBuildables();
  BuildRuleParams newParams=originalParams.copyWithChangedDeps(result.getFinalDeps());
  return new AndroidInstrumentationApk(newParams,manifest,apkUnderTest,buildRulesToExcludeFromDex,result.getFilteredResourcesProvider(),result.getUberRDotJava(),result.getPackageStringAssets(),result.getAaptPackageResources(),androidResourceDepsFinder,getBuildTargetsAsBuildRules(ruleResolver,classpathDeps.build()));
}

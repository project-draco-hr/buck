{
  rulesToExcludeFromDex=FluentIterable.from(ImmutableSet.<JavaLibrary>builder().addAll(apkUnderTest.getRulesToExcludeFromDex()).addAll(Classpaths.getClasspathEntries(apkUnderTest.getClasspathDeps()).keySet()).build()).toSortedSet(HasBuildTarget.BUILD_TARGET_COMPARATOR);
  AndroidPackageableCollection.ResourceDetails resourceDetails=apkUnderTest.getAndroidPackageableCollection().resourceDetails;
  ImmutableSet<BuildTarget> resourcesToExclude=ImmutableSet.copyOf(Iterables.concat(resourceDetails.resourcesWithNonEmptyResDir,resourceDetails.resourcesWithEmptyResButNonEmptyAssetsDir));
  Path primaryDexPath=AndroidBinary.getPrimaryDexPath(getBuildTarget());
  AndroidBinaryGraphEnhancer graphEnhancer=new AndroidBinaryGraphEnhancer(params,ruleResolver,ResourceCompressionMode.DISABLED,ResourceFilter.EMPTY_FILTER,manifest,PackageType.INSTRUMENTED,apkUnderTest.getCpuFilters(),false,false,primaryDexPath,DexSplitMode.NO_SPLIT,FluentIterable.from(rulesToExcludeFromDex).transform(TO_TARGET).toSet(),resourcesToExclude,JavacOptions.DEFAULTS,false,apkUnderTest.getKeystore());
  AndroidBinaryGraphEnhancer.EnhancementResult result=graphEnhancer.createAdditionalBuildables();
  setGraphEnhancementResult(result);
  return ImmutableSortedSet.<BuildRule>naturalOrder().addAll(result.getFinalDeps()).addAll(inferredDeps).build();
}

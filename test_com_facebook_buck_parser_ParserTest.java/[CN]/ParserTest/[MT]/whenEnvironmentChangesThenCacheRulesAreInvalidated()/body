{
  TestProjectBuildFileParserFactory buildFileParserFactory=new TestProjectBuildFileParserFactory(filesystem,buildRuleTypes);
  Parser parser=createParser(emptyBuildTargets(),buildFileParserFactory);
  parser.filterAllTargetsInProject(filesystem,Lists.<String>newArrayList(),alwaysTrue(),new TestConsole());
  parser.setEnvironment(ImmutableMap.<String,String>builder().putAll(System.getenv()).put("SOME_NEW_KEY","SOME_VALUE").build());
  parser.filterAllTargetsInProject(filesystem,Lists.<String>newArrayList(),alwaysTrue(),new TestConsole());
  assertEquals("Should have invalidated cache.",2,buildFileParserFactory.calls);
}

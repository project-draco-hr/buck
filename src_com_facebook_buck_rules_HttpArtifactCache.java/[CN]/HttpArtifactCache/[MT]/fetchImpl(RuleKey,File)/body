{
  Request request=createRequestBuilder(ruleKey.toString()).get().build();
  Response response=fetchCall(request);
  if (response.code() == HttpURLConnection.HTTP_NOT_FOUND) {
    LOGGER.info("fetch(%s, %s): cache miss",url,ruleKey);
    return CacheResult.miss();
  }
  if (response.code() != HttpURLConnection.HTTP_OK) {
    String msg=String.format("unexpected response: %d",response.code());
    reportFailure("fetch(%s, %s): %s",url,ruleKey,msg);
    return CacheResult.error(name,msg);
  }
  HashCode expectedHashCode, actualHashCode;
  Path path=file.toPath();
  projectFilesystem.createParentDirs(path);
  Path temp=projectFilesystem.createTempFile(path.getParent(),path.getFileName().toString(),".tmp");
  try (DataInputStream input=new DataInputStream(response.body().byteStream())){
    long length=input.readLong();
    try (BoundedInputStream boundedInput=new BoundedInputStream(input,length);HashingInputStream hashingInput=new HashingInputStream(hashFunction,boundedInput);OutputStream output=projectFilesystem.newFileOutputStream(temp)){
      ByteStreams.copy(hashingInput,output);
      actualHashCode=hashingInput.hash();
    }
     byte[] hashCodeBytes=new byte[hashFunction.bits() / Byte.SIZE];
    ByteStreams.readFully(input,hashCodeBytes);
    expectedHashCode=HashCode.fromBytes(hashCodeBytes);
    try (OutputStream output=ByteStreams.nullOutputStream()){
      if (ByteStreams.copy(input,output) != 0) {
        String msg="unexpected end of input";
        reportFailure("fetch(%s, %s): %s",url,ruleKey,msg);
        return CacheResult.error(name,msg);
      }
    }
   }
   if (!expectedHashCode.equals(actualHashCode)) {
    String msg="artifact had invalid checksum";
    reportFailure("fetch(%s, %s): %s",url,ruleKey,msg);
    projectFilesystem.deleteFileAtPath(temp);
    return CacheResult.error(name,msg);
  }
  projectFilesystem.move(temp,path,StandardCopyOption.REPLACE_EXISTING);
  LOGGER.info("fetch(%s, %s): cache hit",url,ruleKey);
  return CacheResult.hit(name);
}

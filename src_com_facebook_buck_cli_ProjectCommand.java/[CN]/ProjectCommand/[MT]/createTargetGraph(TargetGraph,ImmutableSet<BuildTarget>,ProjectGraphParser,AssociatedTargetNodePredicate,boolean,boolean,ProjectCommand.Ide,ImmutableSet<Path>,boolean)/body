{
  TargetGraph resultProjectGraph;
  ImmutableSet<BuildTarget> explicitTestTargets;
  ImmutableSet<BuildTarget> graphRootsOrSourceTargets=replaceWorkspacesWithSourceTargetsIfPossible(graphRoots,projectGraph);
  if (isWithTests) {
    explicitTestTargets=TargetGraphAndTargets.getExplicitTestTargets(graphRootsOrSourceTargets,projectGraph,isWithDependenciesTests);
    resultProjectGraph=projectGraphParser.buildTargetGraphForTargetNodeSpecs(getTargetNodeSpecsForIde(ide,Sets.union(graphRoots,explicitTestTargets),ignoreDirs,experimentalProjectGenerationEnabled));
  }
 else {
    resultProjectGraph=projectGraph;
    explicitTestTargets=ImmutableSet.of();
  }
  return TargetGraphAndTargets.create(graphRoots,graphRootsOrSourceTargets,resultProjectGraph,associatedProjectPredicate,isWithTests,isWithDependenciesTests,explicitTestTargets);
}

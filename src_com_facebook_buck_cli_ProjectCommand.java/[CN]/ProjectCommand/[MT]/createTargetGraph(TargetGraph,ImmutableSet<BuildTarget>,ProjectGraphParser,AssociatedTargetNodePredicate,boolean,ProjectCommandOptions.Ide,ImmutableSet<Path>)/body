{
  TargetGraph resultProjectGraph;
  ImmutableSet<BuildTarget> explicitTestTargets;
  if (isWithTests) {
    explicitTestTargets=TargetGraphAndTargets.getExplicitTestTargets(graphRoots,projectGraph);
    resultProjectGraph=projectGraphParser.buildTargetGraphForTargetNodeSpecs(getTargetNodeSpecsForIde(ide,Sets.union(graphRoots,explicitTestTargets),ignoreDirs));
  }
 else {
    resultProjectGraph=projectGraph;
    explicitTestTargets=ImmutableSet.of();
  }
  return TargetGraphAndTargets.create(graphRoots,resultProjectGraph,associatedProjectPredicate,isWithTests,explicitTestTargets);
}

{
  ActionGraph actionGraph=new TargetGraphToActionGraph(params.getBuckEventBus(),new BuildTargetNodeToBuildRuleTransformer()).apply(targetGraphAndTargets.getTargetGraph());
  try (ExecutionContext executionContext=createExecutionContext(params)){
    Project project=new Project(new SourcePathResolver(new BuildRuleResolver(actionGraph.getNodes())),FluentIterable.from(actionGraph.getNodes()).filter(ProjectConfig.class).toSortedSet(Ordering.natural()),targetGraphAndTargets.getTargetGraph(),actionGraph,options.getBasePathToAliasMap(),options.getJavaPackageFinder(),executionContext,new FilesystemBackedBuildFileTree(params.getRepository().getFilesystem(),new ParserConfig(options.getBuckConfig()).getBuildFileName()),params.getRepository().getFilesystem(),options.getPathToDefaultAndroidManifest(),new IntellijConfig(options.getBuckConfig()),options.getPathToPostProcessScript(),new PythonBuckConfig(options.getBuckConfig(),new ExecutableFinder()).getPythonInterpreter(),params.getObjectMapper(),options.isAndroidAutoGenerateDisabled(),options.isExperimentalIntelliJProjectGenerationEnabled());
    File tempDir=Files.createTempDir();
    File tempFile=new File(tempDir,"project.json");
    int exitCode;
    try {
      exitCode=project.createIntellijProject(tempFile,executionContext.getProcessExecutor(),!passedInTargetsSet.isEmpty(),params.getConsole().getStdOut(),params.getConsole().getStdErr());
      if (exitCode != 0) {
        return exitCode;
      }
      List<String> additionalInitialTargets=ImmutableList.of();
      if (options.shouldProcessAnnotations()) {
        try {
          additionalInitialTargets=getAnnotationProcessingTargets(projectGraph,passedInTargetsSet);
        }
 catch (        BuildTargetException|BuildFileParseException e) {
          throw new HumanReadableException(e);
        }
      }
      if (options.hasInitialTargets() || !additionalInitialTargets.isEmpty()) {
        BuildCommand buildCommand=new BuildCommand();
        BuildCommandOptions buildOptions=options.createBuildCommandOptionsWithInitialTargets(additionalInitialTargets);
        exitCode=buildCommand.runCommandWithOptions(params,buildOptions);
        if (exitCode != 0) {
          return exitCode;
        }
      }
    }
  finally {
      if (params.getConsole().getVerbosity().shouldPrintOutput()) {
        params.getConsole().getStdErr().printf("project.json was written to %s",tempFile.getAbsolutePath());
      }
 else {
        tempFile.delete();
        tempDir.delete();
      }
    }
    if (passedInTargetsSet.isEmpty()) {
      String greenStar=params.getConsole().getAnsi().asHighlightedSuccessText(" * ");
      params.getConsole().getStdErr().printf(params.getConsole().getAnsi().asHighlightedSuccessText("=== Did you know ===") + "\n" + greenStar+ "You can run `buck project <target>` to generate a minimal project "+ "just for that target.\n"+ greenStar+ "This will make your IDE faster when working on large projects.\n"+ greenStar+ "See buck project --help for more info.\n"+ params.getConsole().getAnsi().asHighlightedSuccessText("--=* Knowing is half the battle!")+ "\n");
    }
    return 0;
  }
 }

{
  ImmutableList<Map.Entry<Integer,SettableFuture<Void>>> ready=releaseInternal(permits);
  int failed=0;
  for (  Map.Entry<Integer,SettableFuture<Void>> entry : ready) {
    if (!entry.getValue().set(null)) {
      failed+=entry.getKey();
    }
  }
  if (failed > 0) {
    release(failed);
  }
}

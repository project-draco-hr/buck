{
  ProjectFilesystem filesystem=new ProjectFilesystem(tmp.getRoot().toPath());
  CxxPlatform platform=DefaultCxxPlatforms.build(new CxxBuckConfig(FakeBuckConfig.builder().build()));
  BuildRuleResolver resolver=new BuildRuleResolver(TargetGraph.EMPTY,new BuildTargetNodeToBuildRuleTransformer());
  SourcePathResolver pathResolver=new SourcePathResolver(resolver);
  ImmutableList<String> compiler=platform.getCc().resolve(resolver).getCommandPrefix(pathResolver);
  Path output=filesystem.resolve(Paths.get("output.o"));
  Path depFile=filesystem.resolve(Paths.get("output.dep"));
  Path relativeInput=Paths.get("input.c");
  Path input=filesystem.resolve(relativeInput);
  filesystem.writeContentsToPath("int main() {}",relativeInput);
  Path scratchDir=filesystem.getRootPath().getFileSystem().getPath("scratchDir");
  filesystem.mkdirs(scratchDir);
  ImmutableList.Builder<String> preprocessorCommand=ImmutableList.builder();
  preprocessorCommand.addAll(compiler);
  ImmutableList.Builder<String> compilerCommand=ImmutableList.builder();
  compilerCommand.addAll(compiler);
  compilerCommand.add("-g");
  DebugPathSanitizer sanitizer=new DebugPathSanitizer(200,File.separatorChar,compDir,ImmutableBiMap.<Path,Path>of());
  CxxPreprocessAndCompileStep step=new CxxPreprocessAndCompileStep(filesystem,CxxPreprocessAndCompileStep.Operation.COMPILE_MUNGE_DEBUGINFO,output,depFile,relativeInput,CxxSource.Type.C,Optional.of(new CxxPreprocessAndCompileStep.ToolCommand(preprocessorCommand.build(),ImmutableMap.<String,String>of(),Optional.<ImmutableList<String>>absent())),Optional.of(new CxxPreprocessAndCompileStep.ToolCommand(compilerCommand.build(),ImmutableMap.<String,String>of(),Optional.<ImmutableList<String>>absent())),ImmutableMap.<Path,Path>of(),sanitizer,Optional.<Function<String,Iterable<String>>>absent(),scratchDir);
  ExecutionContext executionContext=TestExecutionContext.newInstance();
  TestConsole console=(TestConsole)executionContext.getConsole();
  int exitCode=step.execute(executionContext);
  if (failure.isPresent()) {
    assertNotEquals("compile step succeeded",0,exitCode);
    assertThat(console.getTextWrittenToStdErr(),console.getTextWrittenToStdErr(),Matchers.containsString(failure.get()));
  }
 else {
    assertEquals("compile step failed: " + console.getTextWrittenToStdErr(),0,exitCode);
    String contents=new String(Files.readAllBytes(output));
    assertThat(contents,Matchers.containsString(sanitizer.getCompilationDirectory()));
  }
  Files.delete(input);
  Files.deleteIfExists(output);
}

{
  ProjectFilesystem filesystem=new FakeProjectFilesystem();
  BuildRuleResolver resolver=new BuildRuleResolver(TargetGraph.EMPTY,new DefaultTargetNodeToBuildRuleTransformer());
  SourcePathResolver pathResolver=new SourcePathResolver(resolver);
  JavaLibrary exportedDep=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:edep")).addSrc(Paths.get("Source1.java")).build(resolver,filesystem);
  filesystem.writeContentsToPath("JAR contents",exportedDep.getPathToOutput());
  writeAbiJar(filesystem,pathResolver.deprecatedGetPath(exportedDep.getAbiJar().get()),"Source1.class","ABI JAR contents");
  JavaLibrary dep2=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:dep2")).addExportedDep(exportedDep.getBuildTarget()).build(resolver,filesystem);
  JavaLibrary dep1=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:dep1")).addExportedDep(dep2.getBuildTarget()).build(resolver,filesystem);
  JavaLibrary library=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:lib")).addDep(dep1.getBuildTarget()).build(resolver,filesystem);
  DefaultFileHashCache originalHashCache=new DefaultFileHashCache(filesystem);
  InputBasedRuleKeyBuilderFactory factory=new InputBasedRuleKeyBuilderFactory(0,originalHashCache,pathResolver);
  RuleKey originalRuleKey=factory.build(library);
  resolver=new BuildRuleResolver(TargetGraph.EMPTY,new DefaultTargetNodeToBuildRuleTransformer());
  exportedDep=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:edep")).addSrc(Paths.get("Source1.java")).setResourcesRoot(Paths.get("some root that changes the rule key")).build(resolver,filesystem);
  filesystem.writeContentsToPath("different JAR contents",exportedDep.getPathToOutput());
  dep2=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:dep2")).addExportedDep(exportedDep.getBuildTarget()).build(resolver,filesystem);
  dep1=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:dep1")).addExportedDep(dep2.getBuildTarget()).build(resolver,filesystem);
  library=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:lib")).addDep(dep1.getBuildTarget()).build(resolver,filesystem);
  DefaultFileHashCache unaffectedHashCache=new DefaultFileHashCache(filesystem);
  factory=new InputBasedRuleKeyBuilderFactory(0,unaffectedHashCache,pathResolver);
  RuleKey unaffectedRuleKey=factory.build(library);
  assertThat(originalRuleKey,equalTo(unaffectedRuleKey));
  resolver=new BuildRuleResolver(TargetGraph.EMPTY,new DefaultTargetNodeToBuildRuleTransformer());
  exportedDep=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:edep")).addSrc(Paths.get("Source1.java")).build(resolver,filesystem);
  writeAbiJar(filesystem,pathResolver.deprecatedGetPath(exportedDep.getAbiJar().get()),"Source1.class","changed ABI JAR contents");
  dep2=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:dep2")).addExportedDep(exportedDep.getBuildTarget()).build(resolver,filesystem);
  dep1=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:dep1")).addExportedDep(dep2.getBuildTarget()).build(resolver,filesystem);
  library=(JavaLibrary)JavaLibraryBuilder.createBuilder(BuildTargetFactory.newInstance("//:lib")).addDep(dep1.getBuildTarget()).build(resolver,filesystem);
  DefaultFileHashCache affectedHashCache=new DefaultFileHashCache(filesystem);
  factory=new InputBasedRuleKeyBuilderFactory(0,affectedHashCache,pathResolver);
  RuleKey affectedRuleKey=factory.build(library);
  assertThat(originalRuleKey,Matchers.not(equalTo(affectedRuleKey)));
}

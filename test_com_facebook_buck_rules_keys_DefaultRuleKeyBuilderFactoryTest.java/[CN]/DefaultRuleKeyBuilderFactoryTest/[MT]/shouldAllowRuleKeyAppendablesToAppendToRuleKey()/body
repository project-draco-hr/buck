{
  BuildTarget target=BuildTargetFactory.newInstance("//cheese:peas");
  SourcePathResolver pathResolver=new SourcePathResolver(new BuildRuleResolver());
  BuildRule rule=new EmptyRule(target);
  FileHashCache fileHashCache=new NullFileHashCache();
  AppendableRuleKeyCache appendableRuleKeyCache=new AppendableRuleKeyCache(pathResolver,fileHashCache);
  DefaultRuleKeyBuilderFactory factory=new DefaultRuleKeyBuilderFactory(fileHashCache,pathResolver);
  RuleKey subKey=new RuleKey.Builder(pathResolver,fileHashCache,appendableRuleKeyCache).setReflectively("cheese","brie").build();
  RuleKey.Builder builder=factory.newInstance(rule);
  builder.setReflectively("field.appendableSubKey",subKey);
  RuleKey expected=builder.build();
class AppendingField extends EmptyRule {
    @AddToRuleKey private Appender field=new Appender();
    public AppendingField(    BuildTarget target){
      super(target);
    }
  }
  RuleKey.Builder seen=factory.newInstance(new AppendingField(target));
  assertEquals(expected,seen.build());
}

{
  ProjectFilesystem filesystem=context.getProjectFilesystem();
  Manifest manifest=new Manifest();
  manifest.getMainAttributes().put(Attributes.Name.MANIFEST_VERSION,"1.0");
  try (CustomZipOutputStream outputFile=ZipOutputStreams.newOutputStream(filesystem.getFileForRelativePath(pathToOutputFile),APPEND_TO_ZIP)){
    Set<String> alreadyAddedEntries=Sets.newHashSet();
    ProjectFilesystem projectFilesystem=context.getProjectFilesystem();
    for (    Path entry : entriesToJar) {
      File file=projectFilesystem.getFileForRelativePath(entry);
      if (file.isFile()) {
        copyZipEntriesToJar(file,outputFile,manifest,alreadyAddedEntries,context.getBuckEventBus());
      }
 else       if (file.isDirectory()) {
        addFilesInDirectoryToJar(file,outputFile,alreadyAddedEntries,context.getBuckEventBus());
      }
 else {
        throw new IllegalStateException("Must be a file or directory: " + file);
      }
    }
    if (manifestFile != null) {
      try (FileInputStream manifestStream=new FileInputStream(filesystem.getFileForRelativePath(manifestFile))){
        Manifest userSupplied=new Manifest(manifestStream);
        merge(manifest,userSupplied);
      }
     }
    if (mainClass != null) {
      manifest.getMainAttributes().put(Attributes.Name.MAIN_CLASS,mainClass);
    }
    JarEntry manifestEntry=new JarEntry(JarFile.MANIFEST_NAME);
    outputFile.putNextEntry(manifestEntry);
    manifest.write(outputFile);
  }
 }

{
  Manifest manifest=new Manifest();
  if (manifestFile != null) {
    FileInputStream manifestStream=new FileInputStream(new File(manifestFile));
    boolean readSuccessfully=false;
    try {
      manifest.read(manifestStream);
      readSuccessfully=true;
    }
  finally {
      Closeables.close(manifestStream,!readSuccessfully);
    }
  }
 else {
    manifest.getMainAttributes().put(Attributes.Name.MANIFEST_VERSION,"1.0");
  }
  Closer closer=Closer.create();
  try {
    JarOutputStream outputFile=closer.register(new JarOutputStream(new BufferedOutputStream(new FileOutputStream(pathToOutputFile))));
    Set<String> directoryEntriesInsertedIntoOutputJar=Sets.newHashSet();
    for (    String entry : entriesToJar) {
      File file=new File(entry);
      if (file.isFile()) {
        copyZipEntriesToJar(file,outputFile,manifest,directoryEntriesInsertedIntoOutputJar);
      }
 else       if (file.isDirectory()) {
        addFilesInDirectoryToJar(file,outputFile,directoryEntriesInsertedIntoOutputJar);
      }
 else {
        throw new IllegalStateException("Must be a file or directory: " + file);
      }
    }
    if (mainClass != null) {
      manifest.getMainAttributes().put(Attributes.Name.MAIN_CLASS,mainClass);
    }
    JarEntry manifestEntry=new JarEntry(JarFile.MANIFEST_NAME);
    outputFile.putNextEntry(manifestEntry);
    manifest.write(outputFile);
  }
  finally {
    closer.close();
  }
}

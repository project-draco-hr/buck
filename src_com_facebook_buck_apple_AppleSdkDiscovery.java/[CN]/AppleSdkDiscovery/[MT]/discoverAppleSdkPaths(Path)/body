{
  LOG.debug("Searching for Xcode platforms under %s",xcodeDir);
  ImmutableMap.Builder<AppleSdk,AppleSdkPaths> appleSdkPathsBuilder=ImmutableMap.builder();
  Path platforms=xcodeDir.resolve("Platforms");
  if (!Files.exists(platforms)) {
    return appleSdkPathsBuilder.build();
  }
  TreeMultimap<ApplePlatform,ImmutableAppleSdk> orderedSdksForPlatform=TreeMultimap.create(Ordering.natural(),APPLE_SDK_VERSION_ORDERING);
  try (DirectoryStream<Path> platformStream=Files.newDirectoryStream(platforms,"*.platform")){
    for (    Path platformDir : platformStream) {
      LOG.debug("Searching for Xcode SDKs under %s",platformDir);
      try (DirectoryStream<Path> sdkStream=Files.newDirectoryStream(platformDir.resolve("Developer/SDKs"),"*.sdk")){
        for (        Path sdkDir : sdkStream) {
          LOG.debug("Fetching SDK name for %s",sdkDir);
          if (Files.isSymbolicLink(sdkDir)) {
            continue;
          }
          ImmutableAppleSdk.Builder sdkBuilder=ImmutableAppleSdk.builder();
          if (buildSdkFromPath(sdkDir,sdkBuilder)) {
            ImmutableAppleSdk sdk=sdkBuilder.build();
            LOG.debug("Found SDK %s",sdk);
            ImmutableAppleSdkPaths xcodePaths=ImmutableAppleSdkPaths.builder().toolchainPath(xcodeDir.resolve("Toolchains/XcodeDefault.xctoolchain")).platformDeveloperPath(platformDir.resolve("Developer")).sdkPath(sdkDir).build();
            appleSdkPathsBuilder.put(sdk,xcodePaths);
            orderedSdksForPlatform.put(sdk.applePlatform(),sdk);
          }
        }
      }
     }
  }
   ImmutableMap<AppleSdk,AppleSdkPaths> discoveredSdkPaths=appleSdkPathsBuilder.build();
  for (  ApplePlatform platform : orderedSdksForPlatform.keySet()) {
    ImmutableAppleSdk mostRecentSdkForPlatform=orderedSdksForPlatform.get(platform).last();
    appleSdkPathsBuilder.put(mostRecentSdkForPlatform.withName(platform.toString()),discoveredSdkPaths.get(mostRecentSdkForPlatform));
  }
  return appleSdkPathsBuilder.build();
}

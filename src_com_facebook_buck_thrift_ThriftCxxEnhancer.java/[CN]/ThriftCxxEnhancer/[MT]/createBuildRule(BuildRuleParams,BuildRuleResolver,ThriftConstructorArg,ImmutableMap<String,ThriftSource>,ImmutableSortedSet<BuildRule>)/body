{
  SourcePathResolver pathResolver=new SourcePathResolver(resolver);
  CxxHeadersAndSources spec=getThriftHeaderSourceSpec(params,args,sources);
  ImmutableSortedSet<BuildRule> allDeps=ImmutableSortedSet.<BuildRule>naturalOrder().addAll(deps).addAll(resolver.getAllRules((cpp2 ? args.cpp2Deps : args.cppDeps).or(ImmutableSortedSet.<BuildTarget>of()))).build();
  BuildRuleParams langParams=params.copyWithDeps(Suppliers.ofInstance(allDeps),Suppliers.ofInstance(ImmutableSortedSet.<BuildRule>of()));
  ImmutableMap.Builder<String,SourcePath> headersBuilder=ImmutableMap.builder();
  headersBuilder.putAll(spec.getHeaders());
  if (args.cppExportedHeaders.isPresent()) {
    if (args.cppExportedHeaders.get().isRight()) {
      headersBuilder.putAll(args.cppExportedHeaders.get().getRight());
    }
 else {
      headersBuilder.putAll(pathResolver.getSourcePathNames(params.getBuildTarget(),"cpp_headers",args.cppExportedHeaders.get().getLeft()));
    }
  }
  ImmutableMap<String,SourcePath> headers=headersBuilder.build();
  ImmutableMap.Builder<String,SourceWithFlags> srcsBuilder=ImmutableMap.builder();
  srcsBuilder.putAll(spec.getSources());
  if (args.cppSrcs.isPresent()) {
    if (args.cppSrcs.get().isRight()) {
      srcsBuilder.putAll(args.cppSrcs.get().getRight());
    }
 else {
      for (      SourceWithFlags sourceWithFlags : args.cppSrcs.get().getLeft()) {
        srcsBuilder.put(pathResolver.getSourcePathName(params.getBuildTarget(),sourceWithFlags.getSourcePath()),sourceWithFlags);
      }
    }
  }
  ImmutableMap<String,SourceWithFlags> srcs=srcsBuilder.build();
  CxxLibraryDescription.Arg langArgs=CxxLibraryDescription.createEmptyConstructorArg();
  langArgs.headerNamespace=args.cppHeaderNamespace;
  langArgs.srcs=Optional.of(Either.<ImmutableList<SourceWithFlags>,ImmutableMap<String,SourceWithFlags>>ofRight(srcs));
  langArgs.exportedHeaders=Optional.of(Either.<ImmutableList<SourcePath>,ImmutableMap<String,SourcePath>>ofRight(headers));
  return cxxLibraryDescription.createBuildRule(langParams,resolver,langArgs);
}

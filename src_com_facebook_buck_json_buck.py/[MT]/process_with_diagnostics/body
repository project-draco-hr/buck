def process_with_diagnostics(build_file, build_file_processor, to_parent, should_profile=False):
    build_file = cygwin_adjusted_path(build_file)
    diagnostics = set()
    values = []
    if should_profile:
        profile = cProfile.Profile()
        profile.enable()
    else:
        profile = None
    try:
        try:
            values = build_file_processor.process(build_file.rstrip(), diagnostics=diagnostics)
        except Exception as e:
            if (not ((e is KeyboardInterrupt) or (e is SystemExit))):
                diagnostics.add(Diagnostic(message=format_traceback_and_exception(), level='fatal', source='parse'))
            raise e
    finally:
        if (profile is not None):
            profile.disable()
            s = StringIO.StringIO()
            pstats.Stats(profile, stream=s).sort_stats('cumulative').print_stats()
            profile_result = s.getvalue()
        else:
            profile_result = None
        to_parent.write(encode_result(values, diagnostics, profile_result))
        to_parent.flush()

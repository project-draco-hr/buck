{
  IDevice device=getDevice(this.deviceSerial);
  if (device == null) {
    System.err.printf("Unable to get device/emulator with serial %s",this.deviceSerial);
    System.exit(1);
  }
  if (this.instrumentationApkPath != null) {
    device.installPackage(this.instrumentationApkPath,true);
    if (this.apkUnderTestPath != null) {
      device.installPackage(this.apkUnderTestPath,true);
    }
  }
  try {
    RemoteAndroidTestRunner runner=new RemoteAndroidTestRunner(this.packageName,this.testRunner,getDevice(deviceSerial));
    for (    Map.Entry<String,String> entry : this.extraInstrumentationArguments.entrySet()) {
      runner.addInstrumentationArg(entry.getKey(),entry.getValue());
    }
    BuckXmlTestRunListener listener=new BuckXmlTestRunListener();
    listener.setReportDir(this.outputDirectory);
    runner.run(listener);
  }
  finally {
    if (this.attemptUninstall) {
      device.uninstallPackage(this.packageName);
    }
  }
}

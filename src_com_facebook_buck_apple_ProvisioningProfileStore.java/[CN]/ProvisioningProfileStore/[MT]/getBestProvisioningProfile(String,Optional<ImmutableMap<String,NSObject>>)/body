{
  final Optional<String> prefix;
  if (entitlements.isPresent()) {
    prefix=Optional.of(ProvisioningProfileMetadata.prefixFromEntitlements(entitlements.get()));
  }
 else {
    prefix=Optional.<String>absent();
  }
  int bestMatchLength=-1;
  Optional<ProvisioningProfileMetadata> bestMatch=Optional.absent();
  for (  ProvisioningProfileMetadata profile : getProvisioningProfiles()) {
    if (profile.getExpirationDate().after(new Date())) {
      Pair<String,String> appID=profile.getAppID();
      LOG.debug("Looking at provisioning profile " + profile.getUUID() + ","+ appID.toString());
      if (!prefix.isPresent() || prefix.get().equals(appID.getFirst())) {
        String profileBundleID=appID.getSecond();
        boolean match;
        if (profileBundleID.endsWith("*")) {
          profileBundleID=profileBundleID.substring(0,profileBundleID.length() - 1);
          match=bundleID.startsWith(profileBundleID);
        }
 else {
          match=(bundleID.equals(profileBundleID));
        }
        if (entitlements.isPresent()) {
          ImmutableMap<String,NSObject> entitlementsDict=entitlements.get();
          ImmutableMap<String,NSObject> profileEntitlements=profile.getEntitlements();
          for (          Entry<String,NSObject> entry : entitlementsDict.entrySet()) {
            if (!(entry.getKey().equals("keychain-access-groups") || entry.getKey().equals("application-identifier") || entry.getValue().equals(profileEntitlements.get(entry.getKey())))) {
              match=false;
              break;
            }
          }
        }
        if (match && profileBundleID.length() > bestMatchLength) {
          bestMatchLength=profileBundleID.length();
          bestMatch=Optional.of(profile);
        }
      }
    }
  }
  LOG.debug("Found provisioning profile " + bestMatch.toString());
  return bestMatch;
}

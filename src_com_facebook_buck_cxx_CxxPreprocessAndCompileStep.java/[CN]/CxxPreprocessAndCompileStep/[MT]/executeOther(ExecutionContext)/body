{
  ProcessBuilder builder=makeSubprocessBuilder();
  builder.command(getCommand(context.getAnsi().isAnsiTerminal()));
  if (operation == Operation.PREPROCESS) {
    builder.redirectOutput(ProcessBuilder.Redirect.PIPE);
  }
  LOG.debug("Running command (pwd=%s): %s",builder.directory(),getDescription(context));
  Process process=builder.start();
  ByteArrayOutputStream error=new ByteArrayOutputStream();
  int exitCode;
  try {
    try (LineProcessorRunnable errorProcessor=createErrorTransformerFactory(context).createTransformerThread(context,process.getErrorStream(),error)){
      errorProcessor.start();
      if (operation == Operation.PREPROCESS) {
        try (OutputStream output=filesystem.newFileOutputStream(this.output);LineProcessorRunnable outputProcessor=createPreprocessorOutputTransformerFactory().createTransformerThread(context,process.getInputStream(),output)){
          outputProcessor.start();
          outputProcessor.waitFor();
        }
 catch (        Throwable thrown) {
          process.destroy();
          throw thrown;
        }
      }
      errorProcessor.waitFor();
    }
 catch (    Throwable thrown) {
      process.destroy();
      throw thrown;
    }
    exitCode=process.waitFor();
  }
  finally {
    process.destroy();
    process.waitFor();
  }
  String err=new String(error.toByteArray());
  if (!err.isEmpty()) {
    context.getBuckEventBus().post(createConsoleEvent(context,preprocessorCommand.or(compilerCommand).get().supportsColorsInDiagnostics(),exitCode == 0 ? Level.WARNING : Level.SEVERE,err));
  }
  return exitCode;
}

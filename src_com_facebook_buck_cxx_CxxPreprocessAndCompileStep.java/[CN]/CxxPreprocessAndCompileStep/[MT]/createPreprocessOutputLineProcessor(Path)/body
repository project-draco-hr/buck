{
  return new Function<String,String>(){
    private final Pattern lineMarkers=Pattern.compile("^# (?<num>\\d+) \"(?<path>[^\"]+)\"(?<rest>.*)?$");
    @Override public String apply(    String line){
      if (line.startsWith("# ")) {
        Matcher m=lineMarkers.matcher(line);
        if (m.find()) {
          String originalPath=m.group("path");
          String replacementPath=originalPath;
          replacementPath=Optional.fromNullable(replacementPaths.get(Paths.get(replacementPath))).transform(Functions.toStringFunction()).or(replacementPath);
          if (sanitizer.isPresent()) {
            replacementPath=sanitizer.get().sanitize(Optional.of(workingDir),replacementPath);
          }
          if (!originalPath.equals(replacementPath)) {
            String num=m.group("num");
            String rest=m.group("rest");
            return "# " + num + " \""+ replacementPath+ "\""+ rest;
          }
        }
      }
      return line;
    }
  }
;
}

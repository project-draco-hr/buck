{
  return new Function<String,String>(){
    private final Pattern lineMarkers=Pattern.compile("^# (?<num>\\d+) \"(?<path>[^\"]+)\"(?<rest>.*)?$");
    @Override public String apply(    String line){
      if (line.startsWith("# ")) {
        Matcher m=lineMarkers.matcher(line);
        if (m.find() && !SPECIAL_INCLUDE_PATHS.contains(m.group("path"))) {
          String originalPath=m.group("path");
          String replacementPath=originalPath;
          replacementPath=Optional.fromNullable(replacementPaths.get(Paths.get(replacementPath))).transform(Escaper.PATH_FOR_C_INCLUDE_STRING_ESCAPER).or(replacementPath);
          replacementPath=sanitizer.sanitize(Optional.of(workingDir),replacementPath);
          if (!originalPath.equals(replacementPath)) {
            String num=m.group("num");
            String rest=m.group("rest");
            return "# " + num + " \""+ replacementPath+ "\""+ rest;
          }
        }
      }
      return line;
    }
  }
;
}

{
  ImmutableList.Builder<Step> steps=ImmutableList.builder();
  Path outputDir=getOutputDirectory();
  Path fatJarDir=outputDir.resolve("fat-jar-directory");
  steps.add(new MakeCleanDirectoryStep(outputDir));
  ImmutableMap.Builder<String,String> sonameToResourceMapBuilder=ImmutableMap.builder();
  for (  Map.Entry<String,SourcePath> entry : nativeLibraries.entrySet()) {
    String resource=FAT_JAR_NATIVE_LIBRARY_RESOURCE_ROOT + "/" + entry.getKey();
    sonameToResourceMapBuilder.put(entry.getKey(),resource);
    steps.add(new MkdirStep(fatJarDir.resolve(resource).getParent()));
    steps.add(new SymlinkFileStep(getResolver().getPath(entry.getValue()),fatJarDir.resolve(resource),false));
  }
  ImmutableMap<String,String> sonameToResourceMap=sonameToResourceMapBuilder.build();
  Path fatJarInfo=fatJarDir.resolve(FatJar.FAT_JAR_INFO_RESOURCE);
  steps.add(writeFatJarInfo(fatJarInfo,sonameToResourceMap));
  Path fatJarSource=outputDir.resolve(Paths.get(FAT_JAR_SRC_RESOURCE).getFileName());
  steps.add(writeFromResource(fatJarSource,FAT_JAR_SRC_RESOURCE));
  Path fatJarMainSource=outputDir.resolve(Paths.get(FAT_JAR_MAIN_SRC_RESOURCE).getFileName());
  steps.add(writeFromResource(fatJarMainSource,FAT_JAR_MAIN_SRC_RESOURCE));
  steps.add(JavacStepUtil.createJavacStep(fatJarDir,ImmutableSet.of(fatJarSource,fatJarMainSource),ImmutableSet.<Path>of(),ImmutableSet.<Path>of(),javacOptions,Optional.of(getBuildTarget()),BuildDependencies.FIRST_ORDER_ONLY,Optional.<JavacStep.SuggestBuildRules>absent(),Optional.<Path>absent(),getBuildTarget(),Optional.<Path>absent()));
  steps.add(new MkdirStep(fatJarDir.resolve(FAT_JAR_INNER_JAR).getParent()));
  steps.add(new SymlinkFileStep(getResolver().getPath(innerJar),fatJarDir.resolve(FAT_JAR_INNER_JAR),false));
  Path zipped=outputDir.resolve("contents.zip");
  steps.add(new ZipStep(zipped,ImmutableSet.<Path>of(),false,0,fatJarDir));
  steps.add(new JarDirectoryStep(getOutputPath(),ImmutableSet.of(zipped),FatJarMain.class.getName(),null));
  return steps.build();
}

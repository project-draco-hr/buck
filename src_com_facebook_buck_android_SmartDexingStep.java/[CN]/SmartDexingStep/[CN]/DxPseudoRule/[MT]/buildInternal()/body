{
  Preconditions.checkState(newInputsHash != null,"Must call checkIsCached first!");
  List<Step> steps=Lists.newArrayList();
  EnumSet<Option> dxOptions=optimizeDex ? EnumSet.noneOf(DxStep.Option.class) : EnumSet.of(DxStep.Option.NO_OPTIMIZE);
  if (useXzCompression()) {
    String tempDexJarOutput=outputPath.replaceAll("\\.jar\\.xz$",".tmp.jar");
    steps.add(new DxStep(tempDexJarOutput,srcs,dxOptions));
    String repackedJar=outputPath.replaceAll("\\.xz$","");
    steps.add(new RepackZipEntriesStep(tempDexJarOutput,repackedJar,ImmutableSet.of("classes.dex"),ZipStep.MIN_COMPRESSION_LEVEL));
    steps.add(new RmStep(tempDexJarOutput,true));
    steps.add(new XzStep(repackedJar));
  }
 else {
    steps.add(new DxStep(outputPath,srcs,dxOptions));
  }
  steps.add(new WriteFileStep(newInputsHash,outputHashPath));
  return ImmutableList.<Step>of(new CompositeStep(steps));
}

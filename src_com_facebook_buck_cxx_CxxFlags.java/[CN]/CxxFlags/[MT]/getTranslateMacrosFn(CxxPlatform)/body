{
  final ImmutableSortedMap<String,String> flagMacros=ImmutableSortedMap.copyOf(cxxPlatform.getFlagMacros());
  return new RuleKeyAppendableFunction<String,String>(){
    @Override public RuleKeyBuilder appendToRuleKey(    RuleKeyBuilder builder){
      SortedMap<String,String> sanitizedMap=Maps.transformValues(flagMacros,cxxPlatform.getDebugPathSanitizer().sanitize(Optional.<Path>absent()));
      return builder.setReflectively("flagMacros",sanitizedMap);
    }
    @Override public String apply(    String flag){
      for (      Map.Entry<String,String> entry : flagMacros.entrySet()) {
        flag=flag.replace("$" + entry.getKey(),entry.getValue());
      }
      return flag;
    }
  }
;
}

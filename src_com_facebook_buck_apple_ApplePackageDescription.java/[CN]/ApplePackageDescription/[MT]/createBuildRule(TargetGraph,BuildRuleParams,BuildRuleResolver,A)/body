{
  BuildRule bundle=resolver.getRule(propagateFlavorsToTarget(params.getBuildTarget(),args.bundle));
  if (!(bundle instanceof BuildRuleWithAppleBundle)) {
    throw new HumanReadableException("In %s, bundle='%s' must be an apple_bundle() but was %s().",params.getBuildTarget(),bundle.getFullyQualifiedName(),bundle.getType());
  }
  SourcePathResolver sourcePathResolver=new SourcePathResolver(resolver);
  Optional<ApplePackageConfigAndPlatformInfo> applePackageConfigAndPlatformInfo=getApplePackageConfig(params.getBuildTarget());
  if (applePackageConfigAndPlatformInfo.isPresent()) {
    return new ExternallyBuiltApplePackage(params,sourcePathResolver,applePackageConfigAndPlatformInfo.get(),new BuildTargetSourcePath(bundle.getBuildTarget()));
  }
 else {
    return new BuiltinApplePackage(params,sourcePathResolver,((BuildRuleWithAppleBundle)bundle).getAppleBundle());
  }
}

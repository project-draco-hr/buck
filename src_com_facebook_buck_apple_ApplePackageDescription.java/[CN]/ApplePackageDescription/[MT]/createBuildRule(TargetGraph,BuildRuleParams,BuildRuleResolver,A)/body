{
  BuildRule bundle=resolver.getRule(propagateFlavorsToTarget(params.getBuildTarget(),args.bundle));
  if (!(bundle instanceof BuildRuleWithAppleBundle)) {
    throw new HumanReadableException("In %s, bundle='%s' must be an apple_bundle() but was %s().",params.getBuildTarget(),bundle.getFullyQualifiedName(),bundle.getType());
  }
  SourcePathResolver sourcePathResolver=new SourcePathResolver(resolver);
  return new ApplePackage(params,sourcePathResolver,((BuildRuleWithAppleBundle)bundle).getAppleBundle());
}

{
  StringBuilder expanded=new StringBuilder();
  int lastEnd=0;
  Matcher matcher=MACRO_PATTERN.matcher(blob);
  while (matcher.find()) {
    expanded.append(blob.substring(lastEnd,matcher.start()));
    String name=matcher.group(1);
    String input=Optional.fromNullable(matcher.group(2)).or("");
    try {
      expanded.append(getExpander(name).expand(target,resolver,filesystem,input));
    }
 catch (    MacroException e) {
      throw new MacroException(String.format("expanding %s: %s",matcher.group(),e.getMessage()),e);
    }
    lastEnd=matcher.end();
  }
  expanded.append(blob.substring(lastEnd,blob.length()));
  return expanded.toString();
}

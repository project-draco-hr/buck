{
  if (!doStore) {
    return;
  }
  try {
    for (    RuleKey ruleKey : ruleKeys) {
      Path tmp=filesystem.createTempFile(filesystem.resolve(cacheDir),"artifact",".tmp");
      try {
        filesystem.copyFile(output,tmp);
        filesystem.move(tmp,cacheDir.resolve(ruleKey.toString()));
      }
  finally {
        filesystem.deleteFileAtPathIfExists(tmp);
      }
      tmp=filesystem.createTempFile(filesystem.resolve(cacheDir),"metadata",".tmp");
      try {
        try (DataOutputStream out=new DataOutputStream(filesystem.newFileOutputStream(tmp))){
          out.writeInt(metadata.size());
          for (          Map.Entry<String,String> ent : metadata.entrySet()) {
            out.writeUTF(ent.getKey());
            byte[] val=ent.getValue().getBytes(Charsets.UTF_8);
            out.writeInt(val.length);
            out.write(val);
          }
        }
         filesystem.move(tmp,cacheDir.resolve(ruleKey.toString() + ".metadata"));
      }
  finally {
        filesystem.deleteFileAtPathIfExists(tmp);
      }
    }
  }
 catch (  IOException e) {
    LOG.warn(e,"Artifact store(%s, %s) error",ruleKeys,output);
  }
}

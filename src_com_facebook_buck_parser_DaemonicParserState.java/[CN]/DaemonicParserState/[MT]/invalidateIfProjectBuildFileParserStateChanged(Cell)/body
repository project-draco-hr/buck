{
  ImmutableMap<String,String> cellEnv=cell.getBuckConfig().getEnvironment();
  Iterable<String> defaultIncludes=new ParserConfig(cell.getBuckConfig()).getDefaultIncludes();
  boolean invalidateCaches=false;
  try (AutoCloseableLock updateLock=cachedStateLock.updateLock()){
    Iterable<String> expected=cachedIncludes.get(cell.getRoot());
    if (!cachedEnvironment.isPresent()) {
      LOG.debug("Cached environment not present, invalidating caches for first run.");
      invalidateCaches=true;
    }
 else     if (!cellEnv.equals(cachedEnvironment.get())) {
      MapDifference<String,String> diff=Maps.difference(cachedEnvironment.get(),cellEnv);
      LOG.warn("Invalidating cache on environment change (%s)",diff);
      Set<String> environmentChanges=new HashSet<>();
      environmentChanges.addAll(diff.entriesOnlyOnLeft().keySet());
      environmentChanges.addAll(diff.entriesOnlyOnRight().keySet());
      environmentChanges.addAll(diff.entriesDiffering().keySet());
      cacheInvalidatedByEnvironmentVariableChangeCounter.addAll(environmentChanges);
      invalidateCaches=true;
    }
 else     if (expected == null || !Iterables.elementsEqual(defaultIncludes,expected)) {
      invalidateCaches=true;
      LOG.warn("Invalidating cache on default includes change (%s != %s)",expected,defaultIncludes);
      cacheInvalidatedByDefaultIncludesChangeCounter.inc();
    }
    if (!invalidateCaches) {
      return;
    }
    try (AutoCloseableLock writeLock=cachedStateLock.writeLock()){
      cachedEnvironment=Optional.of(cellEnv);
      cachedIncludes.put(cell.getRoot(),defaultIncludes);
    }
   }
 synchronized (this) {
    invalidateAllCaches();
    knownCells.add(cell);
  }
}

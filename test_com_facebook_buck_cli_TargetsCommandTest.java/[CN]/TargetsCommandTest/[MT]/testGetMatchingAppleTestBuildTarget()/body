{
  BuildTarget libraryTarget=BuildTarget.builder("//foo","lib").build();
  TargetNode<?> libraryNode=AppleLibraryBuilder.createBuilder(libraryTarget).setSrcs(Optional.of(ImmutableList.of(AppleSource.ofSourcePath(new TestSourcePath("foo/foo.m"))))).build();
  BuildTarget testLibraryTarget=BuildTarget.builder("//foo","testlib").addFlavor("shared").addFlavor("default").build();
  TargetNode<?> testLibraryNode=AppleLibraryBuilder.createBuilder(testLibraryTarget).setSrcs(Optional.of(ImmutableList.of(AppleSource.ofSourcePath(new TestSourcePath("foo/testfoo.m"))))).setDeps(Optional.of(ImmutableSortedSet.of(libraryTarget))).build();
  BuildTarget testBundleTarget=BuildTarget.builder("//foo","xctest").build();
  TargetNode<?> testBundleNode=AppleBundleBuilder.createBuilder(testBundleTarget).setExtension(Either.<AppleBundleExtension,String>ofLeft(AppleBundleExtension.XCTEST)).setBinary(testLibraryTarget).build();
  BuildTarget testTarget=BuildTarget.builder("//foo","test").build();
  TargetNode<?> testNode=AppleTestBuilder.createBuilder(testTarget).setTestBundle(testBundleTarget).build();
  ImmutableSet<TargetNode<?>> nodes=ImmutableSet.of(libraryNode,testLibraryNode,testBundleNode,testNode);
  TargetGraph targetGraph=TargetGraphFactory.newInstance(nodes);
  ActionGraph actionGraph=targetGraph.getActionGraph();
  SortedMap<String,BuildRule> matchingBuildRules=targetsCommand.getMatchingBuildRules(actionGraph,new TargetsCommandPredicate(targetGraph,ImmutableSet.<BuildRuleType>of(),ImmutableSet.of(Paths.get("foo/bar.m")),Optional.<ImmutableSet<BuildTarget>>absent()));
  assertTrue(matchingBuildRules.isEmpty());
  matchingBuildRules=targetsCommand.getMatchingBuildRules(actionGraph,new TargetsCommandPredicate(targetGraph,ImmutableSet.<BuildRuleType>of(),ImmutableSet.of(Paths.get("foo/foo.m")),Optional.<ImmutableSet<BuildTarget>>absent()));
  assertEquals(ImmutableSet.of("//foo:lib#compile-pic-foo-m-o,default","//foo:lib#default,preprocess-pic-foo-m-mi","//foo:lib#default,shared","//foo:test","//foo:testlib#default,shared","//foo:xctest"),matchingBuildRules.keySet());
  matchingBuildRules=targetsCommand.getMatchingBuildRules(actionGraph,new TargetsCommandPredicate(targetGraph,ImmutableSet.<BuildRuleType>of(),ImmutableSet.of(Paths.get("foo/testfoo.m")),Optional.<ImmutableSet<BuildTarget>>absent()));
  assertEquals(ImmutableSet.of("//foo:test","//foo:testlib#compile-pic-testfoo-m-o,default","//foo:testlib#default,preprocess-pic-testfoo-m-mi","//foo:testlib#default,shared","//foo:xctest"),matchingBuildRules.keySet());
}

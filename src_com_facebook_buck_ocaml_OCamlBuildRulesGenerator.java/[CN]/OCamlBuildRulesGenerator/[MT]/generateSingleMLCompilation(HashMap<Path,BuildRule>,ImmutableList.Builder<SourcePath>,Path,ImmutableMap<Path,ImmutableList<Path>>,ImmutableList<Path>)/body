{
  ImmutableList<Path> newCycleDetector=ImmutableList.<Path>builder().addAll(cycleDetector).add(mlSource).build();
  if (cycleDetector.contains(mlSource)) {
    throw new HumanReadableException("Dependency cycle detected: %s",Joiner.on(" -> ").join(newCycleDetector));
  }
  if (sourceToRule.containsKey(mlSource)) {
    return;
  }
  ImmutableList.Builder<BuildRule> deps=ImmutableList.builder();
  if (sources.containsKey(mlSource)) {
    for (    Path dep : Preconditions.checkNotNull(sources.get(mlSource))) {
      generateSingleMLCompilation(sourceToRule,cmxFiles,dep,sources,newCycleDetector);
      deps.add(sourceToRule.get(dep));
    }
  }
  String name=mlSource.toFile().getName();
  BuildTarget buildTarget=createMLCompileBuildTarget(params.getBuildTarget(),name);
  BuildRuleParams compileParams=params.copyWithChanges(OCAML_ML_COMPILE_TYPE,buildTarget,Suppliers.ofInstance(ImmutableSortedSet.<BuildRule>naturalOrder().addAll(params.getDeclaredDeps()).addAll(deps.build()).build()),Suppliers.ofInstance(params.getExtraDeps()));
  String outputFileName=getMLOutputName(name);
  Path outputPath=ocamlContext.getCompileOutputDir().resolve(outputFileName);
  final ImmutableList<String> compileFlags=getCompileFlags(false,false);
  OCamlMLCompile compile=new OCamlMLCompile(compileParams,pathResolver,new OCamlMLCompileStep.Args(cCompiler.getCommandPrefix(pathResolver),ocamlContext.getOcamlCompiler(),outputPath,mlSource,compileFlags));
  resolver.addToIndex(compile);
  sourceToRule.put(mlSource,compile);
  if (!outputFileName.endsWith(OCamlCompilables.OCAML_CMI)) {
    cmxFiles.add(new BuildTargetSourcePath(compile.getProjectFilesystem(),compile.getBuildTarget()));
  }
}

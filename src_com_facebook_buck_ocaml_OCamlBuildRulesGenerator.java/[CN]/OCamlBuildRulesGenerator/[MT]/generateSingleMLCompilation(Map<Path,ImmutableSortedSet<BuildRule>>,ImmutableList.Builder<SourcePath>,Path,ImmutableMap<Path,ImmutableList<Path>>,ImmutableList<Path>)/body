{
  ImmutableList<Path> newCycleDetector=ImmutableList.<Path>builder().addAll(cycleDetector).add(mlSource).build();
  if (cycleDetector.contains(mlSource)) {
    throw new HumanReadableException("Dependency cycle detected: %s",Joiner.on(" -> ").join(newCycleDetector));
  }
  if (sourceToRule.containsKey(mlSource)) {
    return;
  }
  ImmutableSortedSet.Builder<BuildRule> depsBuilder=ImmutableSortedSet.naturalOrder();
  if (sources.containsKey(mlSource)) {
    for (    Path dep : checkNotNull(sources.get(mlSource))) {
      generateSingleMLCompilation(sourceToRule,cmxFiles,dep,sources,newCycleDetector);
      depsBuilder.addAll(checkNotNull(sourceToRule.get(dep)));
    }
  }
  ImmutableSortedSet<BuildRule> deps=depsBuilder.build();
  String name=mlSource.toFile().getName();
  BuildTarget buildTarget=createMLCompileBuildTarget(params.getBuildTarget(),name);
  BuildRuleParams compileParams=params.copyWithChanges(buildTarget,Suppliers.ofInstance(ImmutableSortedSet.<BuildRule>naturalOrder().addAll(params.getDeclaredDeps().get()).addAll(deps).addAll(ocamlContext.getCompileDeps()).build()),params.getExtraDeps());
  String outputFileName=getMLOutputName(name);
  Path outputPath=ocamlContext.getCompileOutputDir().resolve(outputFileName);
  final ImmutableList<String> compileFlags=getCompileFlags(false,false);
  OCamlMLCompile compile=new OCamlMLCompile(compileParams,pathResolver,new OCamlMLCompileStep.Args(cCompiler.getCommandPrefix(pathResolver),ocamlContext.getOcamlCompiler().get(),outputPath,mlSource,compileFlags));
  resolver.addToIndex(compile);
  sourceToRule.put(mlSource,ImmutableSortedSet.<BuildRule>naturalOrder().add(compile).addAll(deps).build());
  if (!outputFileName.endsWith(OCamlCompilables.OCAML_CMI)) {
    cmxFiles.add(new BuildTargetSourcePath(compile.getBuildTarget()));
  }
}

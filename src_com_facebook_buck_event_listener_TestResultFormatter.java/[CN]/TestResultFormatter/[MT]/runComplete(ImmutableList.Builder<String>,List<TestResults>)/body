{
  boolean isAllTestsPassed=true;
  boolean isAnyAssumptionViolated=false;
  ListMultimap<TestResults,TestCaseSummary> failingTests=ArrayListMultimap.create();
  int numFailures=0;
  for (  TestResults summary : completedResults) {
    if (!summary.isSuccess()) {
      isAllTestsPassed=false;
      numFailures+=summary.getFailureCount();
      failingTests.putAll(summary,summary.getFailures());
    }
    for (    TestCaseSummary testCaseSummary : summary.getTestCases()) {
      if (testCaseSummary.hasAssumptionViolations()) {
        isAnyAssumptionViolated=true;
        break;
      }
    }
  }
  if (completedResults.isEmpty()) {
    addTo.add(ansi.asHighlightedFailureText("NO TESTS RAN"));
  }
 else   if (isAllTestsPassed) {
    if (isAnyAssumptionViolated) {
      addTo.add(ansi.asHighlightedWarningText("TESTS PASSED (with some assumption violations)"));
    }
 else {
      addTo.add(ansi.asHighlightedSuccessText("TESTS PASSED"));
    }
  }
 else {
    addTo.add(ansi.asHighlightedFailureText(String.format("TESTS FAILED: %d %s",numFailures,numFailures == 1 ? "FAILURE" : "FAILURES")));
    for (    TestResults results : failingTests.keySet()) {
      addTo.add("Failed target: " + results.getBuildTarget().getFullyQualifiedName());
      for (      TestCaseSummary summary : failingTests.get(results)) {
        addTo.add(summary.toString());
      }
    }
  }
}

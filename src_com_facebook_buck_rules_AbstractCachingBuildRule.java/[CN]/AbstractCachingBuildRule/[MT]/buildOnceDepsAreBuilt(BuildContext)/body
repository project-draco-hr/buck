{
  if (this instanceof AbiRule) {
    AbiRule abiRule=(AbiRule)this;
    RuleKey ruleKeyNoDeps=abiRule.getRuleKeyWithoutDeps();
    RuleKey cachedRuleKeyNoDeps=abiRule.getRuleKeyWithoutDepsOnDisk();
    if (ruleKeyNoDeps != null && ruleKeyNoDeps.equals(cachedRuleKeyNoDeps)) {
      String abiKeyForDeps=abiRule.getAbiKeyForDeps();
      String cachedAbiKeyForDeps=abiRule.getAbiKeyForDepsOnDisk();
      if (abiKeyForDeps != null && abiKeyForDeps.equals(cachedAbiKeyForDeps)) {
        buildRuleResult.set(new BuildRuleSuccess(this,BuildRuleSuccess.Type.MATCHING_DEPS_ABI_AND_RULE_KEY_NO_DEPS));
        return;
      }
    }
  }
  RuleKey ruleKey=getRuleKey();
  Optional<RuleKey> cachedRuleKey=getRuleKeyOnDisk(context.getProjectFilesystem());
  if (cachedRuleKey.isPresent() && ruleKey.equals(cachedRuleKey.get())) {
    logger.info(String.format("[UNCHANGED %s]",getFullyQualifiedName()));
    buildRuleResult.set(new BuildRuleSuccess(this,BuildRuleSuccess.Type.MATCHING_RULE_KEY));
    return;
  }
  context.getEventBus().post(BuildEvents.buildRuleStarted(this));
  ProjectFilesystem projectFilesystem=context.getProjectFilesystem();
  String pathToOutputFile=getPathToOutputFile();
  boolean fromCache=pathToOutputFile != null && context.getArtifactCache().fetch(getRuleKey(),projectFilesystem.getFileForRelativePath(pathToOutputFile));
  CacheResult cacheResult=fromCache ? CacheResult.HIT : CacheResult.MISS;
  if (!fromCache) {
    try {
      executeCommandsNowThatDepsAreBuilt(context);
    }
 catch (    IOException|StepFailedException e) {
      buildRuleResult.setException(e);
      context.getEventBus().post(BuildEvents.buildRuleFinished(this,BuildRuleStatus.FAIL,cacheResult));
      return;
    }
  }
  try {
    recordBuildRuleCompleted(projectFilesystem,context.getArtifactCache(),fromCache);
  }
 catch (  IOException e) {
    buildRuleResult.setException(e);
    context.getEventBus().post(BuildEvents.buildRuleFinished(this,BuildRuleStatus.FAIL,cacheResult));
    return;
  }
  BuildRuleSuccess.Type successType=fromCache ? BuildRuleSuccess.Type.FETCHED_FROM_CACHE : BuildRuleSuccess.Type.BUILT_LOCALLY;
  buildRuleResult.set(new BuildRuleSuccess(this,successType));
  context.getEventBus().post(BuildEvents.buildRuleFinished(this,BuildRuleStatus.SUCCESS,cacheResult));
  return;
}

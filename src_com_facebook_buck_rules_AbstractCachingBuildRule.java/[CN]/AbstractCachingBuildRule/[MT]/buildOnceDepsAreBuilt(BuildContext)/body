{
  EventBus eventBus=context.getEventBus();
  eventBus.post(BuildEvents.buildRuleStarted(AbstractCachingBuildRule.this));
  if (this instanceof AbiRule) {
    AbiRule abiRule=(AbiRule)this;
    RuleKey ruleKeyNoDeps=abiRule.getRuleKeyWithoutDeps();
    RuleKey cachedRuleKeyNoDeps=abiRule.getRuleKeyWithoutDepsOnDisk();
    if (ruleKeyNoDeps != null && ruleKeyNoDeps.equals(cachedRuleKeyNoDeps)) {
      String abiKeyForDeps=abiRule.getAbiKeyForDeps();
      String cachedAbiKeyForDeps=abiRule.getAbiKeyForDepsOnDisk();
      if (abiKeyForDeps != null && abiKeyForDeps.equals(cachedAbiKeyForDeps)) {
        recordBuildRuleSuccess(BuildRuleSuccess.Type.MATCHING_DEPS_ABI_AND_RULE_KEY_NO_DEPS,BuildRuleStatus.SUCCESS,CacheResult.HIT,eventBus);
        return;
      }
    }
  }
  RuleKey ruleKey=getRuleKey();
  Optional<RuleKey> cachedRuleKey=getRuleKeyOnDisk(context.getProjectFilesystem());
  if (cachedRuleKey.isPresent() && ruleKey.equals(cachedRuleKey.get())) {
    context.logBuildInfo("[UNCHANGED %s]",getFullyQualifiedName());
    recordBuildRuleSuccess(BuildRuleSuccess.Type.MATCHING_RULE_KEY,BuildRuleStatus.SUCCESS,CacheResult.HIT,eventBus);
    return;
  }
  ProjectFilesystem projectFilesystem=context.getProjectFilesystem();
  String pathToOutputFile=getPathToOutputFile();
  boolean fromCache=pathToOutputFile != null && context.getArtifactCache().fetch(getRuleKey(),projectFilesystem.getFileForRelativePath(pathToOutputFile));
  CacheResult cacheResult=fromCache ? CacheResult.HIT : CacheResult.MISS;
  if (!fromCache) {
    try {
      executeCommandsNowThatDepsAreBuilt(context);
    }
 catch (    IOException|StepFailedException e) {
      recordBuildRuleFailure(e,BuildRuleStatus.FAIL,cacheResult,eventBus);
      return;
    }
  }
  try {
    recordBuildRuleCompleted(projectFilesystem,context.getArtifactCache(),fromCache);
  }
 catch (  IOException e) {
    recordBuildRuleFailure(e,BuildRuleStatus.FAIL,cacheResult,eventBus);
    return;
  }
  BuildRuleSuccess.Type successType=fromCache ? BuildRuleSuccess.Type.FETCHED_FROM_CACHE : BuildRuleSuccess.Type.BUILT_LOCALLY;
  recordBuildRuleSuccess(successType,BuildRuleStatus.SUCCESS,cacheResult,eventBus);
  return;
}

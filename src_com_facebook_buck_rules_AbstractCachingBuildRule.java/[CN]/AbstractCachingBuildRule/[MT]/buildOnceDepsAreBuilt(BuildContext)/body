{
  BuckEventBus eventBus=context.getEventBus();
  ProjectFilesystem projectFilesystem=getProjectFilesystemFromBuildContext(context);
  eventBus.post(BuildRuleEvent.started(AbstractCachingBuildRule.this));
  if (this instanceof AbiRule) {
    AbiRule abiRule=(AbiRule)this;
    RuleKey ruleKeyNoDeps=abiRule.getRuleKeyWithoutDeps();
    Optional<RuleKey> cachedRuleKeyNoDeps=abiRule.getRuleKeyWithoutDepsOnDisk(projectFilesystem);
    if (ruleKeyNoDeps.equals(cachedRuleKeyNoDeps.orNull())) {
      Optional<Sha1HashCode> abiKeyForDeps=abiRule.getAbiKeyForDeps();
      Optional<Sha1HashCode> cachedAbiKeyForDeps=abiRule.getAbiKeyForDepsOnDisk(projectFilesystem);
      if (abiKeyForDeps.isPresent() && abiKeyForDeps.equals(cachedAbiKeyForDeps) && abiRule.initializeFromDisk(projectFilesystem)) {
        try {
          writeSuccessFile(projectFilesystem);
        }
 catch (        IOException e) {
          recordBuildRuleFailure(e,BuildRuleStatus.FAIL,CacheResult.HIT,eventBus);
          return;
        }
        recordBuildRuleSuccess(BuildRuleSuccess.Type.MATCHING_DEPS_ABI_AND_RULE_KEY_NO_DEPS,BuildRuleStatus.SUCCESS,CacheResult.HIT,eventBus);
        return;
      }
    }
  }
  RuleKey ruleKey=getRuleKey();
  Optional<RuleKey> cachedRuleKey=getRuleKeyOnDisk(projectFilesystem);
  if (cachedRuleKey.isPresent() && ruleKey.equals(cachedRuleKey.get())) {
    initializeFromDisk(projectFilesystem);
    context.logBuildInfo("[UNCHANGED %s]",getFullyQualifiedName());
    recordBuildRuleSuccess(BuildRuleSuccess.Type.MATCHING_RULE_KEY,BuildRuleStatus.SUCCESS,CacheResult.HIT,eventBus);
    return;
  }
  String pathToOutputFile=buildable.getPathToOutputFile();
  boolean fromCache=pathToOutputFile != null && context.getArtifactCache().fetch(ruleKey,projectFilesystem.getFileForRelativePath(pathToOutputFile));
  CacheResult cacheResult=fromCache ? CacheResult.HIT : CacheResult.MISS;
  if (fromCache) {
    try {
      buildable.recordOutputFileDetailsAfterFetchFromArtifactCache(context.getArtifactCache(),projectFilesystem);
    }
 catch (    IOException e) {
      recordBuildRuleFailure(e,BuildRuleStatus.FAIL,cacheResult,eventBus);
      return;
    }
  }
  if (!fromCache) {
    try {
      executeCommandsNowThatDepsAreBuilt(context);
    }
 catch (    IOException|StepFailedException e) {
      recordBuildRuleFailure(e,BuildRuleStatus.FAIL,cacheResult,eventBus);
      return;
    }
  }
  try {
    recordBuildRuleCompleted(projectFilesystem,context.getArtifactCache(),fromCache);
  }
 catch (  IOException e) {
    recordBuildRuleFailure(e,BuildRuleStatus.FAIL,cacheResult,eventBus);
    return;
  }
  BuildRuleSuccess.Type successType=fromCache ? BuildRuleSuccess.Type.FETCHED_FROM_CACHE : BuildRuleSuccess.Type.BUILT_LOCALLY;
  recordBuildRuleSuccess(successType,BuildRuleStatus.SUCCESS,cacheResult,eventBus);
  return;
}

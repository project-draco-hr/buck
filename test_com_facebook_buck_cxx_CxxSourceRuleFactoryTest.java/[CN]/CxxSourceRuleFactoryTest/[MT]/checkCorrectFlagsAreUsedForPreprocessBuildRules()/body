{
  BuildRuleResolver buildRuleResolver=new BuildRuleResolver();
  SourcePathResolver sourcePathResolver=new SourcePathResolver(buildRuleResolver);
  BuildTarget target=BuildTargetFactory.newInstance("//:target");
  BuildRuleParams params=BuildRuleParamsFactory.createTrivialBuildRuleParams(target);
  ProjectFilesystem filesystem=new AllExistingProjectFilesystem();
  Joiner space=Joiner.on(" ");
  ImmutableList<String> explicitCppflags=ImmutableList.of("-explicit-cppflag");
  ImmutableList<String> explicitCxxppflags=ImmutableList.of("-explicit-cxxppflag");
  CxxPreprocessorInput cxxPreprocessorInput=CxxPreprocessorInput.builder().putAllPreprocessorFlags(CxxSource.Type.C,explicitCppflags).putAllPreprocessorFlags(CxxSource.Type.CXX,explicitCxxppflags).build();
  ImmutableList<String> asppflags=ImmutableList.of("-asppflag","-asppflag");
  SourcePath cpp=new TestSourcePath("cpp");
  ImmutableList<String> cppflags=ImmutableList.of("-cppflag","-cppflag");
  SourcePath cxxpp=new TestSourcePath("cxxpp");
  ImmutableList<String> cxxppflags=ImmutableList.of("-cxxppflag","-cxxppflag");
  FakeBuckConfig buckConfig=new FakeBuckConfig(ImmutableMap.of("cxx",ImmutableMap.<String,String>builder().put("asppflags",space.join(asppflags)).put("cpp",sourcePathResolver.getPath(cpp).toString()).put("cppflags",space.join(cppflags)).put("cxxpp",sourcePathResolver.getPath(cxxpp).toString()).put("cxxppflags",space.join(cxxppflags)).build()),filesystem);
  CxxPlatform platform=DefaultCxxPlatforms.build(new CxxBuckConfig(buckConfig));
  CxxSourceRuleFactory cxxSourceRuleFactory=new CxxSourceRuleFactory(params,buildRuleResolver,sourcePathResolver,platform,cxxPreprocessorInput,ImmutableList.<String>of());
  String cSourceName="test.c";
  List<String> perFileFlagsForTestC=ImmutableList.of("-per-file-flag-for-c-file","-and-another-one");
  CxxSource cSource=CxxSource.of(CxxSource.Type.C,new TestSourcePath(cSourceName),perFileFlagsForTestC);
  CxxPreprocessAndCompile cPreprocess=cxxSourceRuleFactory.requirePreprocessBuildRule(buildRuleResolver,cSourceName,cSource,CxxSourceRuleFactory.PicType.PDC);
  assertContains(cPreprocess.getPreprocessorFlags().get(),explicitCppflags);
  assertContains(cPreprocess.getPreprocessorFlags().get(),cppflags);
  assertContains(cPreprocess.getPreprocessorFlags().get(),perFileFlagsForTestC);
  CxxPreprocessAndCompile cPreprocessAndCompile=cxxSourceRuleFactory.requirePreprocessAndCompileBuildRule(buildRuleResolver,cSourceName,cSource,CxxSourceRuleFactory.PicType.PDC,CxxPreprocessMode.SEPARATE);
  assertContains(cPreprocessAndCompile.getCompilerFlags().get(),perFileFlagsForTestC);
  String cxxSourceName="test.cpp";
  List<String> perFileFlagsForTestCpp=ImmutableList.of("-per-file-flag-for-cpp-file");
  CxxSource cxxSource=CxxSource.of(CxxSource.Type.CXX,new TestSourcePath(cxxSourceName),perFileFlagsForTestCpp);
  CxxPreprocessAndCompile cxxPreprocess=cxxSourceRuleFactory.requirePreprocessBuildRule(buildRuleResolver,cxxSourceName,cxxSource,CxxSourceRuleFactory.PicType.PDC);
  assertContains(cxxPreprocess.getPreprocessorFlags().get(),explicitCxxppflags);
  assertContains(cxxPreprocess.getPreprocessorFlags().get(),cxxppflags);
  assertContains(cxxPreprocess.getPreprocessorFlags().get(),perFileFlagsForTestCpp);
  CxxPreprocessAndCompile cxxPreprocessAndCompile=cxxSourceRuleFactory.requirePreprocessAndCompileBuildRule(buildRuleResolver,cxxSourceName,cxxSource,CxxSourceRuleFactory.PicType.PDC,CxxPreprocessMode.SEPARATE);
  assertContains(cxxPreprocessAndCompile.getCompilerFlags().get(),perFileFlagsForTestCpp);
  String assemblerWithCppSourceName="test.S";
  List<String> perFileFlagsForTestS=ImmutableList.of("-a-flag-for-s-file","-another-one","-one-more");
  CxxSource assemblerWithCppSource=CxxSource.of(CxxSource.Type.ASSEMBLER_WITH_CPP,new TestSourcePath(assemblerWithCppSourceName),perFileFlagsForTestS);
  CxxPreprocessAndCompile assemblerWithCppPreprocess=cxxSourceRuleFactory.requirePreprocessBuildRule(buildRuleResolver,assemblerWithCppSourceName,assemblerWithCppSource,CxxSourceRuleFactory.PicType.PDC);
  assertContains(assemblerWithCppPreprocess.getPreprocessorFlags().get(),asppflags);
  assertContains(assemblerWithCppPreprocess.getPreprocessorFlags().get(),perFileFlagsForTestS);
  CxxPreprocessAndCompile assemblerWithCppPreprocessAndCompile=cxxSourceRuleFactory.requirePreprocessAndCompileBuildRule(buildRuleResolver,assemblerWithCppSourceName,assemblerWithCppSource,CxxSourceRuleFactory.PicType.PDC,CxxPreprocessMode.SEPARATE);
  assertContains(assemblerWithCppPreprocessAndCompile.getCompilerFlags().get(),perFileFlagsForTestS);
}

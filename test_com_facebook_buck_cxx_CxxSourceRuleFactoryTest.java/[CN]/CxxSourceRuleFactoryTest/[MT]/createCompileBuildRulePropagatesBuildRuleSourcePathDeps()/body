{
  BuildTarget target=BuildTargetFactory.newInstance("//foo:bar");
  BuildRuleParams params=new FakeBuildRuleParamsBuilder(target).build();
  BuildRuleResolver resolver=new BuildRuleResolver(TargetGraph.EMPTY,new BuildTargetNodeToBuildRuleTransformer());
  FakeBuildRule dep=createFakeBuildRule("//:test",new SourcePathResolver(resolver));
  resolver.addToIndex(dep);
  SourcePath input=new BuildTargetSourcePath(dep.getBuildTarget());
  CxxSourceRuleFactory cxxSourceRuleFactory=new CxxSourceRuleFactory(params,resolver,new SourcePathResolver(resolver),CXX_PLATFORM,ImmutableList.<CxxPreprocessorInput>of(),ImmutableList.<String>of(),Optional.<SourcePath>absent());
  String nameCompile="foo/bar.ii";
  CxxSource cxxSourceCompile=CxxSource.of(CxxSource.Type.CXX_CPP_OUTPUT,input,ImmutableList.<String>of());
  CxxPreprocessAndCompile cxxCompile=cxxSourceRuleFactory.requireCompileBuildRule(resolver,nameCompile,cxxSourceCompile,CxxSourceRuleFactory.PicType.PDC);
  assertEquals(ImmutableSortedSet.<BuildRule>of(dep),cxxCompile.getDeps());
  String namePreprocessAndCompile="foo/bar.cpp";
  CxxSource cxxSourcePreprocessAndCompile=CxxSource.of(CxxSource.Type.CXX,input,ImmutableList.<String>of());
  CxxPreprocessAndCompile cxxPreprocessAndCompile=cxxSourceRuleFactory.requirePreprocessAndCompileBuildRule(resolver,namePreprocessAndCompile,cxxSourcePreprocessAndCompile,CxxSourceRuleFactory.PicType.PDC,CxxPreprocessMode.SEPARATE);
  assertEquals(ImmutableSortedSet.<BuildRule>of(dep),cxxPreprocessAndCompile.getDeps());
}

{
  BuildTarget target=BuildTargetFactory.newInstance("//foo:bar");
  BuildRuleParams params=new FakeBuildRuleParamsBuilder(target).build();
  BuildRuleResolver resolver=new BuildRuleResolver(TargetGraph.EMPTY,new BuildTargetNodeToBuildRuleTransformer());
  CxxSourceRuleFactory cxxSourceRuleFactoryPDC=new CxxSourceRuleFactory(params,resolver,new SourcePathResolver(resolver),CXX_PLATFORM,ImmutableList.<CxxPreprocessorInput>of(),ImmutableList.<String>of(),Optional.<SourcePath>absent(),CxxSourceRuleFactory.PicType.PDC);
  CxxSourceRuleFactory cxxSourceRuleFactoryPIC=new CxxSourceRuleFactory(params,resolver,new SourcePathResolver(resolver),CXX_PLATFORM,ImmutableList.<CxxPreprocessorInput>of(),ImmutableList.<String>of(),Optional.<SourcePath>absent(),CxxSourceRuleFactory.PicType.PIC);
  String name="foo/bar.ii";
  CxxSource cxxSource=CxxSource.of(CxxSource.Type.CXX_CPP_OUTPUT,new FakeSourcePath(name),ImmutableList.<String>of());
  CxxPreprocessAndCompile noPicCompile=cxxSourceRuleFactoryPDC.requireCompileBuildRule(resolver,name,cxxSource);
  assertFalse(noPicCompile.makeMainStep().getCommand().contains("-fPIC"));
  assertEquals(cxxSourceRuleFactoryPDC.createCompileBuildTarget(name),noPicCompile.getBuildTarget());
  CxxPreprocessAndCompile picCompile=cxxSourceRuleFactoryPIC.requireCompileBuildRule(resolver,name,cxxSource);
  assertTrue(picCompile.makeMainStep().getCommand().contains("-fPIC"));
  assertEquals(cxxSourceRuleFactoryPIC.createCompileBuildTarget(name),picCompile.getBuildTarget());
  name="foo/bar.cpp";
  cxxSource=CxxSource.of(CxxSource.Type.CXX,new FakeSourcePath(name),ImmutableList.<String>of());
  CxxPreprocessAndCompile noPicPreprocessAndCompile=cxxSourceRuleFactoryPDC.requirePreprocessAndCompileBuildRule(resolver,name,cxxSource,CxxPreprocessMode.SEPARATE);
  assertFalse(noPicPreprocessAndCompile.makeMainStep().getCommand().contains("-fPIC"));
  assertEquals(cxxSourceRuleFactoryPDC.createCompileBuildTarget(name),noPicPreprocessAndCompile.getBuildTarget());
  CxxPreprocessAndCompile picPreprocessAndCompile=cxxSourceRuleFactoryPIC.requirePreprocessAndCompileBuildRule(resolver,name,cxxSource,CxxPreprocessMode.SEPARATE);
  assertTrue(picPreprocessAndCompile.makeMainStep().getCommand().contains("-fPIC"));
  assertEquals(cxxSourceRuleFactoryPIC.createCompileBuildTarget(name),picPreprocessAndCompile.getBuildTarget());
}

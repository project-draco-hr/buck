{
  List<String> lines=Lists.newArrayList();
  lines.add("#!/bin/sh");
  lines.add("set -e");
  int levelsBelowRoot=outputFile.getNameCount() - 1;
  String pathBackToRoot=Joiner.on("/").join(Collections.nCopies(levelsBelowRoot,".."));
  lines.add(String.format("BUCK_REAL_ROOT=\"$(cd `dirname $0`/%s; pwd)\"",pathBackToRoot));
  lines.add("BUCK_TMP_ROOT=`mktemp -d -t sh_binary.XXXXXXXXXX`");
  lines.add("trap \"chmod -R 755 $BUCK_TMP_ROOT " + "&& rm -rf $BUCK_TMP_ROOT\" EXIT HUP INT TERM");
  lines.add("cd $BUCK_TMP_ROOT");
  createSymlinkCommands(resources,lines);
  lines.add("find $BUCK_TMP_ROOT -type d -exec chmod 555 {} \\;");
  lines.add("find $BUCK_TMP_ROOT -type f -exec chmod 444 {} \\;");
  lines.add(String.format("BUCK_PROJECT_ROOT=$BUCK_TMP_ROOT \"$BUCK_REAL_ROOT\"/%s \"$@\"",Escaper.escapeAsBashString(scriptToRun)));
  File output=context.getProjectFilesystem().getFileForRelativePath(outputFile.toString());
  try {
    Files.write(Joiner.on('\n').join(lines) + '\n',output,Charsets.UTF_8);
  }
 catch (  IOException e) {
    e.printStackTrace(context.getStdErr());
    return 1;
  }
  if (output.setExecutable(true,false)) {
    return 0;
  }
 else {
    context.getConsole().printErrorText("Failed to set file as executable: " + output);
    return 1;
  }
}

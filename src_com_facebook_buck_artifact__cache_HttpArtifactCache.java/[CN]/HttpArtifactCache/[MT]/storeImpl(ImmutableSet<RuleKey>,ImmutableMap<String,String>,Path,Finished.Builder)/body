{
  Request.Builder builder=new Request.Builder();
  builder.url(new URL(url,"artifacts/key"));
  final byte[] rawKeys=createKeysHeader(ruleKeys);
  final byte[] rawMetadata=createMetadataHeader(ruleKeys,metadata,new ByteSource(){
    @Override public InputStream openStream() throws IOException {
      return projectFilesystem.newFileInputStream(file);
    }
  }
,hashFunction);
  final long fileSizeBytes=projectFilesystem.getFileSize(file);
  final long contentLength=rawKeys.length + Integer.SIZE / Byte.SIZE + rawMetadata.length + fileSizeBytes;
  eventBuilder.setArtifactSizeBytes(fileSizeBytes);
  eventBuilder.setRequestSizeBytes(contentLength);
  builder.put(new RequestBody(){
    @Override public MediaType contentType(){
      return OCTET_STREAM;
    }
    @Override public long contentLength() throws IOException {
      return contentLength;
    }
    @Override public void writeTo(    BufferedSink bufferedSink) throws IOException {
      bufferedSink.write(rawKeys);
      bufferedSink.writeInt(rawMetadata.length);
      bufferedSink.write(rawMetadata);
      Hasher hasher=hashFunction.newHasher();
      try (InputStream is=new HasherInputStream(hasher,projectFilesystem.newSource(file).inputStream())){
        ByteStreams.copy(is,bufferedSink.outputStream());
        eventBuilder.setArtifactContentHash(hasher.hash().toString());
      }
     }
  }
);
  Request request=builder.build();
  Response response=storeCall(request);
  final boolean requestFailed=response.code() != HttpURLConnection.HTTP_ACCEPTED;
  if (requestFailed) {
    reportFailure("store(%s, %s): unexpected response: %d",url,ruleKeys,response.code());
  }
  eventBuilder.setWasUploadSuccessful(!requestFailed);
}

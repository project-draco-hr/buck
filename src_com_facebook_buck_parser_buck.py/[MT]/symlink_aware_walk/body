def symlink_aware_walk(base):
    ' Recursive symlink aware version of `os.walk`.\n\n  Will not traverse a symlink that refers to a previously visited ancestor of\n  the current directory.\n  '
    visited_dirs = set()
    for entry in os.walk(base, topdown=True, followlinks=True):
        (root, dirs, _files) = entry
        realdirpath = os.path.realpath(root)
        if (realdirpath in visited_dirs):
            absdirpath = os.path.abspath(root)
            if absdirpath.startswith(realdirpath):
                dirs[:] = []
                continue
        visited_dirs.add(realdirpath)
        yield entry
    raise StopIteration

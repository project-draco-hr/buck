{
  LOG.debug("Getting ordered test target nodes for %s",orderedTargetNodes);
  ImmutableSet.Builder<TargetNode<?>> testsBuilder=ImmutableSet.builder();
  if (projectGeneratorOptions.contains(ProjectGenerator.Option.INCLUDE_TESTS)) {
    for (    TargetNode<?> node : orderedTargetNodes) {
      testsBuilder.addAll(sourceTargetToTestNodes.get(node.getBuildTarget()));
      if (!(node.getConstructorArg() instanceof HasTests)) {
        continue;
      }
      for (      BuildTarget explicitTestTarget : ((HasTests)node.getConstructorArg()).getTests()) {
        TargetNode<?> explicitTestNode=targetGraph.get(explicitTestTarget);
        if (explicitTestNode != null) {
          testsBuilder.add(explicitTestNode);
        }
 else {
          throw new HumanReadableException("Test target %s is not in the target graph!",explicitTestTarget);
        }
      }
    }
  }
  for (  TargetNode<?> extraTestTarget : extraTestBundleTargets) {
    if (AppleBuildRules.isXcodeTargetTestBundleTargetNode(extraTestTarget)) {
      testsBuilder.add(extraTestTarget);
    }
 else {
      throw new HumanReadableException("Test target %s must be apple_bundle with a test extension!",extraTestTarget);
    }
  }
  return testsBuilder.build();
}

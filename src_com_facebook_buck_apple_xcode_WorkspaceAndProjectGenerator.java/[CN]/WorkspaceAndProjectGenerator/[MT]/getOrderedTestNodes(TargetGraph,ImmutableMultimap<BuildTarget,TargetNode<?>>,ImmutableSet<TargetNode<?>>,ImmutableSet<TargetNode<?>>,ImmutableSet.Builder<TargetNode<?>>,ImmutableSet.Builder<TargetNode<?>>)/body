{
  LOG.debug("Getting ordered test target nodes for %s",orderedTargetNodes);
  final ImmutableSet.Builder<TargetNode<?>> recursiveTestTargetNodesBuilder=ImmutableSet.builder();
  if (projectGeneratorOptions.contains(ProjectGenerator.Option.INCLUDE_TESTS)) {
    for (    TargetNode<?> node : orderedTargetNodes) {
      LOG.verbose("Checking if target %s has any tests covering it..",node);
      for (      TargetNode<?> testNode : sourceTargetToTestNodes.get(node.getBuildTarget())) {
        addTestNodeAndDependencies(testNode,recursiveTestTargetNodesBuilder,orderedTestBundleTargetNodeBuilder);
      }
    }
    for (    TargetNode<?> node : orderedTargetNodes) {
      if (node.getConstructorArg() instanceof HasTests) {
        for (        BuildTarget explicitTestTarget : ((HasTests)node.getConstructorArg()).getTests()) {
          TargetNode<?> explicitTestNode=targetGraph.get(explicitTestTarget);
          if (explicitTestNode == null) {
            throw new HumanReadableException("Test target %s is not in the target graph!",explicitTestTarget);
          }
 else {
            addTestNodeAndDependencies(explicitTestNode,recursiveTestTargetNodesBuilder,orderedTestBundleTargetNodeBuilder);
          }
        }
      }
    }
  }
  for (  TargetNode<?> testBundleTarget : extraTestBundleTargets) {
    if (!AppleBuildRules.isXcodeTargetTestBundleTargetNode(testBundleTarget)) {
      throw new HumanReadableException("Test target %s must be apple_bundle with a test extension!",testBundleTarget);
    }
    addTestNodeAndDependencies(testBundleTarget,recursiveTestTargetNodesBuilder,orderedTestBundleTargetNodeBuilder);
  }
  final Set<TargetNode<?>> includedTestNodes=Sets.difference(recursiveTestTargetNodesBuilder.build(),orderedTargetNodes);
  orderedTestTargetNodeBuilder.addAll(TopologicalSort.sort(targetGraph,new Predicate<TargetNode<?>>(){
    @Override public boolean apply(    TargetNode<?> input){
      return includedTestNodes.contains(input) && AppleBuildRules.isXcodeTargetBuildRuleType(input.getType());
    }
  }
));
}

{
  HTMLWriter out=null;
  try {
    final File outFile=getItemFile(NESTED_ITEMS_PARENT_DIR,m_reportIDNamespace.getID(getItemKey(item)));
    out=openOutFile(Files.newFile(m_settings.getOutDir(),outFile),m_settings.getOutEncoding(),true);
    final int[] columns=m_settings.getColumnOrder();
    final StringBuffer buf=new StringBuffer();
    final HTMLDocument page=createPage(REPORT_HEADER_TITLE);
{
      final IItem[] path=getParentPath(item);
      addPageHeader(page,item,path);
      addPageFooter(page,item,path);
    }
{
      final IElement itemname=IElement.Factory.create(Tag.SPAN);
      if (item.getParent() instanceof PackageItem && srcFileAvailable(item,m_cache)) {
        PackageItem packageItem=(PackageItem)item.getParent();
        File src=m_cache.find(packageItem.getVMName(),item.getName());
        String srcAbsolutePath=src.getAbsolutePath();
        String projectDirectory=new File(".").getAbsolutePath();
        projectDirectory=projectDirectory.substring(0,projectDirectory.length() - 1);
        if (!srcAbsolutePath.startsWith(projectDirectory)) {
          throw new RuntimeException(projectDirectory + " should be a prefix of " + srcAbsolutePath);
        }
        String relativePath=srcAbsolutePath.substring(projectDirectory.length());
        itemname.setText(relativePath,true);
      }
 else {
        itemname.setText(item.getName(),true);
      }
      itemname.setClass(CSS_ITEM_NAME);
      final IElementList title=new ElementList();
      title.add(new Text("COVERAGE SUMMARY FOR SOURCE FILE [",true));
      title.add(itemname);
      title.add(new Text("]",true));
      page.addH(1,title,null);
    }
    final HTMLTable summaryTable=new HTMLTable("100%",null,null,"0");
{
      final HTMLTable.IRow header=summaryTable.newTitleRow();
      final HTMLTable.IRow coverage=summaryTable.newRow();
      for (int c=0; c < columns.length; ++c) {
        final int attrID=columns[c];
        final IItemAttribute attr=item.getAttribute(attrID,m_settings.getUnitsType());
        final HTMLTable.ICell headercell=header.newCell();
        headercell.setText(attr.getName(),true);
        if (attr != null) {
          boolean fail=(m_metrics[attrID] > 0) && !attr.passes(item,m_metrics[attrID]);
          buf.setLength(0);
          attr.format(item,buf);
          final HTMLTable.ICell cell=coverage.newCell();
          cell.setText(buf.toString(),true);
          if (fail)           cell.setClass(CSS_DATA_HIGHLIGHT);
        }
      }
    }
    page.add(summaryTable);
    final boolean deeper=(m_settings.getDepth() > ClassItem.getTypeMetadata().getTypeID());
    final boolean embedSrcFile=deeper && srcFileAvailable(item,m_cache);
    final boolean createAnchors=embedSrcFile && m_hasLineNumberInfo;
    final IDGenerator pageIDNamespace=createAnchors ? new IDGenerator() : null;
    page.addH(2,"COVERAGE BREAKDOWN BY CLASS AND METHOD",null);
    final IntObjectMap lineAnchorIDMap=embedSrcFile ? new IntObjectMap() : null;
    final HTMLTable childSummaryTable=new HTMLTable("100%",null,null,"0");
    childSummaryTable.setClass(CSS_CLS_NOLEFT);
{
      int[] headerColumns=null;
      final ItemComparator order=m_typeSortComparators[ClassItem.getTypeMetadata().getTypeID()];
      int clsIndex=0;
      for (Iterator classes=item.getChildren(order); classes.hasNext(); ++clsIndex) {
        final ClassItem cls=(ClassItem)classes.next();
        if (headerColumns == null) {
          headerColumns=addHeaderRow(cls,childSummaryTable,columns);
        }
        String HREFname=null;
        if (createAnchors) {
          if ($assert.ENABLED) {
            $assert.ASSERT(lineAnchorIDMap != null);
            $assert.ASSERT(pageIDNamespace != null);
          }
          final String childKey=getItemKey(cls);
          HREFname=addLineAnchorID(cls.getFirstLine(),pageIDNamespace.getID(childKey),lineAnchorIDMap);
        }
        addClassRow(cls,clsIndex,childSummaryTable,headerColumns,HREFname,createAnchors);
        boolean odd=false;
        final ItemComparator order2=m_typeSortComparators[MethodItem.getTypeMetadata().getTypeID()];
        for (Iterator methods=cls.getChildren(order2); methods.hasNext(); odd=!odd) {
          final MethodItem method=(MethodItem)methods.next();
          HREFname=null;
          if (createAnchors) {
            if ($assert.ENABLED) {
              $assert.ASSERT(lineAnchorIDMap != null);
              $assert.ASSERT(pageIDNamespace != null);
            }
            final String child2Key=getItemKey(method);
            HREFname=addLineAnchorID(method.getFirstLine(),pageIDNamespace.getID(child2Key),lineAnchorIDMap);
          }
          addClassItemRow(method,odd,childSummaryTable,headerColumns,HREFname,createAnchors);
        }
      }
    }
    page.add(childSummaryTable);
    if (deeper) {
      page.addEmptyP();
{
        embedSrcFile(item,page,lineAnchorIDMap,m_cache);
      }
    }
    page.emit(out);
    out.flush();
  }
  finally {
    if (out != null)     out.close();
    out=null;
  }
  return ctx;
}

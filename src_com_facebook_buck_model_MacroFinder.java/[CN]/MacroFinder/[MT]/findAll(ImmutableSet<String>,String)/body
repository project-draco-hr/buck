{
  ImmutableList.Builder<MacroMatchResult> results=ImmutableList.builder();
  Matcher matcher=MACRO_PATTERN.matcher(blob);
  while (matcher.find()) {
    if (matcher.start() > 0 && blob.charAt(matcher.start() - 1) == '\\') {
      continue;
    }
    String name=matcher.group(1);
    if (!macros.contains(name)) {
      throw new MacroException(String.format("no such macro \"%s\"",name));
    }
    MatchResult matchResult=matcher.toMatchResult();
    MacroMatchResult.Builder result=MacroMatchResult.builder();
    result.setMacroType(matcher.group(1));
    if (matcher.group(2) != null) {
      result.addAllMacroInput(Splitter.on(' ').trimResults().split(matcher.group(2)));
    }
    result.setStartIndex(matchResult.start());
    result.setEndIndex(matchResult.end());
    results.add(result.build());
  }
  return results.build();
}

{
  SourcePathResolver pathResolver=new SourcePathResolver(new BuildRuleResolver());
  Clock fakeClock=new IncrementingFakeClock(TimeUnit.SECONDS.toNanos(1));
  BuckEventBus eventBus=BuckEventBusFactory.newInstance(fakeClock);
  EventBus rawEventBus=BuckEventBusFactory.getEventBusFor(eventBus);
  TestConsole console=new TestConsole();
  BuildTarget fakeTarget=BuildTargetFactory.newInstance("//banana:stand");
  BuildTarget cachedTarget=BuildTargetFactory.newInstance("//chicken:dance");
  ImmutableSet<BuildTarget> buildTargets=ImmutableSet.of(fakeTarget,cachedTarget);
  Iterable<String> buildArgs=Iterables.transform(buildTargets,Functions.toStringFunction());
  FakeBuildRule fakeRule=new FakeBuildRule(fakeTarget,pathResolver,ImmutableSortedSet.<BuildRule>of());
  FakeBuildRule cachedRule=new FakeBuildRule(cachedTarget,pathResolver,ImmutableSortedSet.<BuildRule>of());
  SuperConsoleEventBusListener listener=new SuperConsoleEventBusListener(console,fakeClock,silentSummaryVerbosity,new DefaultExecutionEnvironment(new FakeProcessExecutor(),ImmutableMap.copyOf(System.getenv()),System.getProperties()),Optional.<WebServer>absent());
  eventBus.register(listener);
  ProjectBuildFileParseEvents.Started parseEventStarted=new ProjectBuildFileParseEvents.Started();
  rawEventBus.post(configureTestEventAtTime(parseEventStarted,0L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,0L,ImmutableList.of(formatConsoleTimes("[+] PARSING BUCK FILES...%s",0.0)));
  validateConsole(console,listener,100L,ImmutableList.of(formatConsoleTimes("[+] PARSING BUCK FILES...%s",0.1)));
  rawEventBus.post(configureTestEventAtTime(new ProjectBuildFileParseEvents.Finished(parseEventStarted),200L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,200L,ImmutableList.of(formatConsoleTimes("[-] PARSING BUCK FILES...FINISHED %s",0.2)));
  BuildEvent.Started buildEventStarted=BuildEvent.started(buildArgs);
  rawEventBus.post(configureTestEventAtTime(buildEventStarted,200L,TimeUnit.MILLISECONDS,0L));
  rawEventBus.post(configureTestEventAtTime(ParseEvent.started(buildTargets),200L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,300L,ImmutableList.of(formatConsoleTimes("[+] PROCESSING BUCK FILES...%s",0.1)));
  rawEventBus.post(configureTestEventAtTime(ParseEvent.finished(buildTargets,Optional.<TargetGraph>absent()),300L,TimeUnit.MILLISECONDS,0L));
  rawEventBus.post(configureTestEventAtTime(ActionGraphEvent.finished(ActionGraphEvent.started()),400L,TimeUnit.MILLISECONDS,0L));
  final String parsingLine=formatConsoleTimes("[-] PROCESSING BUCK FILES...FINISHED %s",0.2);
  validateConsole(console,listener,540L,ImmutableList.of(parsingLine,formatConsoleTimes("[+] BUILDING...%s",0.1)));
  rawEventBus.post(configureTestEventAtTime(BuildRuleEvent.started(fakeRule),600L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,800L,ImmutableList.of(parsingLine,formatConsoleTimes("[+] BUILDING...%s",0.4),formatConsoleTimes(" |=> //banana:stand...  %s (checking local cache)",0.2)));
  String stepShortName="doing_something";
  String stepDescription="working hard";
  UUID stepUuid=UUID.randomUUID();
  StepEvent.Started stepEventStarted=StepEvent.started(stepShortName,stepDescription,stepUuid);
  rawEventBus.post(configureTestEventAtTime(stepEventStarted,800L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,900L,ImmutableList.of(parsingLine,formatConsoleTimes("[+] BUILDING...%s",0.5),formatConsoleTimes(" |=> //banana:stand...  %s (running doing_something[%s])",0.3,0.1)));
  rawEventBus.post(configureTestEventAtTime(StepEvent.finished(stepEventStarted,0),900L,TimeUnit.MILLISECONDS,0L));
  rawEventBus.post(configureTestEventAtTime(BuildRuleEvent.finished(fakeRule,BuildRuleStatus.SUCCESS,CacheResult.miss(),Optional.of(BuildRuleSuccessType.BUILT_LOCALLY),Optional.<HashCode>absent(),Optional.<Long>absent()),1000L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,1000L,ImmutableList.of(parsingLine,formatConsoleTimes("[+] BUILDING...%s",0.6)," |=> IDLE"));
  rawEventBus.post(configureTestEventAtTime(BuildRuleEvent.started(cachedRule),1010L,TimeUnit.MILLISECONDS,2L));
  validateConsole(console,listener,1100L,ImmutableList.of(parsingLine,formatConsoleTimes("[+] BUILDING...%s",0.7)," |=> IDLE",formatConsoleTimes(" |=> //chicken:dance...  %s (checking local cache)",0.1)));
  rawEventBus.post(configureTestEventAtTime(BuildRuleEvent.finished(cachedRule,BuildRuleStatus.SUCCESS,CacheResult.miss(),Optional.of(BuildRuleSuccessType.BUILT_LOCALLY),Optional.<HashCode>absent(),Optional.<Long>absent()),1120L,TimeUnit.MILLISECONDS,2L));
  rawEventBus.post(configureTestEventAtTime(BuildEvent.finished(buildEventStarted,0),1234L,TimeUnit.MILLISECONDS,0L));
  final String buildingLine=formatConsoleTimes("[-] BUILDING...FINISHED %s",0.8);
  validateConsole(console,listener,1300L,ImmutableList.of(parsingLine,buildingLine));
  rawEventBus.post(configureTestEventAtTime(ConsoleEvent.severe("I've made a huge mistake."),1500L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,1600L,ImmutableList.of(parsingLine,buildingLine,"Log:","I've made a huge mistake."));
  InstallEvent.Started installEventStarted=InstallEvent.started(fakeTarget);
  rawEventBus.post(configureTestEventAtTime(installEventStarted,2500L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,3000L,ImmutableList.of(parsingLine,buildingLine,formatConsoleTimes("[+] INSTALLING...%s",0.5),"Log:","I've made a huge mistake."));
  rawEventBus.post(configureTestEventAtTime(InstallEvent.finished(installEventStarted,true,Optional.<Long>absent()),4000L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,5000L,ImmutableList.of(parsingLine,buildingLine,formatConsoleTimes("[-] INSTALLING...FINISHED %s",1.5),"Log:","I've made a huge mistake."));
  listener.render();
  String beforeStderrWrite=console.getTextWrittenToStdErr();
  console.getStdErr().print("ROFLCOPTER");
  listener.render();
  assertEquals("After stderr is written to by someone other than SuperConsole, rendering " + "should be a noop.",beforeStderrWrite + "ROFLCOPTER",console.getTextWrittenToStdErr());
}

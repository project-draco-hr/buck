{
  SourcePathResolver pathResolver=new SourcePathResolver(new BuildRuleResolver(TargetGraph.EMPTY,new BuildTargetNodeToBuildRuleTransformer()));
  Clock fakeClock=new IncrementingFakeClock(TimeUnit.SECONDS.toNanos(1));
  BuckEventBus eventBus=BuckEventBusFactory.newInstance(fakeClock);
  EventBus rawEventBus=BuckEventBusFactory.getEventBusFor(eventBus);
  TestConsole console=new TestConsole();
  BuildTarget testTarget=BuildTargetFactory.newInstance("//:test");
  ImmutableSet<BuildTarget> testTargets=ImmutableSet.of(testTarget);
  Iterable<String> testArgs=Iterables.transform(testTargets,Functions.toStringFunction());
  FakeBuildRule testBuildRule=new FakeBuildRule(testTarget,pathResolver,ImmutableSortedSet.<BuildRule>of());
  RuleKeyBuilderFactory ruleKeyBuilderFactory=new FakeRuleKeyBuilderFactory(ImmutableMap.of(testTarget,new RuleKey("aaaa")));
  SuperConsoleEventBusListener listener=new SuperConsoleEventBusListener(console,fakeClock,noisySummaryVerbosity,new DefaultExecutionEnvironment(ImmutableMap.copyOf(System.getenv()),System.getProperties()),Optional.<WebServer>absent(),Locale.US);
  eventBus.register(listener);
  ProjectBuildFileParseEvents.Started parseEventStarted=new ProjectBuildFileParseEvents.Started();
  rawEventBus.post(configureTestEventAtTime(parseEventStarted,0L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,0L,ImmutableList.of("[+] PARSING BUCK FILES...0.0s"));
  validateConsole(console,listener,100L,ImmutableList.of("[+] PARSING BUCK FILES...0.1s"));
  rawEventBus.post(configureTestEventAtTime(new ProjectBuildFileParseEvents.Finished(parseEventStarted),200L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,200L,ImmutableList.of("[-] PARSING BUCK FILES...FINISHED 0.2s"));
  BuildEvent.Started buildEventStarted=BuildEvent.started(testArgs);
  rawEventBus.post(configureTestEventAtTime(buildEventStarted,200L,TimeUnit.MILLISECONDS,0L));
  ParseEvent.Started parseStarted=ParseEvent.started(testTargets);
  rawEventBus.post(configureTestEventAtTime(parseStarted,200L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,300L,ImmutableList.of("[+] PROCESSING BUCK FILES...0.1s"));
  rawEventBus.post(configureTestEventAtTime(ParseEvent.finished(parseStarted,Optional.<TargetGraph>absent()),300L,TimeUnit.MILLISECONDS,0L));
  rawEventBus.post(configureTestEventAtTime(ActionGraphEvent.finished(ActionGraphEvent.started()),400L,TimeUnit.MILLISECONDS,0L));
  final String parsingLine="[-] PROCESSING BUCK FILES...FINISHED 0.2s";
  validateConsole(console,listener,540L,ImmutableList.of(parsingLine,"[+] BUILDING...0.1s"));
  rawEventBus.post(configureTestEventAtTime(BuildRuleEvent.started(testBuildRule,ruleKeyBuilderFactory),600L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,800L,ImmutableList.of(parsingLine,"[+] BUILDING...0.4s"," |=> //:test...  0.2s (checking local cache)"));
  rawEventBus.post(configureTestEventAtTime(BuildRuleEvent.finished(testBuildRule,ruleKeyBuilderFactory,BuildRuleStatus.SUCCESS,CacheResult.miss(),Optional.of(BuildRuleSuccessType.BUILT_LOCALLY),Optional.<HashCode>absent(),Optional.<Long>absent()),1000L,TimeUnit.MILLISECONDS,0L));
  rawEventBus.post(configureTestEventAtTime(BuildEvent.finished(buildEventStarted,0),1234L,TimeUnit.MILLISECONDS,0L));
  final String buildingLine="[-] BUILDING...FINISHED 0.8s";
  validateConsole(console,listener,1300L,ImmutableList.of(parsingLine,buildingLine));
  rawEventBus.post(configureTestEventAtTime(TestRunEvent.started(true,TestSelectorList.empty(),false,ImmutableSet.copyOf(testArgs)),2500L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,3000L,ImmutableList.of(parsingLine,buildingLine,"[+] TESTING...0.5s"));
  rawEventBus.post(configureTestEventAtTime(TestRuleEvent.started(testTarget),3100L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,3200L,ImmutableList.of(parsingLine,buildingLine,"[+] TESTING...0.7s"," |=> //:test...  0.1s"));
  UUID stepUuid=new UUID(0,1);
  StepEvent.Started stepEventStarted=StepEvent.started("step_name","step_desc",stepUuid);
  rawEventBus.post(configureTestEventAtTime(stepEventStarted,3300L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,3400L,ImmutableList.of(parsingLine,buildingLine,"[+] TESTING...0.9s"," |=> //:test...  0.3s (running step_name[0.1s])"));
  rawEventBus.post(configureTestEventAtTime(StepEvent.finished(stepEventStarted,0),3500L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,3600L,ImmutableList.of(parsingLine,buildingLine,"[+] TESTING...1.1s"," |=> //:test...  0.5s"));
  UUID testUUID=new UUID(2,3);
  rawEventBus.post(configureTestEventAtTime(TestSummaryEvent.started(testUUID,"TestClass","Foo"),3700L,TimeUnit.MILLISECONDS,0L));
  validateConsole(console,listener,3800L,ImmutableList.of(parsingLine,buildingLine,"[+] TESTING...1.3s"," |=> //:test...  0.7s (running Foo[0.1s])"));
  TestResultSummary testResultSummary=new TestResultSummary("TestClass","Foo",ResultType.FAILURE,0L,"Foo.java:47: Assertion failure: 'foo' != 'bar'",null,"Message on stdout","Message on stderr");
  rawEventBus.post(configureTestEventAtTime(TestSummaryEvent.finished(testUUID,testResultSummary),3900L,TimeUnit.MILLISECONDS,0L));
  validateConsoleWithLogLines(console,listener,4000L,ImmutableList.of(parsingLine,buildingLine,"[+] TESTING...1.5s (0 PASS/1 FAIL)"," |=> //:test...  0.9s"),ImmutableList.of("FAILURE TestClass Foo: Foo.java:47: Assertion failure: 'foo' != 'bar'"));
  rawEventBus.post(configureTestEventAtTime(TestRunEvent.finished(ImmutableSet.copyOf(testArgs),ImmutableList.of(TestResults.of(testTarget,ImmutableList.of(new TestCaseSummary("TestClass",ImmutableList.of(testResultSummary))),ImmutableSet.<String>of(),ImmutableSet.<String>of()))),4100L,TimeUnit.MILLISECONDS,0L));
  final String testingLine="[-] TESTING...FINISHED 1.6s (0 PASS/1 FAIL)";
  validateConsoleWithStdOutAndErr(console,listener,4200L,ImmutableList.of(parsingLine,buildingLine,testingLine),ImmutableList.<String>of(),Optional.of(Joiner.on('\n').join("RESULTS FOR ALL TESTS","FAIL    <100ms  0 Passed   0 Skipped   1 Failed   TestClass","FAILURE TestClass Foo: Foo.java:47: Assertion failure: 'foo' != 'bar'","====STANDARD OUT====","Message on stdout","====STANDARD ERR====","Message on stderr","TESTS FAILED: 1 FAILURE","Failed target: //:test","FAIL TestClass","")),Optional.<String>absent());
}

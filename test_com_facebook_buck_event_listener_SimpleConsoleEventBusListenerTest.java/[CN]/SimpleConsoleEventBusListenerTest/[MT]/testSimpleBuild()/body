{
  Clock fakeClock=new IncrementingFakeClock(TimeUnit.SECONDS.toNanos(1));
  BuckEventBus eventBus=BuckEventBusFactory.newInstance(fakeClock);
  EventBus rawEventBus=BuckEventBusFactory.getEventBusFor(eventBus);
  TestConsole console=new TestConsole();
  BuildTarget fakeTarget=BuildTargetFactory.newInstance("//banana:stand");
  ImmutableSet<BuildTarget> buildTargets=ImmutableSet.of(fakeTarget);
  Iterable<String> buildArgs=Iterables.transform(buildTargets,Functions.toStringFunction());
  FakeBuildRule fakeRule=new FakeBuildRule(fakeTarget,new SourcePathResolver(new BuildRuleResolver()),ImmutableSortedSet.<BuildRule>of());
  SimpleConsoleEventBusListener listener=new SimpleConsoleEventBusListener(console,fakeClock);
  eventBus.register(listener);
  final long threadId=0;
  rawEventBus.post(configureTestEventAtTime(BuildEvent.started(buildArgs),0L,TimeUnit.MILLISECONDS,threadId));
  rawEventBus.post(configureTestEventAtTime(ParseEvent.started(buildTargets),0L,TimeUnit.MILLISECONDS,threadId));
  assertEquals("",console.getTextWrittenToStdOut());
  assertEquals("",console.getTextWrittenToStdErr());
  rawEventBus.post(configureTestEventAtTime(ParseEvent.finished(buildTargets,Optional.<TargetGraph>absent()),400L,TimeUnit.MILLISECONDS,threadId));
  final String parsingLine="[-] PARSING BUCK FILES...FINISHED 0.4s\n";
  assertEquals("",console.getTextWrittenToStdOut());
  assertEquals(parsingLine,console.getTextWrittenToStdErr());
  rawEventBus.post(configureTestEventAtTime(BuildRuleEvent.started(fakeRule),600L,TimeUnit.MILLISECONDS,threadId));
  rawEventBus.post(configureTestEventAtTime(BuildRuleEvent.finished(fakeRule,BuildRuleStatus.SUCCESS,CacheResult.miss(),Optional.of(BuildRuleSuccessType.BUILT_LOCALLY),Optional.<HashCode>absent(),Optional.<Long>absent()),1000L,TimeUnit.MILLISECONDS,threadId));
  rawEventBus.post(configureTestEventAtTime(BuildEvent.finished(buildArgs,0),1234L,TimeUnit.MILLISECONDS,threadId));
  final String buildingLine="BUILT //banana:stand\n[-] BUILDING...FINISHED 0.8s\n";
  assertEquals("",console.getTextWrittenToStdOut());
  assertEquals(parsingLine + buildingLine,console.getTextWrittenToStdErr());
  rawEventBus.post(configureTestEventAtTime(ConsoleEvent.severe("I've made a huge mistake."),1500L,TimeUnit.MILLISECONDS,threadId));
  final String logLine="I've made a huge mistake.\n";
  assertEquals("",console.getTextWrittenToStdOut());
  assertEquals(parsingLine + buildingLine + logLine,console.getTextWrittenToStdErr());
  rawEventBus.post(configureTestEventAtTime(InstallEvent.started(fakeTarget),2500L,TimeUnit.MILLISECONDS,threadId));
  assertEquals("",console.getTextWrittenToStdOut());
  assertEquals(parsingLine + buildingLine + logLine,console.getTextWrittenToStdErr());
  rawEventBus.post(configureTestEventAtTime(InstallEvent.finished(fakeTarget,true,Optional.<Long>absent()),4000L,TimeUnit.MILLISECONDS,threadId));
  final String installLine="[-] INSTALLING...FINISHED 1.5s\n";
  assertEquals("",console.getTextWrittenToStdOut());
  assertEquals(parsingLine + buildingLine + logLine+ installLine,console.getTextWrittenToStdErr());
}

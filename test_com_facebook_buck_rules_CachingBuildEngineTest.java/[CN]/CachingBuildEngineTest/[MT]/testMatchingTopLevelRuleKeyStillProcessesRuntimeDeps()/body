{
  BuildRuleResolver resolver=new BuildRuleResolver();
  SourcePathResolver pathResolver=new SourcePathResolver(resolver);
  ArtifactCache cache=new NoopArtifactCache();
  BuckEventBus buckEventBus=BuckEventBusFactory.newInstance();
  FakeBuckEventListener listener=new FakeBuckEventListener();
  buckEventBus.register(listener);
  FakeBuildRule transitiveRuntimeDep=new FakeBuildRule(BuildTargetFactory.newInstance("//:transitive_dep"),pathResolver);
  transitiveRuntimeDep.setRuleKey(new RuleKey("aaaa"));
  FakeBuildRule runtimeDep=new FakeHasRuntimeDeps(BuildTargetFactory.newInstance("//:runtime_dep"),pathResolver,transitiveRuntimeDep);
  runtimeDep.setRuleKey(new RuleKey("bbbb"));
  FakeBuildRule ruleToTest=new FakeHasRuntimeDeps(buildTarget,pathResolver,runtimeDep);
  ruleToTest.setRuleKey(new RuleKey("cccc"));
  BuildContext context=createNiceMock(BuildContext.class);
  expect(context.getArtifactCache()).andReturn(cache).anyTimes();
  expect(context.getEventBus()).andReturn(buckEventBus).anyTimes();
  expect(context.getStepRunner()).andReturn(createStepRunner(buckEventBus)).anyTimes();
  expect(context.createOnDiskBuildInfoFor(buildTarget)).andReturn(new FakeOnDiskBuildInfo().setRuleKey(ruleToTest.getRuleKey())).anyTimes();
  expect(context.createOnDiskBuildInfoFor(runtimeDep.getBuildTarget())).andReturn(new FakeOnDiskBuildInfo().setRuleKey(runtimeDep.getRuleKey())).anyTimes();
  expect(context.createOnDiskBuildInfoFor(transitiveRuntimeDep.getBuildTarget())).andReturn(new FakeOnDiskBuildInfo().setRuleKey(transitiveRuntimeDep.getRuleKey())).anyTimes();
  BuildInfoRecorder buildInfoRecorder=createNiceMock(BuildInfoRecorder.class);
  expect(buildInfoRecorder.getOutputSizeAndHash(anyObject(HashFunction.class))).andReturn(new Pair<>(0L,HashCode.fromInt(0))).anyTimes();
  expect(context.createBuildInfoRecorder(anyObject(BuildTarget.class),anyObject(RuleKey.class),anyObject(RuleKey.class))).andReturn(buildInfoRecorder).anyTimes();
  CachingBuildEngine cachingBuildEngine=new CachingBuildEngine(MoreExecutors.newDirectExecutorService(),CachingBuildEngine.BuildMode.SHALLOW,NOOP_RULE_KEY_FACTORY);
  replayAll();
  BuildResult result=cachingBuildEngine.build(context,ruleToTest).get();
  assertEquals(BuildRuleSuccessType.MATCHING_RULE_KEY,result.getSuccess());
  verifyAll();
  List<BuckEvent> events=listener.getEvents();
  assertThat(events,Matchers.hasSize(12));
  Iterator<BuckEvent> eventIter=events.iterator();
  assertEquals(configureTestEvent(BuildRuleEvent.started(ruleToTest),buckEventBus),eventIter.next());
  assertEquals(configureTestEvent(BuildRuleEvent.suspended(ruleToTest),buckEventBus),eventIter.next());
  assertEquals(configureTestEvent(BuildRuleEvent.resumed(ruleToTest),buckEventBus),eventIter.next());
  assertEquals(configureTestEvent(BuildRuleEvent.finished(ruleToTest,BuildRuleStatus.SUCCESS,CacheResult.localKeyUnchangedHit(),Optional.of(BuildRuleSuccessType.MATCHING_RULE_KEY),Optional.<HashCode>absent(),Optional.<Long>absent()),buckEventBus),eventIter.next());
  assertEquals(configureTestEvent(BuildRuleEvent.started(runtimeDep),buckEventBus),eventIter.next());
  assertEquals(configureTestEvent(BuildRuleEvent.suspended(runtimeDep),buckEventBus),eventIter.next());
  assertEquals(configureTestEvent(BuildRuleEvent.resumed(runtimeDep),buckEventBus),eventIter.next());
  assertEquals(configureTestEvent(BuildRuleEvent.finished(runtimeDep,BuildRuleStatus.SUCCESS,CacheResult.localKeyUnchangedHit(),Optional.of(BuildRuleSuccessType.MATCHING_RULE_KEY),Optional.<HashCode>absent(),Optional.<Long>absent()),buckEventBus),eventIter.next());
  assertEquals(configureTestEvent(BuildRuleEvent.started(transitiveRuntimeDep),buckEventBus),eventIter.next());
  assertEquals(configureTestEvent(BuildRuleEvent.suspended(transitiveRuntimeDep),buckEventBus),eventIter.next());
  assertEquals(configureTestEvent(BuildRuleEvent.resumed(transitiveRuntimeDep),buckEventBus),eventIter.next());
  assertEquals(configureTestEvent(BuildRuleEvent.finished(transitiveRuntimeDep,BuildRuleStatus.SUCCESS,CacheResult.localKeyUnchangedHit(),Optional.of(BuildRuleSuccessType.MATCHING_RULE_KEY),Optional.<HashCode>absent(),Optional.<Long>absent()),buckEventBus),eventIter.next());
}

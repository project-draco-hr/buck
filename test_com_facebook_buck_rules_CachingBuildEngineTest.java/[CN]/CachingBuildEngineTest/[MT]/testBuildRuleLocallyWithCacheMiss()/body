{
  BuildTarget depTarget=BuildTargetFactory.newInstance("//src/com/facebook/orca:lib");
  BuildRule dep=createMock(BuildRule.class);
  BuckEventBus buckEventBus=BuckEventBusFactory.newInstance();
  FakeBuckEventListener listener=new FakeBuckEventListener();
  buckEventBus.register(listener);
  ArtifactCache mockArtifactCache=createMock(ArtifactCache.class);
  ArtifactCache artifactCache=new LoggingArtifactCacheDecorator(buckEventBus).decorate(mockArtifactCache);
  replayAll();
  String pathToOutputFile="buck-out/gen/src/com/facebook/orca/some_file";
  List<Step> buildSteps=Lists.newArrayList();
  BuildRule ruleToTest=createRule(new SourcePathResolver(new BuildRuleResolver()),ImmutableSet.of(dep),buildSteps,ImmutableList.<Step>of(),pathToOutputFile);
  verifyAll();
  resetAll();
  BuildContext context=createMock(BuildContext.class);
  expect(context.getArtifactCache()).andReturn(artifactCache).times(2);
  expect(context.getProjectRoot()).andReturn(createMock(Path.class));
  OnDiskBuildInfo onDiskBuildInfo=new FakeOnDiskBuildInfo();
  expect(context.createOnDiskBuildInfoFor(buildTarget)).andReturn(onDiskBuildInfo);
  BuildInfoRecorder buildInfoRecorder=createMock(BuildInfoRecorder.class);
  Capture<RuleKey> ruleKeyForRecorder=newCapture();
  expect(context.createBuildInfoRecorder(eq(buildTarget),capture(ruleKeyForRecorder),anyObject(RuleKey.class))).andReturn(buildInfoRecorder);
  expect(buildInfoRecorder.fetchArtifactForBuildable(anyObject(File.class),eq(artifactCache))).andReturn(CacheResult.miss());
  expect(context.getEventBus()).andReturn(buckEventBus).anyTimes();
  expect(context.getStepRunner()).andReturn(createStepRunner(buckEventBus)).anyTimes();
  expect(dep.getBuildTarget()).andStubReturn(depTarget);
  CachingBuildEngine cachingBuildEngine=new CachingBuildEngine(MoreExecutors.newDirectExecutorService());
  cachingBuildEngine.setBuildRuleResult(depTarget,new BuildRuleSuccess(dep,BuildRuleSuccess.Type.FETCHED_FROM_CACHE),CacheResult.skip());
  expect(dep.getRuleKey()).andReturn(new RuleKey("19d2558a6bd3a34fb3f95412de9da27ed32fe208"));
  Step buildStep=createMock(Step.class);
  expect(buildStep.getDescription(anyObject(ExecutionContext.class))).andReturn("Some Description").anyTimes();
  expect(buildStep.getShortName()).andReturn("Some Short Name").anyTimes();
  expect(buildStep.execute(anyObject(ExecutionContext.class))).andReturn(0);
  buildSteps.add(buildStep);
  buildInfoRecorder.recordArtifact(Paths.get(pathToOutputFile));
  buildInfoRecorder.writeMetadataToDisk(true);
  buildInfoRecorder.performUploadToArtifactCache(artifactCache,buckEventBus);
  replayAll();
  BuildResult result=cachingBuildEngine.build(context,ruleToTest).get();
  assertEquals(BuildRuleSuccess.Type.BUILT_LOCALLY,result.getSuccess());
  buckEventBus.post(CommandEvent.finished("build",ImmutableList.<String>of(),false,0));
  verifyAll();
  List<BuckEvent> events=listener.getEvents();
  assertEquals(configureTestEvent(BuildRuleEvent.started(ruleToTest),buckEventBus),events.get(0));
  assertEquals(configureTestEvent(BuildRuleEvent.finished(ruleToTest,BuildRuleStatus.SUCCESS,CacheResult.miss(),Optional.of(BuildRuleSuccess.Type.BUILT_LOCALLY)),buckEventBus),events.get(events.size() - 2));
}

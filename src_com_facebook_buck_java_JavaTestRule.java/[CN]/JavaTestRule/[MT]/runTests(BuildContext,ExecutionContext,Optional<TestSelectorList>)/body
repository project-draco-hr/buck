{
  Preconditions.checkState(isRuleBuilt(),"%s must be built before tests can be run.",this);
  Set<String> testClassNames=getClassNamesForSources(executionContext);
  if (testClassNames.isEmpty()) {
    return ImmutableList.of();
  }
  ImmutableList.Builder<Step> steps=ImmutableList.builder();
  Path pathToTestOutput=getPathToTestOutputDirectory();
  MakeCleanDirectoryStep mkdirClean=new MakeCleanDirectoryStep(pathToTestOutput);
  steps.add(mkdirClean);
  ImmutableSet<String> classpathEntries=ImmutableSet.<String>builder().addAll(getTransitiveClasspathEntries().values()).addAll(additionalClasspathEntries).build();
  Step junit=new JUnitStep(classpathEntries,testClassNames,amendVmArgs(vmArgs,executionContext.getTargetDeviceOptional()),pathToTestOutput.toString(),executionContext.isCodeCoverageEnabled(),executionContext.isJacocoEnabled(),executionContext.isDebugEnabled(),testSelectorList);
  steps.add(junit);
  return steps.build();
}

{
  Preconditions.checkState(isRuleBuilt(),"%s must be built before tests can be run.",this);
  Set<String> testClassNames=getClassNamesForSources();
  if (testClassNames.isEmpty()) {
    return ImmutableList.of();
  }
  if (androidResourceDeps == null) {
    androidResourceDeps=UberRDotJavaUtil.getAndroidResourceDeps(this,buildContext.getDependencyGraph());
  }
  ImmutableList.Builder<Step> steps=ImmutableList.builder();
  String pathToTestOutput=getPathToTestOutput();
  MakeCleanDirectoryStep mkdirClean=new MakeCleanDirectoryStep(pathToTestOutput);
  steps.add(mkdirClean);
  ImmutableSet<String> classpathEntries;
  if (isAndroidRule()) {
    BuildTarget buildTarget=getBuildTarget();
    String rDotJavaClasspathEntry;
    UberRDotJavaUtil.createDummyRDotJavaFiles(androidResourceDeps,buildTarget,steps);
    rDotJavaClasspathEntry=UberRDotJavaUtil.getRDotJavaBinFolder(buildTarget);
    ImmutableSet.Builder<String> classpathEntriesBuilder=ImmutableSet.builder();
    classpathEntriesBuilder.add(rDotJavaClasspathEntry);
    classpathEntriesBuilder.addAll(getTransitiveClasspathEntries().values());
    classpathEntries=classpathEntriesBuilder.build();
  }
 else {
    classpathEntries=ImmutableSet.copyOf(getTransitiveClasspathEntries().values());
  }
  Step junit=new JUnitStep(classpathEntries,testClassNames,vmArgs,pathToTestOutput,executionContext.isCodeCoverageEnabled(),executionContext.isDebugEnabled());
  steps.add(junit);
  return steps.build();
}

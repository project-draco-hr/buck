{
  WorkerShellStep step=new WorkerShellStep(new FakeProjectFilesystem(),Paths.get("tmp").toAbsolutePath().normalize(),Paths.get(".").toAbsolutePath().normalize(),Optional.of(createJobParams()),Optional.of(createJobParams()),Optional.of(createJobParams())){
    @Override protected ImmutableMap<String,String> getEnvironmentVariables(    ExecutionContext context){
      return ImmutableMap.of("FOO","foo_expanded","BAR","bar_expanded");
    }
  }
;
  ExecutionContext context=TestExecutionContext.newBuilder().setEnvironment(ImmutableMap.of("BAR","this should be ignored because the step overrides the same variable","BAZ","baz_expanded")).build();
  assertThat(step.getEnvironmentForProcess(context),Matchers.equalTo(ImmutableMap.of("FOO","foo_expanded","BAR","bar_expanded","BAZ","baz_expanded")));
}

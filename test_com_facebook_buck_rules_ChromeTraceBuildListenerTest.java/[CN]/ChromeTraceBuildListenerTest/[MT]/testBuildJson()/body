{
  ProjectFilesystem projectFilesystem=new ProjectFilesystem(tmpDir.getRoot());
  ChromeTraceBuildListener listener=new ChromeTraceBuildListener(projectFilesystem);
  BuildTarget target=BuildTargetFactory.newInstance("//fake:rule");
  BuildRule rule=new FakeBuildRule(new BuildRuleType("fakeRule"),target,ImmutableSortedSet.<BuildRule>of(),ImmutableSet.<BuildTargetPattern>of());
  FakeStep step=new FakeStep("fakeStep","I'm a Fake Step!",0);
  ExecutionContext context=createMock(ExecutionContext.class);
  replay(context);
  ImmutableList<BuildTarget> buildTargets=ImmutableList.of(target);
  EventBus internalEventBus=new EventBus();
  Clock fakeClock=new IncrementingFakeClock(TimeUnit.MILLISECONDS.toNanos(1));
  Supplier<Long> threadIdSupplier=BuckEventBus.getDefaultThreadIdSupplier();
  BuckEventBus eventBus=new BuckEventBus(internalEventBus,fakeClock,threadIdSupplier);
  eventBus.register(listener);
  eventBus.post(CommandEvent.started("party",true));
  eventBus.post(BuildEvent.started(buildTargets));
  eventBus.post(BuildRuleEvent.started(rule));
  eventBus.post(StepEvent.started(step,"fakeStep","I'm a Fake Step!"));
  BuckEvent stepFinished=StepEvent.finished(step,"fakeStep","I'm a Fake Step!",0);
  stepFinished.configure(fakeClock.currentTimeMillis(),fakeClock.nanoTime(),threadIdSupplier.get());
  BuckEvent ruleFinished=BuildRuleEvent.finished(rule,BuildRuleStatus.SUCCESS,CacheResult.MISS);
  ruleFinished.configure(fakeClock.currentTimeMillis(),fakeClock.nanoTime(),threadIdSupplier.get());
  internalEventBus.post(ruleFinished);
  internalEventBus.post(stepFinished);
  eventBus.post(BuildEvent.finished(buildTargets,0));
  eventBus.post(CommandEvent.finished("party",true,0));
  listener.outputTrace();
  File resultFile=new File(tmpDir.getRoot(),BuckConstant.BIN_DIR + "/build.trace");
  ObjectMapper mapper=new ObjectMapper();
  List<ChromeTraceEvent> resultMap=mapper.readValue(resultFile,new TypeReference<List<ChromeTraceEvent>>(){
  }
);
  assertEquals(8,resultMap.size());
  assertEquals("party",resultMap.get(0).getName());
  assertEquals(ChromeTraceEvent.Phase.BEGIN,resultMap.get(0).getPhase());
  assertEquals("build",resultMap.get(1).getName());
  assertEquals(ChromeTraceEvent.Phase.BEGIN,resultMap.get(1).getPhase());
  assertEquals("//fake:rule",resultMap.get(2).getName());
  assertEquals(ChromeTraceEvent.Phase.BEGIN,resultMap.get(2).getPhase());
  assertEquals("fakeStep",resultMap.get(3).getName());
  assertEquals(ChromeTraceEvent.Phase.BEGIN,resultMap.get(3).getPhase());
  assertEquals("fakeStep",resultMap.get(4).getName());
  assertEquals(ChromeTraceEvent.Phase.END,resultMap.get(4).getPhase());
  assertEquals("//fake:rule",resultMap.get(5).getName());
  assertEquals(ChromeTraceEvent.Phase.END,resultMap.get(5).getPhase());
  assertEquals("build",resultMap.get(6).getName());
  assertEquals(ChromeTraceEvent.Phase.END,resultMap.get(6).getPhase());
  assertEquals("party",resultMap.get(7).getName());
  assertEquals(ChromeTraceEvent.Phase.END,resultMap.get(7).getPhase());
  verify(context);
}

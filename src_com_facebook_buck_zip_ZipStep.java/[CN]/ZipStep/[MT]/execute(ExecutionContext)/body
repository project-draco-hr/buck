{
  final ProjectFilesystem filesystem=context.getProjectFilesystem();
  if (filesystem.exists(pathToZipFile)) {
    context.postEvent(LogEvent.severe("Attempting to overwrite an existing zip: %s",pathToZipFile));
    return 1;
  }
  try (BufferedOutputStream baseOut=new BufferedOutputStream(filesystem.newFileOutputStream(pathToZipFile));final CustomZipOutputStream out=ZipOutputStreams.newOutputStream(baseOut,OVERWRITE_EXISTING)){
    final FileVisitor<Path> pathFileVisitor=new SimpleFileVisitor<Path>(){
      @Override public FileVisitResult visitFile(      Path file,      BasicFileAttributes attributes) throws IOException {
        if (!paths.isEmpty() && !paths.contains(file)) {
          return FileVisitResult.CONTINUE;
        }
        Path relativePath=junkPaths ? file.getFileName() : baseDir.relativize(file);
        String entryName=relativePath.toString();
        CustomZipEntry entry=new CustomZipEntry(entryName);
        entry.setTime(attributes.lastModifiedTime().toMillis());
        entry.setSize(attributes.size());
        entry.setCompressionLevel(compressionLevel);
        out.putNextEntry(entry);
        Files.copy(filesystem.resolve(file),out);
        out.closeEntry();
        return FileVisitResult.CONTINUE;
      }
    }
;
    filesystem.walkRelativeFileTree(baseDir,pathFileVisitor);
  }
 catch (  IOException e) {
    context.logError(e,"Error creating zip file %s",pathToZipFile);
    return 1;
  }
  return 0;
}

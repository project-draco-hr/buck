{
  boolean createBundle=Sets.intersection(params.getBuildTarget().getFlavors(),NON_LIBRARY_FLAVORS).isEmpty();
  Set<Flavor> extraFlavors=ImmutableSet.of();
  if (createBundle) {
    extraFlavors=ImmutableSet.of(LIBRARY_FLAVOR,CxxDescriptionEnhancer.SHARED_FLAVOR);
  }
  BuildRule library=appleLibraryDescription.createBuildRule(params.copyWithChanges(AppleLibraryDescription.TYPE,BuildTarget.builder(params.getBuildTarget()).addAllFlavors(extraFlavors).build(),Suppliers.ofInstance(params.getDeclaredDeps()),Suppliers.ofInstance(params.getExtraDeps())),resolver,args);
  if (!createBundle) {
    return library;
  }
  SourcePathResolver sourcePathResolver=new SourcePathResolver(resolver);
  AppleBundle bundle=new AppleBundle(params.copyWithChanges(AppleBundleDescription.TYPE,BuildTarget.builder(params.getBuildTarget()).addFlavors(BUNDLE_FLAVOR).build(),Suppliers.ofInstance(ImmutableSortedSet.of(library)),Suppliers.ofInstance(ImmutableSortedSet.<BuildRule>of())),sourcePathResolver,args.extension,args.infoPlist,library);
  return new AppleTest(params.copyWithDeps(Suppliers.ofInstance(ImmutableSortedSet.<BuildRule>of(bundle)),Suppliers.ofInstance(ImmutableSortedSet.<BuildRule>of())),sourcePathResolver,bundle,args.contacts.get(),args.labels.get(),ImmutableSet.<BuildRule>of());
}

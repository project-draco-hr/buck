{
  List<File> apiVersionDirectories=Lists.newArrayList();
  List<File> androidVersionDirectories=Lists.newArrayList();
  for (  File dir : directories) {
    if (dir.getName().startsWith(ANDROID_VERSION_PREFIX)) {
      androidVersionDirectories.add(dir);
    }
 else {
      apiVersionDirectories.add(dir);
    }
  }
  final VersionStringComparator comparator=new VersionStringComparator();
  if (!apiVersionDirectories.isEmpty()) {
    if (targetBuildToolsVersion.isPresent()) {
      for (      File dir : apiVersionDirectories) {
        if (dir.getName().equals(targetBuildToolsVersion.get())) {
          return dir.toPath();
        }
      }
      throw unableToFindTargetBuildTools();
    }
    Collections.sort(apiVersionDirectories,new Comparator<File>(){
      @Override public int compare(      File a,      File b){
        String versionA=a.getName();
        String versionB=b.getName();
        return comparator.compare(versionA,versionB);
      }
    }
);
    return apiVersionDirectories.get(apiVersionDirectories.size() - 1).toPath();
  }
 else {
    Collections.sort(androidVersionDirectories,new Comparator<File>(){
      @Override public int compare(      File a,      File b){
        String versionA=a.getName().substring(ANDROID_VERSION_PREFIX.length());
        String versionB=b.getName().substring(ANDROID_VERSION_PREFIX.length());
        return comparator.compare(versionA,versionB);
      }
    }
);
    return androidVersionDirectories.get(androidVersionDirectories.size() - 1).toPath();
  }
}

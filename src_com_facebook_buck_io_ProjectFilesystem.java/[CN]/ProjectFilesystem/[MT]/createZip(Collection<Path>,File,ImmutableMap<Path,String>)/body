{
  Preconditions.checkState(!Iterables.isEmpty(pathsToIncludeInZip));
  try (CustomZipOutputStream zip=ZipOutputStreams.newOutputStream(out)){
    for (    Path path : pathsToIncludeInZip) {
      Path full=getPathForRelativePath(path);
      File file=full.toFile();
      boolean isDirectory=isDirectory(full);
      String entryName=path.toString();
      if (isDirectory) {
        entryName+="/";
      }
      CustomZipEntry entry=new CustomZipEntry(entryName);
      if (file.canExecute()) {
        entry.setExternalAttributes(MorePosixFilePermissions.toMode(EnumSet.of(PosixFilePermission.OWNER_EXECUTE)) << 16);
      }
      zip.putNextEntry(entry);
      if (!isDirectory) {
        try (InputStream input=Files.newInputStream(getPathForRelativePath(path))){
          ByteStreams.copy(input,zip);
        }
       }
      zip.closeEntry();
    }
    for (    Map.Entry<Path,String> fileContentsEntry : additionalFileContents.entrySet()) {
      CustomZipEntry entry=new CustomZipEntry(fileContentsEntry.getKey().toString());
      zip.putNextEntry(entry);
      try (InputStream stream=new ByteArrayInputStream(fileContentsEntry.getValue().getBytes(Charsets.UTF_8))){
        ByteStreams.copy(stream,zip);
      }
       zip.closeEntry();
    }
  }
 }

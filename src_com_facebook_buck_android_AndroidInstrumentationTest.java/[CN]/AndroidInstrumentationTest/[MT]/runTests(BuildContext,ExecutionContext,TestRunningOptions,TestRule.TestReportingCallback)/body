{
  Preconditions.checkArgument(executionContext.getAdbOptions().isPresent());
  if (executionContext.getAdbOptions().get().isMultiInstallModeEnabled()) {
    throw new HumanReadableException("Running android instrumentation tests with multiple devices is not supported.");
  }
  ImmutableList.Builder<Step> steps=ImmutableList.builder();
  Path pathToTestOutput=getPathToTestOutputDirectory();
  steps.add(new MakeCleanDirectoryStep(getProjectFilesystem(),pathToTestOutput));
  steps.add(new ApkInstallStep(apk));
  if (apk instanceof AndroidInstrumentationApk) {
    steps.add(new ApkInstallStep(((AndroidInstrumentationApk)apk).getApkUnderTest()));
  }
  steps.add(new InstrumentationStep(apk,getProjectFilesystem().resolve(pathToTestOutput),testRuleTimeoutMs));
  return steps.build();
}

def main():
    args = createArgParser().parse_args()
    log('Running Performance Test!')
    clean(args.repo_under_test)
    log('=== Warming up cache ===')
    cwd = os.path.join(args.repo_under_test, args.project_under_test)
    build_all_targets(args, cwd, 'readwrite', dir_cache_only=False, log_as_perftest=False)
    log('=== Cache Warm!  Running tests ===')
    new_directory_name = (os.path.basename(args.repo_under_test) + '_test_iteration_')
    cwd_root = os.path.join(os.path.dirname(args.repo_under_test), new_directory_name)
    cwd = os.path.join(cwd_root, args.project_under_test)
    log(('Renaming %s to %s' % (args.repo_under_test, cwd_root)))
    os.rename(args.repo_under_test, cwd_root)
    try:
        log('== Checking for problems with absolute paths ==')
        result = build_all_targets(args, cwd, 'readonly')
        check_cache_results(result, ['DIR_HIT', 'IGNORED', 'LOCAL_KEY_UNCHANGED_HIT'], 'Building was unable to reuse the cache from a previous run. This suggests one of the rule keys contains an absolute path.', 'Failed to reuse cache across directories!!!')
        log('== Ensure noop build does nothing. ==')
        result = build_all_targets(args, cwd, 'readonly', run_clean=False)
        check_cache_results(result, ['LOCAL_KEY_UNCHANGED_HIT'], 'Doing a noop build not hit all of its keys.', 'Doing a noop build not hit all of its keys.')
    finally:
        log(('Renaming %s to %s' % (cwd_root, args.repo_under_test)))
        os.rename(cwd_root, args.repo_under_test)

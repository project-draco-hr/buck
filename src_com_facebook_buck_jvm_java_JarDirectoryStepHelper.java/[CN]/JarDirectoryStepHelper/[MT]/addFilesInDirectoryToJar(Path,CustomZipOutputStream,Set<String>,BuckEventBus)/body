{
  final Map<String,Pair<JarEntry,Optional<Path>>> entries=Maps.newTreeMap();
  new DirectoryTraversal(directory){
    @Override public void visit(    Path file,    String relativePath){
      JarEntry entry=new JarEntry(relativePath.replace('\\','/'));
      String entryName=entry.getName();
      entry.setTime(ZipConstants.getFakeTime());
      if (!isDuplicateAllowed(entryName) && !alreadyAddedEntries.add(entryName)) {
        if (!entryName.endsWith("/")) {
          eventBus.post(ConsoleEvent.create(determineSeverity(entry),"Duplicate found when adding directory to jar: %s",relativePath));
        }
        return;
      }
      entries.put(entry.getName(),new Pair<>(entry,Optional.of(file)));
    }
    @Override public void visitDirectory(    Path directory,    String relativePath) throws IOException {
      if (relativePath.isEmpty()) {
        return;
      }
      String entryName=relativePath.replace('\\','/') + "/";
      if (alreadyAddedEntries.contains(entryName)) {
        return;
      }
      JarEntry entry=new JarEntry(entryName);
      entry.setTime(ZipConstants.getFakeTime());
      entries.put(entry.getName(),new Pair<>(entry,Optional.<Path>absent()));
    }
  }
.traverse();
  for (  Pair<JarEntry,Optional<Path>> entry : entries.values()) {
    jar.putNextEntry(entry.getFirst());
    if (entry.getSecond().isPresent()) {
      Files.copy(entry.getSecond().get(),jar);
    }
    jar.closeEntry();
  }
}

{
  Preconditions.checkState(!soname.isPresent() || linkType.equals(Linker.LinkType.SHARED));
  Linker linker=cxxPlatform.getLd();
  NativeLinkableInput linkableInput=NativeLinkables.getTransitiveNativeLinkableInput(cxxPlatform,nativeLinkableDeps,depType,true);
  ImmutableList<SourcePath> allInputs=ImmutableList.<SourcePath>builder().addAll(inputs).addAll(linkableInput.getInputs()).build();
  BuildRuleParams linkParams=params.copyWithChanges(NativeLinkable.NATIVE_LINKABLE_TYPE,target,ImmutableSortedSet.copyOf(resolver.filterBuildRuleInputs(allInputs)),ImmutableSortedSet.<BuildRule>of());
  ImmutableList.Builder<String> argsBuilder=ImmutableList.builder();
  argsBuilder.addAll(cxxPlatform.getCxxldflags());
  argsBuilder.addAll(extraCxxLdFlags);
  argsBuilder.addAll(iXlinker(cxxPlatform.getLdflags()));
  argsBuilder.addAll(iXlinker(extraLdFlags));
  if (linkType == Linker.LinkType.SHARED) {
    argsBuilder.add("-shared");
  }
  if (soname.isPresent()) {
    argsBuilder.addAll(iXlinker(linker.soname(soname.get())));
  }
  for (  SourcePath input : inputs) {
    argsBuilder.addAll(iXlinker(linker.linkWhole(resolver.getPath(input).toString())));
  }
  argsBuilder.addAll(iXlinker(linkableInput.getArgs()));
  argsBuilder.addAll(iXlinker(cxxPlatform.getRuntimeLdflags(linkType,depType)));
  ImmutableList<String> args=argsBuilder.build();
  return new CxxLink(linkParams,resolver,cxxPlatform.getCxxld(),output,allInputs,args);
}

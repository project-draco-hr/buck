{
  Preconditions.checkArgument(!targetNodes.isEmpty());
  ModuleBuildContext context=new ModuleBuildContext(moduleBasePath);
  for (  TargetNode<?> targetNode : targetNodes) {
    IjModuleRule<?> rule=moduleRuleIndex.get(targetNode.getType());
    if (rule == null) {
      continue;
    }
    rule.apply((TargetNode)targetNode,context);
  }
  Optional<IjModuleAndroidFacet> androidFacetOptional=context.androidFacetBuilder.transform(new Function<IjModuleAndroidFacet.Builder,IjModuleAndroidFacet>(){
    @Override public IjModuleAndroidFacet apply(    IjModuleAndroidFacet.Builder input){
      return input.build();
    }
  }
);
  return IjModule.builder().setModuleBasePath(moduleBasePath).setTargets(targetNodes).addAllLibraries(libraryFactory.getLibraries(targetNodes)).addAllFolders(context.getSourceFolders()).setAndroidFacet(androidFacetOptional).build();
}

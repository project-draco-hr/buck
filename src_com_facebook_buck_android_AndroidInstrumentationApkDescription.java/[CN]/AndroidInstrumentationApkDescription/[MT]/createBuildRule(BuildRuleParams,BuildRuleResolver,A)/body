{
  BuildRule installableApk=resolver.getRule(args.apk);
  if (!(installableApk instanceof InstallableApk)) {
    throw new HumanReadableException("In %s, apk='%s' must be an android_binary() or apk_genrule() but was %s().",params.getBuildTarget(),installableApk.getFullyQualifiedName(),installableApk.getType().getName());
  }
  AndroidBinary apkUnderTest=getUnderlyingApk((InstallableApk)installableApk);
  ImmutableSortedSet<JavaLibrary> rulesToExcludeFromDex=FluentIterable.from(ImmutableSet.<JavaLibrary>builder().addAll(apkUnderTest.getRulesToExcludeFromDex()).addAll(Classpaths.getClasspathEntries(apkUnderTest.getClasspathDeps()).keySet()).build()).toSortedSet(HasBuildTarget.BUILD_TARGET_COMPARATOR);
  AndroidPackageableCollection.ResourceDetails resourceDetails=apkUnderTest.getAndroidPackageableCollection().resourceDetails();
  ImmutableSet<BuildTarget> resourcesToExclude=ImmutableSet.copyOf(Iterables.concat(resourceDetails.resourcesWithNonEmptyResDir(),resourceDetails.resourcesWithEmptyResButNonEmptyAssetsDir()));
  Path primaryDexPath=AndroidBinary.getPrimaryDexPath(params.getBuildTarget());
  AndroidBinaryGraphEnhancer graphEnhancer=new AndroidBinaryGraphEnhancer(params,resolver,ResourceCompressionMode.DISABLED,FilterResourcesStep.ResourceFilter.EMPTY_FILTER,args.manifest,PackageType.INSTRUMENTED,apkUnderTest.getCpuFilters(),false,false,primaryDexPath,DexSplitMode.NO_SPLIT,FluentIterable.from(rulesToExcludeFromDex).transform(TO_TARGET).toSet(),resourcesToExclude,javacOptions,EnumSet.noneOf(ExopackageMode.class),apkUnderTest.getKeystore(),BuildConfigFields.empty(),Optional.<SourcePath>absent(),ImmutableMap.<AndroidBinary.TargetCpuType,CxxPlatform>of());
  AndroidBinaryGraphEnhancer.EnhancementResult enhancementResult=graphEnhancer.createAdditionalBuildables();
  return new AndroidInstrumentationApk(params.copyWithExtraDeps(enhancementResult.finalDeps()),new SourcePathResolver(resolver),proGuardConfig.getProguardJarOverride(),proGuardConfig.getProguardMaxHeapSize(),args.manifest,apkUnderTest,rulesToExcludeFromDex,enhancementResult);
}

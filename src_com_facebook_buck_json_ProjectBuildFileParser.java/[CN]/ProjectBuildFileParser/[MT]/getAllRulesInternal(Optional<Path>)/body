{
  ensureNotClosed();
  initIfNeeded();
  Preconditions.checkNotNull(buckPyStdoutParser);
  Preconditions.checkNotNull(buckPyStdinWriter);
  Preconditions.checkNotNull(buckPyProcess);
  Preconditions.checkState(buildFile.isPresent() == isServerMode);
  if (buildFile.isPresent()) {
    buckPyStdinWriter.write(buildFile.get().toString());
    buckPyStdinWriter.newLine();
    buckPyStdinWriter.flush();
  }
  return buckPyStdoutParser.nextRules();
}

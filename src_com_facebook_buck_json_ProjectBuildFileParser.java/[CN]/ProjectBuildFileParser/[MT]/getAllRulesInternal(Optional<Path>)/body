{
  ensureNotClosed();
  initIfNeeded();
  Preconditions.checkState(buildFile.isPresent() == isServerMode);
  if (buildFile.isPresent()) {
    buckPyStdinWriter.write(buildFile.get().toString());
    buckPyStdinWriter.newLine();
    buckPyStdinWriter.flush();
  }
  if (buckPyStdoutParser == null) {
    buckPyStdoutParser=new BuildFileToJsonParser(buckPyProcess.getInputStream());
  }
  return buckPyStdoutParser.nextRules();
}

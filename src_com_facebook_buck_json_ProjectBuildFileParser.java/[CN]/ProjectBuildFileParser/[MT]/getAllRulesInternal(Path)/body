{
  ensureNotClosed();
  initIfNeeded();
  Preconditions.checkNotNull(buckPyStdinWriter);
  Preconditions.checkNotNull(buckPyProcess);
  ParseBuckFileEvent.Started parseBuckFileStarted=ParseBuckFileEvent.started(buildFile);
  int numRules=0;
  buckEventBus.post(parseBuckFileStarted);
  List<Map<String,Object>> result=null;
  try {
    String buildFileString=buildFile.toString();
    LOG.verbose("Writing to buck.py stdin: %s",buildFileString);
    buckPyStdinWriter.write(buildFileString);
    buckPyStdinWriter.newLine();
    buckPyStdinWriter.flush();
    LOG.debug("Parsing output of process %s...",buckPyProcess);
    try {
      Object deserializedValue=bserDeserializer.deserializeBserValue(buckPyProcess.getInputStream());
      result=handleDeserializedValue(buildFile,deserializedValue,buckEventBus);
    }
 catch (    BserDeserializer.BserEofException e) {
      LOG.warn(e,"Parser exited while decoding BSER data");
      throw new IOException("Parser exited unexpectedly",e);
    }
    LOG.verbose("Got rules: %s",result);
    numRules=result.size();
    LOG.debug("Parsed %d rules from process",numRules);
    return result;
  }
  finally {
    buckEventBus.post(ParseBuckFileEvent.finished(parseBuckFileStarted,result));
  }
}

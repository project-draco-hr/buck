{
  ensureNotClosed();
  initIfNeeded();
  Preconditions.checkNotNull(buckPyStdinWriter);
  Preconditions.checkNotNull(buckPyProcess);
  buckEventBus.post(ParseBuckFileEvent.started(buildFile));
  String buildFileString=buildFile.toString();
  LOG.verbose("Writing to buck.py stdin: %s",buildFileString);
  buckPyStdinWriter.write(buildFileString);
  buckPyStdinWriter.newLine();
  buckPyStdinWriter.flush();
  LOG.debug("Parsing output of process %s using format %s...",buckPyProcess,buckPyOutputFormat);
  List<Map<String,Object>> result;
  if (buckPyOutputFormat == BuckPyOutputFormat.BSER) {
    Object deserializedValue=bserDeserializer.deserializeBserValue(buckPyProcess.getInputStream());
    Preconditions.checkState(deserializedValue instanceof List<?>);
    result=(List<Map<String,Object>>)deserializedValue;
  }
 else {
    Preconditions.checkNotNull(buckPyStdoutParser);
    result=buckPyStdoutParser.nextRules();
  }
  LOG.verbose("Got rules: %s",result);
  int numRules=result.size();
  LOG.debug("Parsed %d rules from process",numRules);
  buckEventBus.post(ParseBuckFileEvent.finished(buildFile,numRules));
  return result;
}

{
  String projectName=getProjectName(artifactToDownload);
  Path project=buckRepoRoot.resolve(buckThirdPartyRelativePath).resolve(projectName);
  Files.createDirectories(project);
  SortedSet<Prebuilt> libs=buckFiles.get(project);
  if (libs == null) {
    libs=new TreeSet<>();
    buckFiles.put(project,libs);
  }
  Prebuilt library=resolveLib(artifactToDownload,repoSys,session,project);
  libs.add(library);
  Iterable<Artifact> incoming=graph.getIncomingNodesFor(artifactToDownload);
  for (  Artifact artifact : incoming) {
    String groupName=getProjectName(artifact);
    if (projectName.equals(groupName)) {
      library.addDep(String.format(":%s",artifact.getArtifactId()));
    }
 else {
      library.addDep(buckThirdPartyRelativePath,artifact);
    }
  }
  Iterable<Artifact> outgoing=graph.getOutgoingNodesFor(artifactToDownload);
  for (  Artifact artifact : outgoing) {
    String groupName=getProjectName(artifact);
    if (!groupName.equals(projectName)) {
      library.addVisibility(buckThirdPartyRelativePath,artifact);
    }
  }
  for (  String rule : extraVisibility) {
    library.addVisibility(rule);
  }
}

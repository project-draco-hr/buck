{
  BuildRuleResolver resolver=new BuildRuleResolver(TargetGraph.EMPTY,new DefaultTargetNodeToBuildRuleTransformer());
  ProjectFilesystem filesystem=new FakeProjectFilesystem();
  BuildRule fatBinaryRule=AppleBinaryBuilder.createBuilder(BuildTargetFactory.newInstance("//foo:xctest#iphoneos-i386,iphoneos-x86_64")).build(resolver,filesystem);
  assertThat(fatBinaryRule,instanceOf(FatBinary.class));
  ImmutableList<Step> steps=fatBinaryRule.getBuildSteps(FakeBuildContext.NOOP_CONTEXT,new FakeBuildableContext());
  assertThat(steps,hasSize(2));
  Step step=Iterables.getLast(steps);
  ExecutionContext executionContext=TestExecutionContext.newInstance();
  assertThat(step,instanceOf(ShellStep.class));
  ImmutableList<String> command=((ShellStep)step).getShellCommand(executionContext);
  assertThat(command,Matchers.contains(endsWith("lipo"),equalTo("-create"),equalTo("-output"),containsString("foo/xctest#"),containsString("/xctest#"),containsString("/xctest#")));
}

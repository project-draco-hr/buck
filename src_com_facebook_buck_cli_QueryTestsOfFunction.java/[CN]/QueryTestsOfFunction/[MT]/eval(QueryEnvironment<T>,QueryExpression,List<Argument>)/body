{
  if (!(env instanceof BuckQueryEnvironment)) {
    throw new QueryException("The environment should be an instance of BuckQueryEnvironment");
  }
  Set<T> targets=args.get(0).getExpression().eval(env);
  env.buildTransitiveClosure(expression,targets,Integer.MAX_VALUE);
  Set<T> tests=new LinkedHashSet<>();
  for (  T target : targets) {
    TargetNode<?> node=Preconditions.checkNotNull(((BuckQueryEnvironment)env).getNode((BuildTarget)target));
    tests.addAll((Collection<T>)TargetNodes.getTestTargetsForNode(node));
  }
  return tests;
}

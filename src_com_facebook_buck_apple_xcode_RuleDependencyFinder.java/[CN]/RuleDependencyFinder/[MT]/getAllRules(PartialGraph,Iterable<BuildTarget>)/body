{
  ImmutableList.Builder<BuildRule> initialRulesBuilder=ImmutableList.builder();
  for (  BuildTarget target : initialTargets) {
    initialRulesBuilder.add(graph.getActionGraph().findBuildRuleByTarget(target));
  }
  ImmutableSet<BuildRule> buildRules=gatherTransitiveDependencies(initialRulesBuilder.build());
  ImmutableMultimap<BuildRule,BuildRule> ruleToTestRules=buildRuleToTestRulesMap(graph);
  ImmutableSet.Builder<BuildRule> testRulesBuilder=ImmutableSet.builder();
  for (  BuildRule rule : buildRules) {
    testRulesBuilder.addAll(ruleToTestRules.get(rule));
  }
  ImmutableSet<BuildRule> additionalBuildRules=gatherTransitiveDependencies(testRulesBuilder.build());
  return ImmutableSet.<BuildRule>builder().addAll(buildRules).addAll(additionalBuildRules).build();
}

{
  Optional<HeaderVisibility> visibilityOptional=Optional.absent();
  ImmutableList<String> headerFlags=sourceFlags.get(headerPath);
  if (headerFlags != null) {
    visibilityOptional=HeaderVisibility.fromFlags(headerFlags);
  }
  HeaderVisibility visibility=visibilityOptional.or(HeaderVisibility.PROJECT);
  String fileName=sourcePathResolver.getPath(headerPath).getFileName().toString();
  String prefixedFileName=prefix.resolve(fileName).toString();
  Path value=projectFilesystem.getPathForRelativePath(sourcePathResolver.getPath(headerPath)).toAbsolutePath().normalize();
  addHeaderMapEntry(targetHeaderMap,"target",prefixedFileName,value);
  if (visibility == HeaderVisibility.PUBLIC) {
    addHeaderMapEntry(publicHeaderMap,"public",prefixedFileName,value);
  }
  addHeaderMapEntry(targetUserHeaderMap,"target-user",fileName,value);
  if (visibility == HeaderVisibility.PRIVATE) {
    throw new HumanReadableException("Xcode's so-called 'private' headers have been deprecated in the new header map mode. " + "Please declare '" + fileName + "' as public, "+ "or use the default visibility (i.e. by target) instead.");
  }
}

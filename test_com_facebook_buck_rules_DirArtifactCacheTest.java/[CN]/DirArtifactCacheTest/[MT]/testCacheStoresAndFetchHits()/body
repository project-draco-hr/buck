{
  File cacheDir=tmpDir.newFolder();
  File fileX=tmpDir.newFile("x");
  File fileY=tmpDir.newFile("y");
  File fileZ=tmpDir.newFile("z");
  fileHashCache=new FakeFileHashCache(ImmutableMap.of(fileX.toPath(),HashCode.fromInt(0),fileY.toPath(),HashCode.fromInt(1),fileZ.toPath(),HashCode.fromInt(2)));
  dirArtifactCache=new DirArtifactCache("dir",cacheDir,true,Optional.of(0L));
  Files.write("x",fileX,Charsets.UTF_8);
  Files.write("y",fileY,Charsets.UTF_8);
  Files.write("z",fileZ,Charsets.UTF_8);
  BuildRule inputRuleX=new BuildRuleForTest(fileX);
  BuildRule inputRuleY=new BuildRuleForTest(fileY);
  BuildRule inputRuleZ=new BuildRuleForTest(fileZ);
  assertFalse(inputRuleX.equals(inputRuleY));
  assertFalse(inputRuleX.equals(inputRuleZ));
  assertFalse(inputRuleY.equals(inputRuleZ));
  SourcePathResolver resolver=new SourcePathResolver(new BuildRuleResolver(ImmutableSet.of(inputRuleX,inputRuleY,inputRuleZ)));
  DefaultRuleKeyBuilderFactory fakeRuleKeyBuilderFactory=new DefaultRuleKeyBuilderFactory(fileHashCache,resolver);
  RuleKey ruleKeyX=fakeRuleKeyBuilderFactory.newInstance(inputRuleX).build();
  RuleKey ruleKeyY=fakeRuleKeyBuilderFactory.newInstance(inputRuleY).build();
  RuleKey ruleKeyZ=fakeRuleKeyBuilderFactory.newInstance(inputRuleZ).build();
  assertEquals(CacheResult.Type.MISS,dirArtifactCache.fetch(ruleKeyX,fileX).getType());
  assertEquals(CacheResult.Type.MISS,dirArtifactCache.fetch(ruleKeyY,fileY).getType());
  assertEquals(CacheResult.Type.MISS,dirArtifactCache.fetch(ruleKeyZ,fileZ).getType());
  dirArtifactCache.store(ImmutableSet.of(ruleKeyX),ImmutableMap.<String,String>of(),fileX);
  dirArtifactCache.store(ImmutableSet.of(ruleKeyY),ImmutableMap.<String,String>of(),fileY);
  dirArtifactCache.store(ImmutableSet.of(ruleKeyZ),ImmutableMap.<String,String>of(),fileZ);
  assertTrue(fileX.delete());
  assertTrue(fileY.delete());
  assertTrue(fileZ.delete());
  assertEquals(CacheResult.Type.HIT,dirArtifactCache.fetch(ruleKeyX,fileX).getType());
  assertEquals(CacheResult.Type.HIT,dirArtifactCache.fetch(ruleKeyY,fileY).getType());
  assertEquals(CacheResult.Type.HIT,dirArtifactCache.fetch(ruleKeyZ,fileZ).getType());
  assertEquals(inputRuleX,new BuildRuleForTest(fileX));
  assertEquals(inputRuleY,new BuildRuleForTest(fileY));
  assertEquals(inputRuleZ,new BuildRuleForTest(fileZ));
  assertEquals(3,cacheDir.listFiles().length);
  dirArtifactCache.deleteOldFiles();
  assertEquals(0,cacheDir.listFiles().length);
}

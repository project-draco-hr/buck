{
  while (!toExplore.isEmpty()) {
    BuildRule currentRule=toExplore.remove();
    if (explored.contains(currentRule)) {
      continue;
    }
    ImmutableSet<BuildRule> depsToVisit=visit(currentRule);
    explored.add(currentRule);
    for (    BuildRule dep : depsToVisit) {
      Preconditions.checkState(currentRule.getDeps().contains(dep),"%s said that it should visit %s, but %s is not in its deps.",currentRule,dep,dep);
      if (!explored.contains(dep)) {
        toExplore.add(dep);
      }
    }
  }
  onComplete();
}

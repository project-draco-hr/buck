{
  ListenableFuture<RuleKey> ruleKey=ruleKeys.get(rule.getBuildTarget());
  if (ruleKey == null) {
    ListenableFuture<List<RuleKey>> depKeys=Futures.transformAsync(ruleDeps.get(rule),new AsyncFunction<ImmutableSortedSet<BuildRule>,List<RuleKey>>(){
      @Override public ListenableFuture<List<RuleKey>> apply(      @Nonnull ImmutableSortedSet<BuildRule> deps){
        List<ListenableFuture<RuleKey>> depKeys=Lists.newArrayListWithExpectedSize(rule.getDeps().size());
        for (        BuildRule dep : deps) {
          depKeys.add(calculateRuleKey(dep,context));
        }
        return Futures.allAsList(depKeys);
      }
    }
);
    final RuleKeyFactories keyFactories=ruleKeyFactories.getUnchecked(rule.getProjectFilesystem());
    ruleKey=Futures.transform(depKeys,new Function<List<RuleKey>,RuleKey>(){
      @Override public RuleKey apply(      List<RuleKey> input){
        context.getEventBus().logVerboseAndPost(LOG,BuildRuleEvent.started(rule));
        try {
          return keyFactories.defaultRuleKeyBuilderFactory.build(rule);
        }
  finally {
          context.getEventBus().logVerboseAndPost(LOG,BuildRuleEvent.suspended(rule,keyFactories.defaultRuleKeyBuilderFactory));
        }
      }
    }
,service);
    ruleKeys.put(rule.getBuildTarget(),ruleKey);
  }
  return ruleKey;
}

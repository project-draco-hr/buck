{
  ConcurrentMap<BuildRule,Integer> seen=Maps.newConcurrentMap();
  ListenableFuture<Void> result=Futures.immediateFuture(null);
  for (  BuildRule rule : rules) {
    result=MoreFutures.chainExceptions(walkRule(rule,seen),result);
  }
  Futures.getUnchecked(result);
  return seen.size();
}

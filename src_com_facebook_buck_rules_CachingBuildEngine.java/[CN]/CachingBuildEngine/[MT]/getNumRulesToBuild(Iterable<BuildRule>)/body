{
  Set<BuildRule> seen=Sets.newConcurrentHashSet();
  ListenableFuture<Void> result=Futures.immediateFuture(null);
  for (  BuildRule rule : rules) {
    if (seen.add(rule)) {
      result=MoreFutures.chainExceptions(walkRule(rule,seen),result);
    }
  }
  Futures.getUnchecked(result);
  return seen.size();
}

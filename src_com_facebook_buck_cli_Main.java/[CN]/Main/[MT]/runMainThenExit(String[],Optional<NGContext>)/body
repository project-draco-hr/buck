{
  Path projectRoot=Paths.get(".");
  int exitCode=FAIL_EXIT_CODE;
  BuildId buildId=getBuildId(context);
  CommandThreadAssociation commandThreadAssociation=null;
  ConsoleHandlerRedirector consoleHandlerRedirector=null;
  ImmutableMap<String,String> clientEnvironment=getClientEnvironment(context);
  try {
    commandThreadAssociation=new CommandThreadAssociation(buildId.toString());
    consoleHandlerRedirector=new ConsoleHandlerRedirector(buildId.toString(),stdErr,Optional.<OutputStream>absent());
    exitCode=tryRunMainWithExitCode(buildId,projectRoot,context,clientEnvironment,args);
  }
 catch (  Throwable t) {
    LOG.error(t,"Uncaught exception at top level");
  }
 finally {
    LogConfig.flushLogs();
    if (commandThreadAssociation != null) {
      commandThreadAssociation.stop();
    }
    if (consoleHandlerRedirector != null) {
      consoleHandlerRedirector.close();
    }
    System.exit(exitCode);
  }
}

{
  ImmutableMap<String,String> clientEnvironment=getClientEnvironment(context);
  ProjectFilesystem projectFilesystem=new ProjectFilesystem(Paths.get(projectRoot.getPath()),createBuckConfig(new ProjectFilesystem(projectRoot),platform,clientEnvironment).getIgnorePaths());
  BuckConfig config=createBuckConfig(projectFilesystem,platform,clientEnvironment);
  Verbosity verbosity=VerbosityParser.parse(args);
  Optional<String> color;
  final boolean isDaemon=context.isPresent();
  if (isDaemon && (context.get().getEnv() != null)) {
    String colorString=context.get().getEnv().getProperty(BUCKD_COLOR_DEFAULT_ENV_VAR);
    color=Optional.fromNullable(colorString);
  }
 else {
    color=Optional.absent();
  }
  final Console console=new Console(verbosity,stdOut,stdErr,config.createAnsi(color));
  if (commandParseResult.getErrorText().isPresent()) {
    console.getStdErr().println(commandParseResult.getErrorText().get());
  }
  ProcessExecutor processExecutor=new ProcessExecutor(console);
  int exitCode;
  ImmutableList<BuckEventListener> eventListeners;
  Clock clock=new DefaultClock();
  ExecutionEnvironment executionEnvironment=new DefaultExecutionEnvironment(processExecutor,clientEnvironment);
  PropertyFinder propertyFinder=new DefaultPropertyFinder(projectFilesystem,clientEnvironment);
  AndroidDirectoryResolver androidDirectoryResolver=new DefaultAndroidDirectoryResolver(projectFilesystem,config.getNdkVersion(),propertyFinder);
  JavaBuckConfig javaConfig=new JavaBuckConfig(config);
  JavaCompilerEnvironment javacEnv=javaConfig.getJavaCompilerEnvironment(processExecutor);
  KnownBuildRuleTypes buildRuleTypes=KnownBuildRuleTypes.createInstance(config,androidDirectoryResolver,javacEnv);
  if (!commandSemaphore.tryAcquire()) {
    return BUSY_EXIT_CODE;
  }
  @Nullable ArtifactCacheFactory artifactCacheFactory=null;
  try (ConsoleLogLevelOverrider consoleLogLevelOverrider=new ConsoleLogLevelOverrider(verbosity);ConsoleHandlerRedirector consoleHandlerRedirector=new ConsoleHandlerRedirector(console.getStdErr(),stdErr);AbstractConsoleEventBusListener consoleListener=createConsoleEventListener(clock,console,verbosity,executionEnvironment,config);BuckEventBus buildEventBus=new BuckEventBus(clock,buildId)){
    artifactCacheFactory=new LoggingArtifactCacheFactory(executionEnvironment,buildEventBus);
    Optional<WebServer> webServer=getWebServerIfDaemon(context,projectFilesystem,config,buildRuleTypes,androidDirectoryResolver,clientEnvironment);
    eventListeners=addEventListeners(buildEventBus,projectFilesystem,config,webServer,console,consoleListener,buildRuleTypes,clientEnvironment);
    ImmutableList<String> remainingArgs=ImmutableList.copyOf(Arrays.copyOfRange(args,1,args.length));
    Command executingCommand=commandParseResult.getCommand().get();
    String commandName=executingCommand.name().toLowerCase();
    CommandEvent commandEvent=CommandEvent.started(commandName,remainingArgs,isDaemon);
    buildEventBus.post(commandEvent);
    Parser parser=null;
    if (isDaemon) {
      try {
        parser=getParserFromDaemon(context,projectFilesystem,config,buildRuleTypes,androidDirectoryResolver,clientEnvironment,commandEvent,buildEventBus);
      }
 catch (      WatchmanWatcherException|IOException e) {
        buildEventBus.post(ConsoleEvent.warning("Watchman threw an exception while parsing file changes.\n%s",e.getMessage()));
      }
    }
    Repository repository=new Repository("default",projectFilesystem,buildRuleTypes,config);
    if (parser == null) {
      parser=new Parser(repository,clientEnvironment,config.getPythonInterpreter(),config.getTempFilePatterns(),createRuleKeyBuilderFactory(new DefaultFileHashCache(projectFilesystem)));
    }
    JavaUtilsLoggingBuildListener.ensureLogFileIsWritten(projectFilesystem);
    CachingBuildEngine buildEngine=new CachingBuildEngine();
    exitCode=executingCommand.execute(remainingArgs,config,new CommandRunnerParams(console,repository,androidDirectoryResolver,buildEngine,artifactCacheFactory,buildEventBus,parser,platform,clientEnvironment,config.createDefaultJavaPackageFinder()));
    if (webServer.isPresent()) {
      int port=webServer.get().getPort();
      buildEventBus.post(ConsoleEvent.info("See trace at http://localhost:%s/trace/%s",port,buildId));
    }
    buildEventBus.post(CommandEvent.finished(commandName,remainingArgs,isDaemon,exitCode));
  }
 catch (  Throwable t) {
    LOG.debug(t,"Failing build on exception.");
    closeCreatedArtifactCaches(artifactCacheFactory);
    throw t;
  }
 finally {
    commandSemaphore.release();
  }
  if (isDaemon && !config.getFlushEventsBeforeExit()) {
    context.get().in.close();
    context.get().exit(exitCode);
  }
  closeCreatedArtifactCaches(artifactCacheFactory);
  for (  BuckEventListener eventListener : eventListeners) {
    try {
      eventListener.outputTrace(buildId);
    }
 catch (    RuntimeException e) {
      System.err.println("Skipping over non-fatal error");
      e.printStackTrace();
    }
  }
  return exitCode;
}

{
  if (args.length == 0) {
    return usage();
  }
  ProjectFilesystem projectFilesystem=new ProjectFilesystem(projectRoot,createBuckConfig(new ProjectFilesystem(projectRoot),platform).getIgnorePaths());
  BuckConfig config=createBuckConfig(projectFilesystem,platform);
  Verbosity verbosity=VerbosityParser.parse(args);
  Optional<String> color;
  final boolean isDaemon=context.isPresent();
  if (isDaemon && (context.get().getEnv() != null)) {
    String colorString=context.get().getEnv().getProperty(BUCKD_COLOR_DEFAULT_ENV_VAR);
    color=Optional.fromNullable(colorString);
  }
 else {
    color=Optional.absent();
  }
  final Console console=new Console(verbosity,stdOut,stdErr,config.createAnsi(color));
  Optional<Command> command=Command.getCommandForName(args[0],console);
  if (!command.isPresent()) {
    int exitCode=new GenericBuckOptions(stdOut,stdErr).execute(args);
    if (exitCode == GenericBuckOptions.SHOW_MAIN_HELP_SCREEN_EXIT_CODE) {
      return usage();
    }
 else {
      return exitCode;
    }
  }
  Clock clock=new DefaultClock();
  String buildId=MoreStrings.createRandomString();
  ExecutionEnvironment executionEnvironment=new DefaultExecutionEnvironment();
  try (BuckEventBus buildEventBus=new BuckEventBus(clock,buildId);AbstractConsoleEventBusListener consoleListener=createConsoleEventListener(clock,console,executionEnvironment)){
    ImmutableList<BuckEventListener> eventListeners=addEventListeners(buildEventBus,projectFilesystem,config,getWebServerIfDaemon(context,projectFilesystem,config,console),consoleListener);
    List<String> remainingArgs=ImmutableList.copyOf(Arrays.copyOfRange(args,1,args.length));
    Command executingCommand=command.get();
    String commandName=executingCommand.name().toLowerCase();
    CommandEvent commandEvent=CommandEvent.started(commandName,isDaemon);
    buildEventBus.post(commandEvent);
    ArtifactCacheFactory artifactCacheFactory=new LoggingArtifactCacheFactory(buildEventBus);
    Parser parser;
    if (isDaemon) {
      Daemon daemon=getDaemon(projectFilesystem,config,console);
      daemon.watchClient(context.get());
      daemon.watchFileSystem(console,commandEvent);
      daemon.initWebServer();
      parser=daemon.getParser();
    }
 else {
      JavaUtilsLoggingBuildListener.ensureLogFileIsWritten();
      parser=new Parser(projectFilesystem,new KnownBuildRuleTypes(),console,config.getPythonInterpreter(),config.getTempFilePatterns(),createRuleKeyBuilderFactory(new DefaultFileHashCache(projectFilesystem,console)));
    }
    int exitCode=executingCommand.execute(remainingArgs,config,new CommandRunnerParams(console,projectFilesystem,new KnownBuildRuleTypes(),artifactCacheFactory,buildEventBus,parser,platform));
    buildEventBus.post(CommandEvent.finished(commandName,isDaemon,exitCode));
    for (    BuckEventListener eventListener : eventListeners) {
      eventListener.outputTrace(buildId);
    }
    artifactCacheFactory.closeCreatedArtifactCaches(ARTIFACT_CACHE_TIMEOUT_IN_SECONDS);
    if (isDaemon && daemon.webServer.isPresent()) {
      int port=daemon.webServer.get().getPort();
      buildEventBus.post(LogEvent.info("See trace at http://localhost:%s/trace/%s",port,buildId));
      try {
        Thread.sleep(DELAY_BEFORE_SHUTDOWN.getTimeSpanInMillis());
      }
 catch (      InterruptedException e) {
        e.printStackTrace(console.getStdErr());
      }
    }
    return exitCode;
  }
 }

{
  workspace=TestDataHelper.createProjectWorkspaceForScenario(this,"rulekey_changed_while_abi_stable",tmp);
  workspace.setUp();
  ProcessResult buildResult=workspace.runBuckCommand("build","//:biz");
  buildResult.assertSuccess("Successful build should exit with 0.");
  String utilRuleKey=getContents("buck-out/bin/.util/metadata/RULE_KEY");
  String utilRuleKeyNoDeps=getContents("buck-out/bin/.util/metadata/RULE_KEY_NO_DEPS");
  String utilAbi=getContents("buck-out/bin/.util/metadata/ABI_KEY");
  String utilAbiForDeps=getContents("buck-out/bin/.util/metadata/ABI_KEY_FOR_DEPS");
  String bizRuleKey=getContents("buck-out/bin/.biz/metadata/RULE_KEY");
  String bizRuleKeyNoDeps=getContents("buck-out/bin/.biz/metadata/RULE_KEY_NO_DEPS");
  String bizAbi=getContents("buck-out/bin/.biz/metadata/ABI_KEY");
  String bizAbiForDeps=getContents("buck-out/bin/.biz/metadata/ABI_KEY_FOR_DEPS");
  long utilJarSize=workspace.getFile("buck-out/gen/lib__util__output/util.jar").length();
  long bizJarLastModified=workspace.getFile("buck-out/gen/lib__biz__output/biz.jar").lastModified();
  String originalUtilJava=getContents("Util.java");
  String replacementContents=originalUtilJava.replace("Hello World","Hola Mundo");
  Files.write(replacementContents,workspace.getFile("Util.java"),Charsets.UTF_8);
  ProcessResult buildResult2=workspace.runBuckCommand("build","//:biz");
  buildResult2.assertSuccess("Successful build should exit with 0.");
  assertThat(utilRuleKey,not(equalTo(getContents("buck-out/bin/.util/metadata/RULE_KEY"))));
  assertThat(utilRuleKeyNoDeps,not(equalTo(getContents("buck-out/bin/.util/metadata/RULE_KEY_NO_DEPS"))));
  assertEquals(utilAbi,getContents("buck-out/bin/.util/metadata/ABI_KEY"));
  assertEquals(utilAbiForDeps,getContents("buck-out/bin/.util/metadata/ABI_KEY_FOR_DEPS"));
  assertThat(bizRuleKey,not(equalTo(getContents("buck-out/bin/.biz/metadata/RULE_KEY"))));
  assertEquals(bizRuleKeyNoDeps,getContents("buck-out/bin/.biz/metadata/RULE_KEY_NO_DEPS"));
  assertEquals(bizAbi,getContents("buck-out/bin/.biz/metadata/ABI_KEY"));
  assertEquals(bizAbiForDeps,getContents("buck-out/bin/.biz/metadata/ABI_KEY_FOR_DEPS"));
  assertThat("util.jar should have been rewritten, so its file size should have changed.",utilJarSize,not(equalTo(workspace.getFile("buck-out/gen/lib__util__output/util.jar").length())));
  assertEquals("biz.jar should not have been rewritten, so its last-modified time should be the same.",bizJarLastModified,workspace.getFile("buck-out/gen/lib__biz__output/biz.jar").lastModified());
  ProcessResult buildResult3=workspace.runBuckCommand("build","//:biz");
  buildResult3.assertSuccess("Successful build should exit with 0.");
}

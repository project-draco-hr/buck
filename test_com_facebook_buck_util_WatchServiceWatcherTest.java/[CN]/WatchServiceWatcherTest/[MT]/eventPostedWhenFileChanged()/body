{
  expect(watchService.poll()).andReturn(key).andReturn(null);
  expect(filesystem.isPathChangeEvent(anyObject(WatchEvent.class))).andReturn(true).anyTimes();
  expect(filesystem.getRootPath()).andReturn(path).anyTimes();
  expect(key.pollEvents()).andReturn(Lists.<WatchEvent<?>>newArrayList(createPathEvent(Paths.get("./someproject/SomeClass.java"),StandardWatchEventKinds.ENTRY_MODIFY)));
  expect(path.relativize(anyObject(Path.class))).andReturn(Paths.get("SomeClass.java"));
  eventBus.post(anyObject(WatchEvent.class));
  expectLastCall().andDelegateTo(new EventBus(){
    @Override @SuppressWarnings("unchecked") public void post(    Object obj){
      WatchEvent<Path> event=(WatchEvent<Path>)obj;
      assertEquals("Posted events should have path relative to project root.",event.context().toString(),"SomeClass.java");
    }
  }
);
  replay(filesystem,eventBus,watchService,path,key);
  watcher=new WatchServiceWatcher(filesystem,eventBus,watchService);
  visitor.getValue().preVisitDirectory(path,null);
  watcher.postEvents();
  verify(filesystem,eventBus,watchService,path,key);
}

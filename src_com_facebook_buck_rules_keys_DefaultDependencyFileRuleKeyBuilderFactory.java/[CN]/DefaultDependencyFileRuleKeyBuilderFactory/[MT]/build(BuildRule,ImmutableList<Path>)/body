{
  Builder builder=newInstance(rule);
  ImmutableSet<Path> inputSet=ImmutableSet.copyOf(inputs);
  ImmutableMultimap.Builder<Path,SourcePath> relativePathToSourcePathsBuilder=ImmutableMultimap.builder();
  for (  SourcePath input : builder.getInputsSoFar()) {
    Path relativePath=pathResolver.getRelativePath(input);
    if (inputSet.contains(relativePath)) {
      relativePathToSourcePathsBuilder.put(relativePath,input);
    }
  }
  final ImmutableMultimap<Path,SourcePath> relativePathToSourcePaths=relativePathToSourcePathsBuilder.build();
  for (  Path input : inputs) {
    ImmutableCollection<SourcePath> sourcePaths=relativePathToSourcePaths.get(input);
    if (sourcePaths.isEmpty()) {
      throw new NoSuchFileException(String.format("%s: could not find any inputs matching the relative path `%s`",rule.getBuildTarget(),input));
    }
    for (    SourcePath sourcePath : sourcePaths) {
      builder.setPath(pathResolver.getAbsolutePath(sourcePath),pathResolver.getRelativePath(sourcePath));
    }
  }
  return builder.build();
}

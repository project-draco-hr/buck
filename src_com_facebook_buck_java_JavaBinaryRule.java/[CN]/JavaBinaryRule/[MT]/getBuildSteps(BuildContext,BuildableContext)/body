{
  ImmutableList.Builder<Step> commands=ImmutableList.builder();
  Path outputDirectory=getOutputDirectory();
  Step mkdir=new MkdirStep(outputDirectory);
  commands.add(mkdir);
  ImmutableSet<Path> includePaths;
  if (metaInfDirectory != null) {
    Path stagingRoot=outputDirectory.resolve("meta_inf_staging");
    Path stagingTarget=stagingRoot.resolve("META-INF");
    MakeCleanDirectoryStep createStagingRoot=new MakeCleanDirectoryStep(stagingRoot);
    commands.add(createStagingRoot);
    MkdirAndSymlinkFileStep link=new MkdirAndSymlinkFileStep(metaInfDirectory,stagingTarget);
    commands.add(link);
    includePaths=ImmutableSet.<Path>builder().add(stagingRoot).addAll(Iterables.transform(getTransitiveClasspathEntries().values(),MorePaths.TO_PATH)).build();
  }
 else {
    includePaths=FluentIterable.from(getTransitiveClasspathEntries().values()).transform(MorePaths.TO_PATH).toSet();
  }
  Path outputFile=Paths.get(getOutputFile());
  Step jar=new JarDirectoryStep(outputFile,includePaths,mainClass,manifestFile);
  commands.add(jar);
  return commands.build();
}

{
  if (!(env instanceof BuckQueryEnvironment)) {
    throw new QueryException("The environment should be an instance of BuckQueryEnvironment");
  }
  Pattern compiledPattern;
  String pattern=args.get(0).getWord();
  try {
    compiledPattern=Pattern.compile(pattern);
  }
 catch (  IllegalArgumentException e) {
    throw new QueryException(expression,String.format("Illegal pattern regexp '%s': %s",pattern,e.getMessage()));
  }
  BuckQueryEnvironment buckEnv=(BuckQueryEnvironment)env;
  QueryExpression argument=args.get(args.size() - 1).getExpression();
  Set<T> result=new LinkedHashSet<>();
  for (  T target : argument.eval(env)) {
    if (compiledPattern.matcher(buckEnv.getTargetKind((BuildTarget)target)).find()) {
      result.add(target);
    }
  }
  return result;
}
